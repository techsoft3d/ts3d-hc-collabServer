var hcCollab;(()=>{"use strict";var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{TextBoxMarkupItem:()=>r,TextBoxMarkupOperator:()=>l,TextBoxMarkupTypeManager:()=>n,connect:()=>Je,disconnect:()=>Y,getActive:()=>X,getLocalUser:()=>K,getLockedClient:()=>Z,getLockedMaster:()=>Q,getRoomData:()=>se,getShowCameraWidgets:()=>G,getSuspendSend:()=>ne,getSyncCamera:()=>L,getSyncSelection:()=>U,handleResize:()=>W,initialize:()=>We,lockSession:()=>ee,sendCustomMessage:()=>re,setMessageReceivedCallback:()=>le,setShowCameraWidgets:()=>q,setSuspendSend:()=>oe,setSyncCamera:()=>j,setSyncSelection:()=>J,submitChat:()=>ie,unlockSession:()=>te,updateRoomData:()=>ae});class i{constructor(e,t=new Communicator.Color(255,0,0),i=new Communicator.Color(255,0,0),a=.1,s=!0,o=!1,n){this._manager=e,this._node=null,this._currentCamera=null,this._lineColor=t,this._faceColor=i,this._faceOpacity=a,this._renderFaces=s,this._suppressScale=o,this._fixedLength=n}async update(e,t=this._manager._viewer.view.getCanvasSize()){if(!this._node){let e=new Communicator.MeshInstanceData(this._manager._frustumMesh),t=new Communicator.MeshInstanceData(this._manager._frustumMeshLines);if(this._node=this._manager._viewer.model.createNode(this._manager.node),this._renderFaces){let t=await this._manager._viewer.model.createMeshInstance(e,this._node,!0);await this._manager._viewer.model.setNodesOpacity([t],this._faceOpacity),await this._manager._viewer.model.setNodesFaceColor([t],this._faceColor)}let i=await this._manager._viewer.model.createMeshInstance(t,this._node,!0);await this._manager._viewer.model.setNodesLineColor([i],this._lineColor),await this._manager._viewer.model.setNodesLinePattern([i],[1,0],.05,Communicator.LinePatternLengthUnit.Object),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotSelect,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.ExcludeBounding,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotCut,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotExplode,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[this._node],!0),this._suppressScale&&this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[this._node],!0)}let i,a,s,o,n,r=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).normalize(),l=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).length(),d=new Communicator.Matrix,c=e.getPosition(),h=new Communicator.Matrix;if(this._suppressScale)null==this._fixedLength&&(i=.2),a=i/2,s=i/2,l=i;else if(a=e.getWidth(),s=e.getHeight(),this._fixedLength){let e=l/this._fixedLength;a/=e,s/=e,l=this._fixedLength}let m=t.x/t.y;m>=1?(o=a*m,n=s):(o=a,n=s/m),h.setTranslationComponent(c.x,c.y,c.z),d.setScaleComponent(o,n,l);let u=this.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(0,0,1),r),p=u.transform(new Communicator.Point3(0,1,0)),_=this.ComputeVectorToVectorRotationMatrix(p,e.getUp()),g=Communicator.Matrix.multiply(d,u),w=Communicator.Matrix.multiply(g,_),f=Communicator.Matrix.multiply(w,h);await this._manager._viewer.model.setNodeMatrix(this._node,f),this._currentCamera=e.copy(),this._currentCanvasSize=t}async flush(){this._manager._viewer.model.deleteNode(this._node),this._node=null}getCamera(){return this._currentCamera}ComputeVectorToVectorRotationMatrix(e,t){const i=1e-7;e.normalize(),t.normalize();let a=Communicator.Point3.cross(e,t),s=Communicator.Point3.dot(e,t),o=a.length();if(o>-1e-7&&o<i){if(!(s<0))return new Communicator.Matrix;if(e.x<-1e-7||e.x>i)a.x=e.y,a.y=-e.x,a.z=0;else if(e.y<-1e-7||e.y>i)a.x=-e.y,a.y=e.x,a.z=0;else{if(!(e.z<-1e-7||e.z>i))return new Communicator.Matrix;a.x=-e.z,a.z=e.x,a.y=0}}var n=Math.atan2(o,s);return n*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(a,n)}}class a{constructor(e){this._viewer=e,this._widgets=[],this._node=null}async initialize(){this._node=this._viewer.model.createNode(),await this._createFrustumMesh()}deactivate(){this._node=null}isActive(){return null!=this._node}async _createFrustumMesh(e){let t=[0,0,0,-.5,-.5,1,.5,-.5,1,0,0,0,.5,-.5,1,.5,.5,1,0,0,0,-.5,.5,1,.5,.5,1,0,0,0,-.5,.5,1,-.5,-.5,1],i=[];for(let e=0;e<4;e++){let a=Communicator.Plane.createFromPoints(new Communicator.Point3(t[9*e],t[9*e+1],t[9*e+2]),new Communicator.Point3(t[9*e+3],t[9*e+4],t[9*e+5]),new Communicator.Point3(t[9*e+6],t[9*e+7],t[9*e+8]));for(let e=0;e<3;e++)i.push(-a.normal.x),i.push(-a.normal.y),i.push(-a.normal.z)}var a=new Communicator.MeshData;a.setFaceWinding(Communicator.FaceWinding.Unknown),a.addFaces(t,i),this._frustumMesh=await this._viewer.model.createMesh(a);let s=[[0,0,0,-.5,-.5,1,.5,-.5,1],[0,0,0,.5,-.5,1,.5,.5,1],[0,0,0,-.5,.5,1,.5,.5,1],[0,0,0,-.5,.5,1,-.5,-.5,1],[0,0,0,.5,.5,1]];var o=new Communicator.MeshData;for(let e=0;e<s.length;e++)o.addPolyline(s[e]);this._frustumMeshLines=await this._viewer.model.createMesh(o)}add(e){this._widgets.push(e),e.update(this._viewer.view.getCamera())}}class s{constructor(e){this._viewer=e,this._meshHash=[],this._spriteNode=this._viewer.model.createNode(this._viewer.model.getAbsoluteRootNode(),"sprites"),this._imageHash=[],this._sprites=[],this._alwaysInFront=!0,this._lastCamPosition=new Communicator.Point3(0,0,0),this._lastCheckDate=new Date,this._updateVisibilities(),this._nativeSpriteCounter=1111111111,this._nativeSpriteContainer="",this._wasDragged=!1,this._spriteClickedEvent=null;let t=this;this._viewer.setCallbacks({camera:function(e){t._updateDOMSprites(e)}})}setSpriteClickedEvent(e){this._spriteClickedEvent=e}_updateDOMSprite(e,t){let i,a,s=this._viewer.view.projectPoint(e.center,t);i=null==e.offsetdata.x?-e.offsetdata.width/2:e.offsetdata.x+e.offsetdata.width/2*(1-e.scale),a=null==e.offsetdata.y?-e.offsetdata.height/2:e.offsetdata.y+e.offsetdata.height/2*(1-e.scale),$("#"+e.nodeid).css({left:s.x+i+"px",top:s.y+a+"px",position:"absolute"})}_updateDOMSprites(e){for(let t in this._sprites)if(this._sprites[t].isNative){let i=this._sprites[t];this._updateDOMSprite(i,e)}}setNativeSpriteContainer(e){this._nativeSpriteContainer=e;let t=this;$("#"+this._nativeSpriteContainer).mousemove((function(e){if(1==e.which&&(t._wasDragged=!0,t._movedSprite&&t._movedSprite.allowDrag)){let i=new Communicator.Point2(t._startDown.x+(e.offsetX-t._startDown.x),t._startDown.y+(e.offsetY-t._startDown.y)),a=t._viewer.view.getCamera(),s=a.getPosition(),o=a.getTarget(),n=Communicator.Point3.subtract(o,s).normalize(),r=Communicator.Plane.createFromPointAndNormal(t._movedSprite.center,n),l=new Communicator.Point3,d=t._viewer.view.raycastFromPoint(new Communicator.Point2(i.x,i.y)),c=null;c=r.intersectsRay(d,l),c&&(t._movedSprite.center.x=l.x,t._movedSprite.center.y=l.y,t._movedSprite.center.z=l.z),t._updateDOMSprite(t._movedSprite,t._viewer.view.getCamera())}})),$(window).mouseup((function(e){if(1==e.which&&($("#"+t._nativeSpriteContainer).css("pointer-events","none"),t._movedSprite)){!t._wasDragged&&t._spriteClickedEvent&&t._spriteClickedEvent(t._movedSprite),$("#"+t._movedSprite.nodeid).css("box-shadow",""),t._movedSprite=null;for(let e in t._sprites)t._sprites[e].isNative&&$("#"+e).css("pointer-events","all")}}))}_getImage(e){return new Promise(((t,i)=>{var a=new Image;a.crossOrigin="anonymous",a.addEventListener("load",(function(){t({img:a,dims:new Communicator.Point2(this.naturalWidth,this.naturalHeight)})})),a.src=e}))}_getDataUrl(e){const t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),t.toDataURL("image/png")}async _updateDynamicImage(e){let t=$("#"+e).find("canvas")[0];return t||(t=await html2canvas(document.querySelector("#"+e),{onclone:function(t){t.querySelector("#"+e).style.display="block"}})),{durl:t.toDataURL("image/png"),dims:{x:t.width,y:t.height}}}_convertDataURIToBinary(e){var t=e.indexOf(";base64,")+8,i=window.atob(e.substring(t));return Uint8Array.from(Array.prototype.map.call(i,(function(e){return e.charCodeAt(0)})))}async addImage(e,t,i,a){var s;s=null==t?e:t;var o=await this._getImage(s),n=this._convertDataURIToBinary(this._getDataUrl(o.img)),r={format:Communicator.ImageFormat.Png,data:n};let l="none";l=null!=i||null!=a?i+"@"+a:"none",null==i&&(i=0),null==a&&(a=0);var d=this._meshHash[l];null==d&&(d=await this._createSpriteMesh(-i/o.dims.x,-a/o.dims.y),this._meshHash[l]=d);var c=await this._viewer.model.createImage(r);this._imageHash[e]={id:c,mesh:d,dims:{width:o.dims.x,height:o.dims.y},offsetx:i,offsety:a}}async updateDynamicSprites(e){let t=this._imageHash[e],i=t.id,a=await this._updateDynamicImage(e),s=this._convertDataURIToBinary(a.durl);var o={format:Communicator.ImageFormat.Png,data:s};let n=await this._viewer.model.createImage(o),r=[];for(let t in this._sprites)if(this._sprites[t].type==e){let e=this._viewer.model.getNodeChildren(parseInt(t));0==this._sprites[t].flip?(r.push(e[1]),this._sprites[t].flip=1,setTimeout((()=>{this._viewer.model.setNodesVisibility([e[0]],!1),this._viewer.model.setNodesVisibility([e[1]],!0)}),100)):(r.push(e[0]),this._sprites[t].flip=0,setTimeout((()=>{this._viewer.model.setNodesVisibility([e[1]],!1),this._viewer.model.setNodesVisibility([e[0]],!0)}),100))}await this._viewer.model.setNodesTexture(r,{imageId:n}),await this._viewer.model.deleteImages([i]),t.id=n}async _addDOMImage(e,t){if(this._imageHash[e])t.width=this._imageHash[e].dims.width,t.height=this._imageHash[e].dims.height;else{let i=await this._getImage(e);t.width=i.dims.x,t.height=i.dims.y,this._imageHash[e]={id:null,mesh:null,dims:t}}let i="image-"+this._nativeSpriteCounter++,a='<div id="'+i+'" style="position:absolute"><img src="'+e+'"></div>';return $("#"+this._nativeSpriteContainer).append(a),$("#"+i).css("display","block"),$("#"+i).css("z-index","20000"),$("#"+i).css("pointer-events","all"),i}_addDOMDiv(e,t,i,a){let s=e+"-clone-"+this._nativeSpriteCounter++,o='<div id="'+s+'"></div>';$("#"+this._nativeSpriteContainer).append(o);let n=$("#"+s);if(n.css("display","block"),n.css("z-index","20000"),n.css("pointer-events","all"),n.css("width",i+"px"),n.css("height",a+"px"),t)return $("#"+e).appendTo(n),s;let r=$("#"+e).clone();r.removeAttr("id");let l=$("#"+e).find("canvas")[0];return l&&r.find("canvas")[0].getContext("2d").drawImage(l,0,0),n.append(r),s}async _addDynamicImage(e,t,i){let a=await this._updateDynamicImage(e),s=this._convertDataURIToBinary(a.durl);var o={format:Communicator.ImageFormat.Png,data:s},n="none";null==t&&null==i||(null==t&&(t=0),null==i&&(i=0),n=t+"@"+i);var r=this._meshHash[n];null==r&&(r=await this._createSpriteMesh(t,i),this._meshHash[n]=r);var l=await this._viewer.model.createImage(o);this._imageHash[e]={id:l,mesh:r,dims:{width:a.dims.x,height:a.dims.y}}}async _createSpriteMesh(e,t){var i=new Communicator.MeshData;i.setFaceWinding(Communicator.FaceWinding.Clockwise);var a=0,s=0;return null!=e&&(a=e),null!=t&&(s=t),i.addFaces([-1+a,-1+s,0,-1+a,1+s,0,1+a,1+s,0,-1+a,-1+s,0,1+a,1+s,0,1+a,-1+s,0],null,null,[0,0,0,1,1,1,0,0,1,1,1,0]),await this._viewer.model.createMesh(i)}async _setupInstance(e,t,i){let a=new Communicator.MeshInstanceData(e),s=await this._viewer.model.createMeshInstance(a,t);return this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.AlwaysDraw,[s],!0),i||this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.ScreenOriented,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotCut,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotXRay,[s],!0),i||(this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[s],!0),this._viewer.model.setDepthRange([s],0,.1)),s}async _createSpriteInstance(e,t,i,a){let s;if(t){s=parseInt(t);let e=this._viewer.model.getNodeChildren(s);for(let t=0;t<e.length;t++)hwv.model.deleteNode(e[t])}else s=this._viewer.model.createNode(this._spriteNode);if(await this._setupInstance(e,s,i),a){let t=await this._setupInstance(e,s,i);this._viewer.model.setNodesVisibility([t],!1)}return s}async createDOMSprite(e,t,i=1,a=!1,s=!1,n=null,r=null,l,d){let c,h={};s?c=await this._addDOMImage(e,h):(h={},h.width=$("#"+e).width(),h.height=$("#"+e).height(),c=this._addDOMDiv(e,a,h.width,h.height));let m=this;return $("#"+c).mousedown((function(e){if(1==e.which){m._wasDragged=!1,$("#"+m._nativeSpriteContainer).css("pointer-events","auto"),m._movedSprite=m._sprites[c],m._startDown=new Communicator.Point2(e.offsetX,e.offsetY,0);let t=$("#"+c).position();m._initialPos=new Communicator.Point2(t.left,t.top),$("#"+m._movedSprite.nodeid).css("box-shadow","0 0 5px #ffff00, 0 0 10px #ffff00, 0 0 15px #ffff00, 0 0 20px #ffff00");for(let e in m._sprites)m._sprites[e].isNative&&$("#"+e).css("pointer-events","none")}})),null!=n&&$("#"+c).css("display","none"),this._imageHash[e]&&this._imageHash[e].offsetx?h.x=this._imageHash[e].offsetx:h.x=l,this._imageHash[e]&&this._imageHash[e].offsety?h.y=this._imageHash[e].offsety:h.x=d,i&&$("#"+c).css("transform","scale("+i+")"),this._sprites[c]=new o(this,c,t,i,e,n,r,a,!0,h),this._updateDOMSprites(this._viewer.view.getCamera()),this._sprites[c]}async createSprite(e,t,i=1,a=!1,s=null,n=null,r=!1,l=null,d,c){let h;if(a?null==this._imageHash[e]&&await this._addDynamicImage(e,d,c):null==this._imageHash[e]&&await this.addImage(e,void 0,d,c),h=await this._createSpriteInstance(this._imageHash[e].mesh,void 0,r,a),null!=s&&this._viewer.model.setNodesVisibility([h],!1),l)this._viewer.model.setNodeMatrix(h,l);else{var m=new Communicator.Matrix,u=new Communicator.Matrix;let a=i,s=i;var p=this._imageHash[e].dims.width/this._imageHash[e].dims.height;p>1&&(s=i,a=i*p),p<1&&(a=i*p,s=i),u.setScaleComponent(a,s,1),m.setTranslationComponent(t.x,t.y,t.z);var _=Communicator.Matrix.multiply(u,m);this._viewer.model.setNodeMatrix(h,_)}if(a){let t=this._viewer.model.getNodeChildren(h);await this._viewer.model.setNodesTexture([t[0]],{imageId:this._imageHash[e].id})}else await this._viewer.model.setNodesTexture([h],{imageId:this._imageHash[e].id});return this._sprites[h]=new o(this,h,t,i,e,s,n,a,!1),this._sprites[h].set3D(l),this._sprites[h]}flushAll(){for(let e in this._sprites)this._sprites[e].flush();this._sprites=[]}flush(e){this._sprites[e].flush(),delete this._sprites[e]}hideAll(){for(var e in this._sprites)this._sprites[e].hide()}showAll(){for(var e in this._sprites)this._sprites[e].show()}handleResize(){for(let e in this._sprites)this._sprites[e].redraw()}findFromNodeId(e){var t=this._sprites[e];if(null==t){var i=hwv.model.getNodeParent(e);t=this._sprites[i]}return t}getAlwaysInFront(){return this._alwaysInFront}setAlwaysInFront(e){this._alwaysInFront=e;for(let t in this._sprites)e||null!=this._sprites[t].range?this._viewer.model.setDepthRange([parseInt(t)],0,.1):this._viewer.model.unsetDepthRange([parseInt(t)])}_updateVisibilities(){var e=this;setInterval((function(){new Date;var t=e._viewer.view.getCamera().getPosition();e._lastCamPosition=t.copy(),e._lastCheckDate=new Date,e._lastCheckDate=void 0;for(let s in e._sprites){let o=e._sprites[s];if(null!=o.range&&!o.hidden){var i=Communicator.Point3.subtract(t,o.center).length(),a=parseInt(s);if(o.isNative)i<o.range?$("#"+s).css("display","block"):$("#"+s).css("display","none");else{let t=e._viewer.model.getNodeChildren(a);i<o.range?e._viewer.model.getNodeVisibility(t[e._sprites[s].flip])||e._viewer.model.setNodesVisibility([t[e._sprites[s].flip]],!0):e._viewer.model.getNodeVisibility(t[e._sprites[s].flip])&&e._viewer.model.setNodesVisibility([t[e._sprites[s].flip]],!1)}}}}),200)}}class o{constructor(e,t,i,a,s,o,n,r,l,d){this._manager=e,this.nodeid=t,this.range=o,this.center=i,this.scale=a,this.type=s,this.payload=n,this.dynamic=r,this.isNative=l,this.offsetdata=d,this.hidden=!1,this.flip=0,this.matrix=null,this.allowDrag=!1}set3D(e){this.matrix=e}getIs3D(){return null!=this.matrix}setAllowDrag(e){this.allowDrag=e}hide(){this._manager._viewer.model.setNodesVisibility([this.nodeid],!1)}flush(){this.isNative?$("#"+this.nodeid).remove():this.dynamic||this._manager._viewer.model.deleteNode(this.nodeid)}show(){this._manager._viewer.model.setNodesVisibility([this.nodeid],!0)}async setPosition(e){this.center=e.copy(),this.isNative&&await this._manager._updateDOMSprite(this,this._manager._viewer.view.getCamera())}async redraw(){this.isNative&&await this._manager._updateDOMSprite(this,this._manager._viewer.view.getCamera())}async setType(e,t){if(this.type!=e){if(this.type=e,this.isNative){let i={};i.width=this._manager._imageHash[e].dims.width,i.height=this._manager._imageHash[e].dims.height,this.offsetdata=i,null==t&&(t=this.scale);let a=$("#"+this.nodeid).children()[0],s=this;return $(a).bind("load",(function(){$("#"+s.nodeid).css("z-index","20000"),$("#"+s.nodeid).css("pointer-events","all"),$("#"+s.nodeid).css("transform","scale("+t+")"),s._manager._updateDOMSprite(s,s._manager._viewer.view.getCamera()),$("#"+s.nodeid).css("display","block")})),$("#"+this.nodeid).css("display","none"),void $(a).attr("src",e)}if(await this._manager._createSpriteInstance(this._manager._imageHash[e].mesh,this.nodeid,this.getIs3D(),this.dynamic),this._manager._sprites.matrix)this._manager._viewer.model.setNodeMatrix(this.nodeid,matrix);else if(t){let n=this._manager._sprites[this.nodeid].center;var i=new Communicator.Matrix,a=new Communicator.Matrix;let r=t,l=t;var s=this._manager._imageHash[e].dims.width/this._manager._imageHash[e].dims.height;s>1&&(l*=1/s),s<1&&(r*=s),a.setScaleComponent(r,l,1),i.setTranslationComponent(n.x,n.y,n.z);var o=Communicator.Matrix.multiply(a,i);this._manager._viewer.model.setNodeMatrix(this.nodeid,o)}await this._manager._viewer.model.setNodesTexture([this.nodeid],{imageId:this._manager._imageHash[e].id})}}}class n{constructor(e,t=!0){this._viewer=e,this._markups=[],this._useMarkupManager=t,this._markupUpdatedCallback=null;let i=this;this._useMarkupManager||this._viewer.setCallbacks({camera:function(){setTimeout((function(){i.refreshMarkup()}),0)}})}setMarkupUpdatedCallback(e){this._markupUpdatedCallback=e}getMarkupUpdatedCallback(){return this._markupUpdatedCallback}handleResize(){if(!this._useMarkupManager){let e=this;setTimeout((function(){e.refreshMarkup()}),0)}}setUseMarkupManager(e){this._useMarkupManager=e}getUseMarkupManager(){return this._useMarkupManager}add(e){if(this._markups.push(e),this._useMarkupManager){let t=this._viewer.markupManager.registerMarkup(e);e.setMarkupId(t)}}delete(e){for(let t=0;t<this._markups.length;t++)if(this._markups[t].getUniqueId()==e){this._viewer.markupManager.unregisterMarkup(this._markups[t].getMarkupId()),this._markups[t].destroy(),this._markups.splice(t,1);break}}getByID(e){for(let t=0;t<this._markups.length;t++)if(this._markups[t].getUniqueId()==e)return this._markups[t]}getSelected(){for(let e=0;e<this._markups.length;e++)if(this._markups[e].getSelected())return this._markups[e]}exportMarkup(){let e=[];for(let t=0;t<this._markups.length;t++)e.push(this._markups[t].toJson());return e}refreshMarkup(){if(this._useMarkupManager)this._viewer.markupManager.refreshMarkup();else for(let e=0;e<this._markups.length;e++)this._markups[e].draw()}pickMarkupItem(e){if(this._useMarkupManager)return this._viewer.markupManager.pickMarkupItem(e);for(let t=0;t<this._markups.length;t++)if(this._markups[t].hit(e))return this._markups[t];return null}loadData(e){for(let t=0;t<e.length;t++){let i=new r(this._viewer,Communicator.Point3.fromJson(e[t].firstPoint),Communicator.Point3.fromJson(e[t].secondPoint),Communicator.Point3.fromJson(e[t].secondPointRel),e[t].font,e[t].fontSize,Communicator.Color.fromJson(e[t].backgroundColor),Communicator.Color.fromJson(e[t].circleColor),e[t].circleRadius,e[t].maxWidth,e[t].pinned,e[t].extraDivText?decodeURIComponent(e[t].extraDivText):null);i.setText(decodeURIComponent(e[t].text)),i.setAllowEditing(!1),this.add(i),i.deselect()}this.refreshMarkup()}}class r extends Communicator.Markup.MarkupItem{static svgPointString(e){let t="";for(let i=0;i<e.length;i++)i&&(t+=" "),t+=e[i].x+","+e[i].y;return t}constructor(e,t,i=null,a=null,s="monospace",o="12px",n=new Communicator.Color(238,243,249),r=new Communicator.Color(128,128,255),l=4,d=300,c=!1,h=null){super(),this._textBoxMarkupTypeManager=e,this._viewer=e._viewer,this._font=s,this._fontSize=o,this._uniqueid=this._generateGUID(),this._backgroundColor=n,this._circleColor=r,this._circleRadius=l,this._firstPoint=t.copy(),this._allowEditing=!0,this._extraDivText=h,this._selected=!1,null!=i?this._secondPoint=i.copy():this.setSecondPoint(t.copy()),null!=a&&(this._secondPointRel=a.copy()),this._textHit=!0,this._maxWidth=d,this._pinned=c,this._lineGeometryShape=new Communicator.Markup.Shape.Polyline,this._circleGeometryShape=new Communicator.Markup.Shape.Circle,this._initialize()}getSelected(){return this._selected}setAllowEditing(e){this._allowEditing=e}getAllowEditing(){return this._allowEditing}destroy(){$(this._textBoxDiv).remove()}setText(e){$(this._textBoxText).val(e),this._adjustTextBox(),this._textBoxMarkupTypeManager.refreshMarkup()}setMarkupId(e){this._markupId=e}getMarkupId(){return this._markupId}getUniqueId(){return this._uniqueid}toJson(){return{id:this._uniqueid,font:this._font,fontSize:this._fontSize,backgroundColor:this._backgroundColor.toJson(),circleColor:this._circleColor.toJson(),circleRadius:this._circleRadius,firstPoint:this._firstPoint.toJson(),secondPoint:this._secondPoint.toJson(),secondPointRel:this._secondPointRel.toJson(),maxWidth:this._maxWidth,pinned:this._pinned,allowEditing:this._allowEditing,text:encodeURIComponent($(this._textBoxText).val()),extraDivText:encodeURIComponent($(_extraDivText).val())}}getExtraDiv(){return this._extraTextDiv}setPinned(e){this._pinned=e}getPinned(){return this._pinned}setBackgroundColor(e){this._backgroundColor=e,$(this._textBoxDiv).css("background-color","rgb("+e.r+","+e.g+","+e.b+")")}setCircleColor(e){this._circleColor=e,this._textBoxMarkupTypeManager.refreshMarkup()}draw(){$(this._svgElement).empty();const e=this._viewer.markupManager.getRenderer(),t=this._viewer.view;this._lineGeometryShape.clearPoints();let i=Communicator.Point2.fromPoint3(t.projectPoint(this._firstPoint));this._lineGeometryShape.pushPoint(i),this._circleGeometryShape.setCenter(i);let a,s=this._getDivDimensions();this._pinned?a=new Communicator.Point2(this._secondPointRel.x*s.width,this._secondPointRel.y*s.height):(a=Communicator.Point2.fromPoint3(t.projectPoint(this._secondPoint)),this._secondPointRel=new Communicator.Point2(a.x/s.width,a.y/s.height));let o=parseInt($(this._textBoxDiv).css("width")),n=parseInt($(this._textBoxDiv).css("height")),r=new Communicator.Point2(0,0);i.x<=a.x+o/2?r.x=a.x:r.x=a.x+o,i.y<=a.y+n/2?r.y=a.y:r.y=a.y+n,this._lineGeometryShape.pushPoint(r),this._textBoxMarkupTypeManager.getUseMarkupManager()?(e.drawPolyline(this._lineGeometryShape),e.drawCircle(this._circleGeometryShape)):(this._addPolylineElement(this._lineGeometryShape),this._addCircleElement(this._circleGeometryShape)),$(this._textBoxDiv).css("top",a.y+"px"),$(this._textBoxDiv).css("left",a.x+"px")}hit(e){let t=parseInt($(this._textBoxDiv).css("left")),i=parseInt($(this._textBoxDiv).css("top")),a=parseInt(t)+parseInt($(this._textBoxDiv).css("width")),s=parseInt(i)+parseInt($(this._textBoxDiv).css("height"));if(e.x>=t&&e.x<=a&&e.y>=i&&e.y<=s)return this._textHit=!0,!0;if(this._extraTextDiv){let a=$(this._extraTextDiv).position();t+=a.left,i+=a.top;let s=t+parseInt($(this._extraTextDiv).css("width")),o=i+parseInt($(this._extraTextDiv).css("height"));if(e.x>=t&&e.x<=s&&e.y>=i&&e.y<=o)return this.deselect(),this._textHit=!0,!0}let o=Communicator.Point2.fromPoint3(this._viewer.view.projectPoint(this._firstPoint));return t=o.x-7,i=o.y-7,a=o.x+7,s=o.y+7,e.x>=t&&e.x<=a&&e.y>=i&&e.y<=s?(this._textHit=!1,!0):(this.deselect(),!1)}setSecondPoint(e){this._secondPoint=e.copy();let t=this._getDivDimensions(),i=this._viewer.view.projectPoint(this._secondPoint);this._secondPointRel=new Communicator.Point2(i.x/t.width,i.y/t.height),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)}setFirstPoint(e){this._firstPoint=e.copy()}getSecondPoint(){return this._secondPoint.copy()}select(){this._allowEditing&&($(this._textBoxText).attr("disabled",!1),$(this._textBoxText).focus(),$(this._textBoxDiv).css("pointer-events","auto")),$(this._textBoxDiv).css("outline-width","2px"),this._selected=!0}deselect(){$(this._textBoxText).attr("disabled",!0),$(this._textBoxDiv).css("pointer-events","none"),$(this._textBoxDiv).css("outline-width","1px"),this._selected=!1}unprojectTextAnchor(){let e=this._getDivDimensions();this._secondPoint=this._viewer.view.unprojectPoint(new Communicator.Point2(this._secondPointRel.x*e.width,this._secondPointRel.y*e.height),.5),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)}_addPolylineElement(e){let t=r.svgPointString(e.getPoints()),i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",t),i.setAttributeNS(null,"fill","none"),i.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),i.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(i)}_addCircleElement(e){let t=e.getCenter(),i=e.getRadius(),a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttributeNS(null,"cx",t.x.toString()),a.setAttributeNS(null,"cy",t.y.toString()),a.setAttributeNS(null,"r",i.toString()),a.setAttributeNS(null,"fill","rgb("+this._circleColor.r+","+this._circleColor.g+","+this._circleColor.b+")"),a.setAttributeNS(null,"fill-opacity","1"),a.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),a.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(a)}_initialize(){this._lineGeometryShape.setStrokeWidth(1),this._circleGeometryShape.setFillColor(this._circleColor),this._circleGeometryShape.setRadius(this._circleRadius),this._setupTextDiv()}_setupTextDiv(){let e="";e+='<div id="'+this._uniqueid+'" style="max-width:'+this._maxWidth+"px;display:flex;background-color:#e8e5ff;outline-style:solid;outline-width:2px;position: absolute;",e+='top:0px; left: 0px;width:50px;outline-color: rgb(76, 135, 190);"background: rgb('+this._backgroundColor.r+","+this._backgroundColor.g+","+this._backgroundColor.b+");>",e+='<textarea autofocus style="max-width:'+this._maxWidth+"px;margin: 1px 0px 3px 3px; resize: none;font-family:"+this._font+";font-size:"+this._fontSize+";height:"+(parseInt(this._fontSize)+3)+'px;position: relative;outline: none;border: none;word-break: break-word;padding: 0 0 0 0;background-color: transparent;width: 100px;flex-grow: 1;overflow: hidden;"></textarea>',e+="</div>",$("#measurecanvas").length||($("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="measurecanvas" width="420px" height="150px;"></canvas></div>'),document.getElementById("measurecanvas").getContext("2d").font=this._fontSize+" "+this._font),$(this._viewer.getViewElement().parentElement).append(e),this._textBoxDiv=$("#"+this._uniqueid),this._textBoxText=$(this._textBoxDiv).children()[0],this._extraDivText&&($(this._textBoxDiv).append(this._extraDivText),this._extraTextDiv=$(this._textBoxDiv).children()[1]),this._textBoxMarkupTypeManager.getUseMarkupManager()||(this._svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._viewer.getViewElement().parentElement.appendChild(this._svgElement),$(this._svgElement).css("position","absolute"),$(this._svgElement).css("pointer-events","none"),$(this._svgElement).css("width","100%"),$(this._svgElement).css("height","100%")),$(this._textBoxText).on("input",(e=>{this._adjustTextBox(),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)})),this.select()}_adjustTextBox(){let e=this._calculateMaxTextWidth();$(this._textBoxDiv).css("width",e.width+"px"),$(this._textBoxText).css("height","0px"),$(this._textBoxText).css("height",$(this._textBoxText)[0].scrollHeight+"px"),this._textBoxMarkupTypeManager.refreshMarkup()}_calculateMaxTextWidth(){let e=document.getElementById("measurecanvas").getContext("2d"),t=$(this._textBoxText).val().split("\n"),i=0;for(let a=0;a<t.length;a++){let s=e.measureText(t[a]);s.width>i&&(i=s.width)}return{width:i+10}}_getDivDimensions(){return{width:$(this._viewer.getViewElement()).outerWidth(),height:$(this._viewer.getViewElement()).outerHeight()}}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}class l{constructor(e,t=null){this._viewer=e,t?this._textBoxMarkupTypeManager=t:(this._textBoxMarkupTypeManager=new n(this._viewer),this._viewer.markupManager.registerMarkupTypeManager("TextBox",this._textBoxMarkupTypeManager)),this._allowCreation=2,this._createMarkupItemCallback=null,this._mouseActivationCallback=null}getTextBoxTypeManager(){return this._textBoxMarkupTypeManager}setCreateMarkupItemCallback(e){this._createMarkupItemCallback=e}setMouseActivationCallback(e){this._mouseActivationCallback=e}onMouseDown(e){if(this._handled=!1,!this._mouseActivationCallback&&e.getButton()==Communicator.Button.Left||this._mouseActivationCallback&&this._mouseActivationCallback(e)){const t=this._textBoxMarkupTypeManager.pickMarkupItem(e.getPosition());t&&t instanceof r?(t.getPinned()&&t.unprojectTextAnchor(),this._offset=Communicator.Point2.subtract(e.getPosition(),this._viewer.view.projectPoint(t.getSecondPoint())),this._dClickTime=new Date,this._activeMarkupItem=t,this._handled=!0):this._allowCreation&&(this._addMarkupItem(e.getPosition()),1==this._allowCreation&&(this._allowCreation=0))}e.setHandled(this._handled)}onMouseMove(e){this._dClickTime=null,e.setHandled(this._handled),null!==this._activeMarkupItem&&this._handled&&this._updateActiveMarkupItem(e.getPosition())}onMouseUp(e){null!==this._dClickTime&&this._activeMarkupItem.select(),this._dClickTime=null,e.setHandled(this._handled),this._activeMarkupItem=null}async _addMarkupItem(e){const t=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),a=await this._viewer.view.pickFromPoint(e,i);if(null===a||a.overlayIndex())return;const s=a.getNodeId(),o=a.getPosition(),n=a.getFaceEntity();null!==s&&null!==o&&null!==n&&null!==t.getNodeParent(s)&&(this._createMarkupItemCallback?this._activeMarkupItem=this._createMarkupItemCallback(this._textBoxMarkupTypeManager,o):this._activeMarkupItem=new r(this._textBoxMarkupTypeManager,o),this._textBoxMarkupTypeManager.add(this._activeMarkupItem),this._offset=new Communicator.Point2(0,0),this._handled=!0)}async _updateActiveMarkupItem(e){if(null===this._activeMarkupItem)return;if(!this._activeMarkupItem._textHit){const t=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),a=await this._viewer.view.pickFromPoint(e,i);if(null===a||a.overlayIndex())return;const s=a.getNodeId(),o=a.getPosition(),n=a.getFaceEntity();let r=!0;if(null!==s&&null!==o&&null!==n||(r=!1),null===t.getNodeParent(s)&&(r=!1),r)this._activeMarkupItem.setFirstPoint(o);else{let t=this._viewer.view.getCamera(),i=t.getPosition(),a=t.getTarget(),s=Communicator.Point3.subtract(a,i).normalize(),o=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),s),n=new Communicator.Point3,r=this._viewer.view.raycastFromPoint(new Communicator.Point2(e.x,e.y)),l=null;l=o.intersectsRay(r,n),l&&this._activeMarkupItem.setFirstPoint(new Communicator.Point3(n.x,n.y,n.z))}return void this._textBoxMarkupTypeManager.refreshMarkup()}let t=this._viewer.view.getCamera(),i=t.getPosition(),a=t.getTarget(),s=Communicator.Point3.subtract(a,i).normalize(),o=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),s),n=new Communicator.Point3,r=this._viewer.view.raycastFromPoint(new Communicator.Point2(e.x-this._offset.x,e.y-this._offset.y)),l=null;l=o.intersectsRay(r,n),l&&(this._activeMarkupItem.setSecondPoint(new Communicator.Point3(n.x,n.y,n.z)),this._textBoxMarkupTypeManager.refreshMarkup())}}var d,c,h,m,u=null,p=!1,_=!1,g=!1,w=!1,f="",v=null,x=null,C=[],y=!1,M=!0,b=!0,k=!1,S=null,P=[],I=[[255,0,0],[0,255,0],[0,0,255],[255,0,255],[0,255,255],[255,128,0],[128,255,0],[0,255,128],[0,128,255],[128,0,255],[255,0,128],[255,128,128],[128,255,128],[128,128,255],[255,128,255],[255,255,128],[128,255,255],[255,255,255]],N=0;function D(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var T,B,O=[],E=[],F=[],R=[];function z(e,t){F[e]=t,R[t]=e}function A(e,t){O[e]=t,E[t]=e}function H(e){return e<0&&O[e]?O[e]:e}function V(e){return E[e]?E[e]:e}function W(){S&&S.handleResize()}function J(e){b=e}function U(){return b}function j(e){M=e,e?Ue():c.view.setTransparencyMode(0)}function L(){return M}function q(e){k=e,e||Ue()}function G(){return k}function X(){return!!u}function Y(){u&&(Ue(!0),u.disconnect(),u=null),g=!1,w=!1}function K(){if(u)return{id:u.id,name:d}}function Q(){return g}function Z(){return w}function ee(){!u||g||w||u.emit("lockSession",""),g=!0}function te(){u&&g&&u.emit("unlockSession",""),g=!1}function ie(e){u.emit("chatmessage",JSON.stringify({user:d,message:e}))}function ae(e){u.emit("updateroomdata",JSON.stringify(e))}async function se(){return new Promise(((e,t)=>{u.emit("getroomdata","",(t=>{e(JSON.parse(t))}))}))}function oe(e){p=e}function ne(){return p}function re(e){u&&(e.type="custommessage",e.user=d,u.emit("hcmessage",JSON.stringify(e)))}function le(e){x=e}function de(e,t){u&&(t.type=e,t.user=d,t.userid=u.id,u.emit("hcmessage",JSON.stringify(t)))}function ce(e){if(!_&&u&&!p&&!w){let e={camera:c.view.getCamera().toJson()};de(M?"camera":"camera2",e)}}function he(e){if(u&&!p&&!_&&!w&&b){let e=[],t=hwv.selectionManager.getResults();for(let i=0;i<t.length;i++)e.push(t[i].toJson()),e[i].nodeId=H(e[i].nodeId);de("selection",{selection:e})}}async function me(e,t,i){return!u||p||_||w||de("visibility",{nodeids:e,onoff:t}),await c.model.setNodesVisibilityCollab(e,t,i)}async function ue(e,t){var i=(new Error).stack;(-1==i.indexOf("hoops_web_viewer")||-1!=i.indexOf("web_viewer_ui")&&i.indexOf("web_viewer_ui")<i.indexOf("hoops_web_viewer"))&&(!u||p||_||w||de("facecolor",{nodeids:e,color:t.toJson()})),await c.model.setNodesFaceColorCollab(e,t)}async function pe(e,t,i){-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!u||p||_||w||de("metallicroughness",{nodeids:e,metallic:t,roughness:i})),await c.model.setMetallicRoughnessCollab(e,t,i)}async function _e(e){return-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!u||p||_||w||de("unsetmetallicroughness",{nodeids:e})),await c.model.unsetMetallicRoughnessCollab(e)}async function ge(e){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&u&&!p&&!_&&!w){let t=D();de("createmesh",{meshdata:e,uniqueid:t});let i=await c.model.createMeshCollab(e);return z(i[1],t),i}return await c.model.createMeshCollab(e)}async function we(e,t){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&u&&!p&&!_&&!w){let i=D(),a={meshinstancedata:JSON.parse(JSON.stringify(e)),nodeid:H(t),uniqueid:i};a.meshinstancedata._meshId[1]=function(e){return F[e]?F[e]:e}(a.meshinstancedata._meshId[1]),de("createmeshinstance",a);let s=await c.model.createMeshInstanceCollab(e,t);return A(s,i),s}return await c.model.createMeshInstanceCollab(e,t)}function fe(e,t,i,a,s,o){if(u&&!p&&!_&&!w){let n=D();de("createnode",{parentnodeid:H(e),nodename:t,nodeid:i,localMatrix:a,visibility:s,measurementUnits:o,uniqueid:n});let r=c.model.createNodeCollab(e,t,i,a,s,o);return A(r,n),r}return c.model.createNodeCollab(e,t,i,a,s,o)}async function ve(e){var t=(new Error).stack;return(-1==t.indexOf("hoops_web_viewer")||-1!=t.indexOf("web_viewer_ui")&&t.indexOf("web_viewer_ui")<t.indexOf("hoops_web_viewer"))&&(!u||p||_||w||de("unsetfacecolor",{nodeids:e})),await c.model.unsetNodesFaceColorCollab(e)}async function xe(e,t){return!u||p||_||w||de("opacity",{nodeids:e,opacity:t}),await c.model.setNodesOpacityCollab(e,t)}async function Ce(e){return!u||p||_||w||de("resetopacity",{nodeids:e}),await c.model.resetNodesOpacityCollab(e)}async function ye(e,t,i){return!u||p||_||w||de("setInstanceModifier",{a:e,b:t,c:i}),await c.model.setInstanceModifierCollab(e,t,i)}async function Me(){return!u||p||_||w||de("resetvisibilities",{}),await c.model.resetNodesVisibilityCollab()}async function be(e){return!u||p||_||w||de("setdrawmode",{drawmode:e}),await c.view.setDrawModeCollab(e)}async function ke(e){return!u||p||_||w||!M||de("setprojectionmode",{projectionmode:e}),await c.view.setProjectionModeCollab(e)}async function Se(){return!u||p||_||w||(await Ue(),de("reset",{})),await c.model.resetCollab()}async function Pe(){!u||p||_||w||de("clear",{}),await Ue(!0),await c.model.clearCollab(),c._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds()}async function Ie(e,t){let i=c.model.getNodeName(e);return i&&-1!=i.indexOf("handle-")||!u||p||_||w||de("matrix",{nodeid:H(e),matrix:t.toJson(),user:d}),await c.model.setNodeMatrixCollab(e,t)}async function Ne(e,t,i,a){return!u||p||_||w||(await Ue(),de("isolate",{nodeids:e,duration:t,fitNodes:i,initiallyHidden:a})),await c.view.isolateNodesCollab(e,0,i,a)}async function De(e,t){return!u||p||_||w||de("cadview",{nodeid:e,duration:t}),await c.model.activateCadViewCollab(e,0)}async function Te(e){return!u||p||_||w||de("explodemagnitude",{magnitude:e}),await c.explodeManager.setMagnitudeCollab(e)}function $e(e){!u||p||_||w||de("markup",{id:e.getUniqueId(),info:c.markupManager.exportMarkup()})}function Be(){!u||p||_||w||de("markup",{id:c.markupManager.getActiveMarkupView().getUniqueId(),info:c.markupManager.exportMarkup()})}function Oe(){!u||p||_||w||de("markup",{id:null,info:c.markupManager.exportMarkup()})}async function Ee(e){!u||p||_||w||de("activatemarkupview",{id:e}),c.unsetCallbacks({camera:ce}),await c.markupManager.activateMarkupViewWithPromiseCollab(e,0),c.setCallbacks({camera:ce})}async function Fe(e,t){!u||p||_||w||de("cuttingsection",{id:e,active:!0,csinfo:t.toJson()}),await t.activateCollab()}async function Re(e,t){!u||p||_||w||de("cuttingsection",{id:e,active:!1,csinfo:t.toJson()}),await t.deactivateCollab()}async function ze(e,t,i,a,s,o,n){await t.updatePlaneCollab(i,a,s,o,n),!u||p||_||w||de("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function Ae(e,t,i,a,s){await t.setPlaneCollab(i,a,s),!u||p||_||w||de("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function He(e,t,i){!u||p||_||w||de("loadsubtree",{a:e,b:t,c:i});let a=await c.model.loadSubtreeFromScsFileCollab(e,t,i);return c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),a}function Ve(e){for(let t in P)if(P[t].label==e){c.view.setCamera(P[t].cameraWidget.getCamera(),1e3);break}}function We(e,t,i,o){h=i,m=new a(e),S=new s(e);let n="content";o&&(n=o),$("#"+n).prepend('<div id="hcCollabSpriteOverlay" style="width: 100%; height: 100%; background: none;z-index:10000;position: absolute;pointer-events:none"></div>'),S.setNativeSpriteContainer("hcCollabSpriteOverlay"),S.setSpriteClickedEvent(Ve),function(){$("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="dummycanvas" width="420px" height="150px;"></canvas></div>');(T=document.getElementById("dummycanvas").getContext("2d")).font="50px Arial";let e=T.measureText("Hello World Test"),t=e.width+40,i=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent+20;$("body").append('<div style="display:none"><div id="camlabel" style="height:'+i+"px;width:"+t+'px;text-align:center;border-radius:20px;display:block;pointer-events:none;font-family:arial;font-size:50px;position:absolute;background-color:rgba(0,0,0,0.5);color:white;display:block">Hello World Test</div></div>'),B=$("#camlabel")}(),c=e,v=t,e.setCallbacks({camera:ce,selectionArray:he,viewCreated:$e,redlineCreated:Be,measurementCreated:Oe}),e.view.setProjectionModeCollab=e.view.setProjectionMode,e.view.setProjectionMode=ke,e.view.setDrawModeCollab=e.view.setDrawMode,e.view.setDrawMode=be,e.markupManager.activateMarkupViewWithPromiseCollab=e.markupManager.activateMarkupViewWithPromise,e.markupManager.activateMarkupViewWithPromise=Ee,e.model.loadSubtreeFromScsFileCollab=e.model.loadSubtreeFromScsFile,e.model.loadSubtreeFromScsFile=He,e.model.setNodesVisibilityCollab=e.model.setNodesVisibility,e.model.setNodesVisibility=me,e.model.createMeshCollab=e.model.createMesh,e.model.createMesh=ge,e.model.createMeshInstanceCollab=e.model.createMeshInstance,e.model.createMeshInstance=we,e.model.createNodeCollab=e.model.createNode,e.model.createNode=fe,e.model.setMetallicRoughnessCollab=e.model.setMetallicRoughness,e.model.setMetallicRoughness=pe,e.model.unsetMetallicRoughnessCollab=e.model.unsetMetallicRoughness,e.model.unsetMetallicRoughness=_e,e.model.setNodesFaceColorCollab=e.model.setNodesFaceColor,e.model.setNodesFaceColor=ue,e.model.unsetNodesFaceColorCollab=e.model.unsetNodesFaceColor,e.model.unsetNodesFaceColor=ve,e.model.setNodesOpacityCollab=e.model.setNodesOpacity,e.model.setNodesOpacity=xe,e.model.resetNodesOpacityCollab=e.model.resetNodesOpacity,e.model.resetNodesOpacity=Ce,e.model.setInstanceModifierCollab=e.model.setInstanceModifier,e.model.setInstanceModifier=ye,e.explodeManager.setMagnitudeCollab=e.explodeManager.setMagnitude,e.explodeManager.setMagnitude=Te,e.model.resetNodesVisibilityCollab=e.model.resetNodesVisibility,e.model.resetNodesVisibility=Me,e.model.resetCollab=e.model.reset,e.model.reset=Se,e.model.clearCollab=e.model.clear,e.model.clear=Pe,e.model.setNodeMatrixCollab=e.model.setNodeMatrix,e.model.setNodeMatrix=Ie,e.view.isolateNodesCollab=e.view.isolateNodes,e.view.isolateNodes=Ne,e.model.activateCadViewCollab=e.model.activateCadView,e.model.activateCadView=De;let r=e.cuttingManager.getCuttingSection(0),l=e.cuttingManager.getCuttingSection(1),d=e.cuttingManager.getCuttingSection(2);if(r&&(r.activateCollab=r.activate,r.activate=function(){Fe(0,this)},r.deactivateCollab=r.deactivate,r.deactivate=function(){Re(0,this)},r.updatePlaneCollab=r.updatePlane,r.updatePlane=function(e,t,i,a,s){ze(0,this,e,t,i,a,s)},r.setPlaneCollab=r.setPlane,r.setPlane=function(e,t,i){Ae(0,this,e,t,i)}),l&&(l.activateCollab=l.activate,l.activate=function(){Fe(1,this)},l.deactivateCollab=l.deactivate,l.deactivate=function(){Re(1,this)},l.updatePlaneCollab=l.updatePlane,l.updatePlane=function(e,t,i,a,s){ze(1,this,e,t,i,a,s)},l.setPlaneCollab=l.setPlane,l.setPlane=function(e,t,i){Ae(1,this,e,t,i)}),d&&(d.activateCollab=d.activate,d.activate=function(){Fe(2,this)},d.deactivateCollab=d.deactivate,d.deactivate=function(){Re(2,this)},d.updatePlaneCollab=d.updatePlane,d.updatePlane=function(e,t,i,a,s){ze(2,this,e,t,i,a,s)},d.setPlaneCollab=d.setPlane,d.setPlane=function(e,t,i){Ae(2,this,e,t,i)}),v){var _=$("#ui-modelbrowser-minimizebutton");_&&_.on("click",(function(){!u||p||w||($(this).hasClass("minimized")?de("minimizebrowser",{}):de("maximizebrowser",{}))}))}}async function Je(e,t,a){d=t;let s={username:t,roomname:e,password:a};(u=await io(h)).emit("joinroom",JSON.stringify(s)),u.on("hcmessage",(async function(e){let t=JSON.parse(e);x&&!x(t)||"custommessage"===t.type||function(e){C.push(e);{let e=setInterval((async function(){if(C.length>0){if(!y){y=!0;let e=C.shift();await async function(e){switch(_=!0,e.type){case"camera":case"camera2":{let t=Communicator.Camera.fromJson(e.camera);if(k&&!M&&P[e.userid]){let a=P[e.userid];if(a.cameraWidget||(m.isActive()||await m.initialize(),a.cameraWidget=new i(m,new Communicator.Color(a.color[0],a.color[1],a.color[2]),new Communicator.Color(a.color[0],a.color[1],a.color[2]),.4,!0,!1,1e3)),a.label)await a.label.setPosition(t.getPosition());else{let i=function(e,t){let i=T.measureText(e),a=i.width+40;return i.actualBoundingBoxAscent,i.actualBoundingBoxDescent,B.css("width",a+"px"),B.css("background-color","rgb("+t[0]+","+t[1]+","+t[2]+")"),B.html(e),e=e.replace(/ /g,"_"),B.attr("id","dynamic0"+e),"dynamic0"+e}(e.user,a.color);a.label=await S.createDOMSprite(i,t.getPosition(),.4,!1,!1)}await a.cameraWidget.update(t)}"camera"==e.type&&M&&(await c.view.setCamera(t),de("camera2",{camera:t.toJson()}))}break;case"setprojectionmode":M&&await c.view.setProjectionModeCollab(e.projectionmode);break;case"selection":if(b){let t=e.selection;c.selectionManager.clear();let i=[];for(let e=0;e<t.length;e++){let a,s,o;if(t[e].faceEntity&&(a=Communicator.Selection.FaceEntity.fromJson(t[e].faceEntity)),t[e].lineEntity&&(s=Communicator.Selection.LineEntity.fromJson(t[e].lineEntity)),t[e].pointEntity&&(o=Communicator.Selection.PointEntity.fromJson(t[e].pointEntity)),c._modelStructure._assemblyTree.lookupAnyTreeNode(V(t[e].nodeId))){let n=new Communicator.Selection.SelectionItem.create(V(t[e].nodeId),null,a,s,o);i.push(n)}}for(let e=0;e<i.length;e++)await c.selectionManager.add(i[e])}break;case"setdrawmode":await c.view.setDrawModeCollab(e.drawmode);break;case"activatemarkupview":c.unsetCallbacks({camera:ce}),await c.markupManager.activateMarkupViewWithPromise(e.id,0),c.setCallbacks({camera:ce});break;case"markup":c.unsetCallbacks({viewCreated:$e}),c.unsetCallbacks({redlineCreated:$e}),c.markupManager.deleteMarkupView(e.id),await c.markupManager.loadMarkupData(e.info),e.id&&c.markupManager.activateMarkupView(e.id),c.markupManager.refreshMarkup(),c.setCallbacks({viewCreated:$e}),c.setCallbacks({redlineCreated:$e});break;case"loadsubtree":c.unsetCallbacks({camera:ce}),await hwv.model.loadSubtreeFromScsFileCollab(e.a,e.b,e.c),c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),c.setCallbacks({camera:ce});break;case"visibility":await c.model.setNodesVisibilityCollab(e.nodeids,e.onoff);break;case"createmesh":{let t=function(e){let t=new Communicator.MeshData;t.setFaceWinding(e._faceWinding);for(let i=0;i<e._faceMeshData.length;i++){let a=e._faceMeshData[i];t.addFaces(a.vertexData,a.normalData)}return t}(e.meshdata),i=await c.model.createMesh(t);e.uniqueid&&z(i[1],e.uniqueid)}break;case"createmeshinstance":{let t=V(e.nodeid),i=function(e){var t;e._meshId[1]=(t=e._meshId[1],R[t]?R[t]:t);let i=new Communicator.MeshInstanceData(e._meshId);return e._faceColor&&i.setFaceColor(new Communicator.Color(e._faceColor.r,e._faceColor.g,e._faceColor.b)),i}(e.meshinstancedata),a=await c.model.createMeshInstance(i,t);e.uniqueid&&A(a,e.uniqueid)}break;case"createnode":{let t=V(e.parentnodeid),i=c.model.createNode(t,e.nodename,e.nodeid,e.localMatrix,e.visibility,e.measurementUnits);e.uniqueid&&A(i,e.uniqueid)}break;case"opacity":try{await c.model.setNodesOpacityCollab(e.nodeids,e.opacity)}catch(e){}break;case"metallicroughness":try{await c.model.setMetallicRoughnessCollab(e.nodeids,e.metallic,e.roughness)}catch(e){}break;case"unsetmetallicroughness":try{await c.model.unsetMetallicRoughness(e.nodeids)}catch(e){}break;case"facecolor":try{await c.model.setNodesFaceColorCollab(e.nodeids,Communicator.Color.fromJson(e.color))}catch(e){}break;case"unsetfacecolor":try{await c.model.unsetNodesFaceColorCollab(e.nodeids)}catch(e){}break;case"resetopacity":await c.model.resetNodesOpacityCollab(e.nodeids,e.opacity);break;case"setInstanceModifier":try{await c.model.setInstanceModifierCollab(e.nodeid,e.modifier)}catch(e){}break;case"explodemagnitude":await c.explodeManager.setMagnitudeCollab(e.magnitude);break;case"resetvisibilities":await c.model.resetNodesVisibilityCollab();break;case"reset":await Ue(),await c.model.resetCollab();break;case"clear":await Ue(!0),c.unsetCallbacks({camera:ce}),await c.model.clearCollab(),c._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),c.setCallbacks({camera:ce});break;case"matrix":{let t=V(e.nodeid);await c.model.setNodeMatrixCollab(t,Communicator.Matrix.fromJson(e.matrix))}break;case"isolate":await Ue(),await c.view.isolateNodesCollab(e.nodeids,0,null!=e.fitNodes?e.fitNodes:void 0,null!=e.initiallyHidden?e.initiallyHidden:void 0);break;case"cadview":await c.model.activateCadViewCollab(e.nodeid,0);break;case"cuttingsection":{let t=c.cuttingManager.getCuttingSection(e.id);e.active?await t.fromJson(e.csinfo):t.deactivateCollab()}break;case"minimizebrowser":await v._modelBrowser._minimizeModelBrowser();break;case"maximizebrowser":await v._modelBrowser._maximizeModelBrowser()}_=!1}(e),y=!1}}else clearInterval(e),e=null}),10)}}(t)})),u.on("initialState",(function(e){let t=JSON.parse(e);if(t.type="initialState",(!x||x(t))&&t.camera){let e=Communicator.Camera.fromJson(t.camera);c.view.setCamera(e)}})),u.on("sendInitialState",(function(e){let t={type:"sendInitialState",camera:c.view.getCamera().toJson()};x&&!x(t)||u.emit("initialState",JSON.stringify({recepient:e,state:t}))})),u.on("lockSession",(function(e){x&&!x({user:e,type:"lockSession"})||(f=e,w=!0)})),u.on("unlockSession",(function(e){x&&!x({type:"unlockSession"})||(w=!1)})),u.on("disconnect",(()=>{f="",w=!1,Y(),x&&x({type:"connectionLost"})})),u.on("disconnected",(function(e){e==f&&1==w&&(f="",w=!1),x&&x({user:e,type:"disconnected"})})),u.on("chatmessage",(function(e){let t=JSON.parse(e);t.type="chatmessage",x&&x(t)})),u.on("userlist",(async function(e){let t=JSON.parse(e);t.type="userlist";for(let e in P)P[e].delete=!0;for(let e=0;e<t.roomusers.length;e++){let i=t.roomusers[e].id;P[i]||(P[i]=t.roomusers[e],P[i].color=I[N++],N>=I.length&&(N=0)),P[i].delete=!1}for(let e in P)P[e].delete&&(_=!0,P[e].cameraWidget&&(P[e].cameraWidget.flush(),S.flush(P[e].label.nodeid)),delete P[e],_=!1);x&&x(t)}))}async function Ue(e){_=!0,await S.flushAll();for(let e in P){let t=P[e];t.cameraWidget&&(await t.cameraWidget.flush(),t.cameraWidget=null,t.label=null)}e&&m.deactivate(),_=!1}hcCollab=t})();