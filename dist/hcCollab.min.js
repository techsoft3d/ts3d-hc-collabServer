var hcCollab;(()=>{"use strict";var e={d:(a,t)=>{for(var o in t)e.o(t,o)&&!e.o(a,o)&&Object.defineProperty(a,o,{enumerable:!0,get:t[o]})},o:(e,a)=>Object.prototype.hasOwnProperty.call(e,a),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},a={};e.r(a),e.d(a,{connect:()=>Je,disconnect:()=>D,getActive:()=>V,getInternalSuspend:()=>G,getLocalUser:()=>E,getLockedClient:()=>j,getLockedMaster:()=>W,getRoomData:()=>A,getSuspendSend:()=>H,getSyncCamera:()=>F,getSyncSelection:()=>P,getUserInfo:()=>U,getUsers:()=>T,initialize:()=>Ie,lockSession:()=>R,registerMessageReceivedCallback:()=>Q,sendCustomMessage:()=>K,setSuspendSend:()=>B,setSyncCamera:()=>J,setSyncSelection:()=>I,submitChat:()=>z,unlockSession:()=>q,updateRoomData:()=>L});var t,o,i,n=null,l=!1,s=!1,r=!1,c=!1,d="",u=null,m=[],f=[],b=!1,w=!0,C=!0,p=[],g=[[160,160,255],[160,255,160],[255,160,160],[255,0,255],[0,255,255],[255,128,0],[128,255,0],[0,255,128],[0,128,255],[128,0,255],[255,0,128],[255,128,128],[128,255,128],[128,128,255],[255,128,255],[255,255,128],[128,255,255],[255,255,255]],y=0;function h(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var a=16*Math.random()|0;return("x"==e?a:3&a|8).toString(16)}))}var M=[],v=[],k=[],x=[];function S(e,a){k[e]=a,x[a]=e}function N(e,a){M[e]=a,v[a]=e}function _(e){return e<0&&M[e]?M[e]:e}function O(e){return v[e]?v[e]:e}function I(e){C=e}function P(){return C}function J(e){w=e}function F(){return w}function V(){return!!n}function D(){n&&(Pe({type:"disconnect"},!0),n.disconnect(),n=null),r=!1,c=!1}function E(){if(n)return{id:n.id,name:t,color:p[n.id].color}}function W(){return r}function j(){return c}function R(){!n||r||c||n.emit("lockSession",""),r=!0}function q(){n&&r&&n.emit("unlockSession",""),r=!1}function z(e){n.emit("chatmessage",JSON.stringify({user:t,message:e}))}function U(e){return p[e]}function T(){return p}function L(e){n.emit("updateroomdata",JSON.stringify(e))}async function A(){return new Promise(((e,a)=>{n.emit("getroomdata","",(a=>{e(JSON.parse(a))}))}))}function B(e){l=e}function H(){return l}function G(){return s}function K(e){n&&(e.type="custommessage",e.user=t,e.userid=n.id,n.emit("hcmessage",JSON.stringify(e)))}function Q(e){m.push(e)}function X(e,a){n&&(a.type=e,a.user=t,a.userid=n.id,n.emit("hcmessage",JSON.stringify(a)))}function Y(e){s||!n||l||c||X("camera",{camera:o.view.getCamera().toJson(),synced:w})}function Z(e){if(n&&!l&&!s&&!c&&C){let e=[],a=hwv.selectionManager.getResults();for(let t=0;t<a.length;t++)e.push(a[t].toJson()),e[t].nodeId=_(e[t].nodeId);X("selection",{selection:e})}}async function ee(e,a,t){return!n||l||s||c||X("visibility",{nodeids:e,onoff:a}),await o.model.setNodesVisibilityCollab(e,a,t)}async function ae(e,a){var t=(new Error).stack;(-1==t.indexOf("hoops_web_viewer")||-1!=t.indexOf("web_viewer_ui")&&t.indexOf("web_viewer_ui")<t.indexOf("hoops_web_viewer"))&&(!n||l||s||c||X("facecolor",{nodeids:e,color:a.toJson()})),await o.model.setNodesFaceColorCollab(e,a)}async function te(e,a,t){-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!n||l||s||c||X("metallicroughness",{nodeids:e,metallic:a,roughness:t})),await o.model.setMetallicRoughnessCollab(e,a,t)}async function oe(e){return-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!n||l||s||c||X("unsetmetallicroughness",{nodeids:e})),await o.model.unsetMetallicRoughnessCollab(e)}async function ie(e){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&n&&!l&&!s&&!c){let a=h();X("createmesh",{meshdata:e,uniqueid:a});let t=await o.model.createMeshCollab(e);return S(t[1],a),t}return await o.model.createMeshCollab(e)}async function ne(e,a){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&n&&!l&&!s&&!c){let t=h(),i={meshinstancedata:JSON.parse(JSON.stringify(e)),nodeid:_(a),uniqueid:t};i.meshinstancedata._meshId[1]=function(e){return k[e]?k[e]:e}(i.meshinstancedata._meshId[1]),X("createmeshinstance",i);let n=await o.model.createMeshInstanceCollab(e,a);return N(n,t),n}return await o.model.createMeshInstanceCollab(e,a)}function le(e,a,t,i,r,d){if(n&&!l&&!s&&!c){let n=h();X("createnode",{parentnodeid:_(e),nodename:a,nodeid:t,localMatrix:i,visibility:r,measurementUnits:d,uniqueid:n});let l=o.model.createNodeCollab(e,a,t,i,r,d);return N(l,n),l}return o.model.createNodeCollab(e,a,t,i,r,d)}async function se(e){var a=(new Error).stack;return(-1==a.indexOf("hoops_web_viewer")||-1!=a.indexOf("web_viewer_ui")&&a.indexOf("web_viewer_ui")<a.indexOf("hoops_web_viewer"))&&(!n||l||s||c||X("unsetfacecolor",{nodeids:e})),await o.model.unsetNodesFaceColorCollab(e)}async function re(e,a){return!n||l||s||c||X("opacity",{nodeids:e,opacity:a}),await o.model.setNodesOpacityCollab(e,a)}async function ce(e){return!n||l||s||c||X("resetopacity",{nodeids:e}),await o.model.resetNodesOpacityCollab(e)}async function de(e,a,t){return!n||l||s||c||X("setInstanceModifier",{a:e,b:a,c:t}),await o.model.setInstanceModifierCollab(e,a,t)}async function ue(){return!n||l||s||c||X("resetvisibilities",{}),await o.model.resetNodesVisibilityCollab()}async function me(e){return!n||l||s||c||X("setdrawmode",{drawmode:e}),await o.view.setDrawModeCollab(e)}async function fe(e){return!n||l||s||c||!w||X("setprojectionmode",{projectionmode:e}),await o.view.setProjectionModeCollab(e)}async function be(){return!n||l||s||c||X("reset",{}),Pe({type:"reset"},!0),await o.model.resetCollab()}async function we(){!n||l||s||c||X("clear",{}),await Pe({type:"clear"},!0),await o.model.clearCollab(),o._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds()}async function Ce(e,a){let i=o.model.getNodeName(e);return i&&-1!=i.indexOf("handle-")||!n||l||s||c||X("matrix",{nodeid:_(e),matrix:a.toJson(),user:t}),await o.model.setNodeMatrixCollab(e,a)}async function pe(e,a,t,i){return!n||l||s||c||(Pe({type:"isolate"},!0),X("isolate",{nodeids:e,duration:a,fitNodes:t,initiallyHidden:i})),await o.view.isolateNodesCollab(e,0,t,i)}async function ge(e,a){return!n||l||s||c||X("cadview",{nodeid:e,duration:a}),await o.model.activateCadViewCollab(e,0)}async function ye(e){return!n||l||s||c||X("explodemagnitude",{magnitude:e}),await o.explodeManager.setMagnitudeCollab(e)}function he(e){!n||l||s||c||X("markup",{id:e.getUniqueId(),info:o.markupManager.exportMarkup()})}function Me(){!n||l||s||c||X("markup",{id:o.markupManager.getActiveMarkupView().getUniqueId(),info:o.markupManager.exportMarkup()})}function ve(){!n||l||s||c||X("markup",{id:null,info:o.markupManager.exportMarkup()})}async function ke(e){!n||l||s||c||X("activatemarkupview",{id:e}),o.unsetCallbacks({camera:Y}),await o.markupManager.activateMarkupViewWithPromiseCollab(e,0),o.setCallbacks({camera:Y})}async function xe(e,a){!n||l||s||c||X("cuttingsection",{id:e,active:!0,csinfo:a.toJson()}),await a.activateCollab()}async function Se(e,a){!n||l||s||c||X("cuttingsection",{id:e,active:!1,csinfo:a.toJson()}),await a.deactivateCollab()}async function Ne(e,a,t,o,i,r,d){await a.updatePlaneCollab(t,o,i,r,d),!n||l||s||c||X("cuttingsection",{id:e,active:!0,csinfo:a.toJson()})}async function _e(e,a,t,o,i){await a.setPlaneCollab(t,o,i),!n||l||s||c||X("cuttingsection",{id:e,active:!0,csinfo:a.toJson()})}async function Oe(e,a,t){!n||l||s||c||X("loadsubtree",{a:e,b:a,c:t});let i=await o.model.loadSubtreeFromScsFileCollab(e,a,t);return o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),i}function Ie(e,a,t,s){i=t;let r="content";o=e,u=a,e.setCallbacks({camera:Y,selectionArray:Z,viewCreated:he,redlineCreated:Me,measurementCreated:ve}),e.view.setProjectionModeCollab=e.view.setProjectionMode,e.view.setProjectionMode=fe,e.view.setDrawModeCollab=e.view.setDrawMode,e.view.setDrawMode=me,e.markupManager.activateMarkupViewWithPromiseCollab=e.markupManager.activateMarkupViewWithPromise,e.markupManager.activateMarkupViewWithPromise=ke,e.model.loadSubtreeFromScsFileCollab=e.model.loadSubtreeFromScsFile,e.model.loadSubtreeFromScsFile=Oe,e.model.setNodesVisibilityCollab=e.model.setNodesVisibility,e.model.setNodesVisibility=ee,e.model.createMeshCollab=e.model.createMesh,e.model.createMesh=ie,e.model.createMeshInstanceCollab=e.model.createMeshInstance,e.model.createMeshInstance=ne,e.model.createNodeCollab=e.model.createNode,e.model.createNode=le,e.model.setMetallicRoughnessCollab=e.model.setMetallicRoughness,e.model.setMetallicRoughness=te,e.model.unsetMetallicRoughnessCollab=e.model.unsetMetallicRoughness,e.model.unsetMetallicRoughness=oe,e.model.setNodesFaceColorCollab=e.model.setNodesFaceColor,e.model.setNodesFaceColor=ae,e.model.unsetNodesFaceColorCollab=e.model.unsetNodesFaceColor,e.model.unsetNodesFaceColor=se,e.model.setNodesOpacityCollab=e.model.setNodesOpacity,e.model.setNodesOpacity=re,e.model.resetNodesOpacityCollab=e.model.resetNodesOpacity,e.model.resetNodesOpacity=ce,e.model.setInstanceModifierCollab=e.model.setInstanceModifier,e.model.setInstanceModifier=de,e.explodeManager.setMagnitudeCollab=e.explodeManager.setMagnitude,e.explodeManager.setMagnitude=ye,e.model.resetNodesVisibilityCollab=e.model.resetNodesVisibility,e.model.resetNodesVisibility=ue,e.model.resetCollab=e.model.reset,e.model.reset=be,e.model.clearCollab=e.model.clear,e.model.clear=we,e.model.setNodeMatrixCollab=e.model.setNodeMatrix,e.model.setNodeMatrix=Ce,e.view.isolateNodesCollab=e.view.isolateNodes,e.view.isolateNodes=pe,e.model.activateCadViewCollab=e.model.activateCadView,e.model.activateCadView=ge;let d=e.cuttingManager.getCuttingSection(0),m=e.cuttingManager.getCuttingSection(1),f=e.cuttingManager.getCuttingSection(2);if(d&&(d.activateCollab=d.activate,d.activate=function(){xe(0,this)},d.deactivateCollab=d.deactivate,d.deactivate=function(){Se(0,this)},d.updatePlaneCollab=d.updatePlane,d.updatePlane=function(e,a,t,o,i){Ne(0,this,e,a,t,o,i)},d.setPlaneCollab=d.setPlane,d.setPlane=function(e,a,t){_e(0,this,e,a,t)}),m&&(m.activateCollab=m.activate,m.activate=function(){xe(1,this)},m.deactivateCollab=m.deactivate,m.deactivate=function(){Se(1,this)},m.updatePlaneCollab=m.updatePlane,m.updatePlane=function(e,a,t,o,i){Ne(1,this,e,a,t,o,i)},m.setPlaneCollab=m.setPlane,m.setPlane=function(e,a,t){_e(1,this,e,a,t)}),f&&(f.activateCollab=f.activate,f.activate=function(){xe(2,this)},f.deactivateCollab=f.deactivate,f.deactivate=function(){Se(2,this)},f.updatePlaneCollab=f.updatePlane,f.updatePlane=function(e,a,t,o,i){Ne(2,this,e,a,t,o,i)},f.setPlaneCollab=f.setPlane,f.setPlane=function(e,a,t){_e(2,this,e,a,t)}),u){var b=$("#ui-modelbrowser-minimizebutton");b&&b.on("click",(function(){!n||l||c||($(this).hasClass("minimized")?X("minimizebrowser",{}):X("maximizebrowser",{}))}))}}async function Pe(e,a=!1){for(let t=0;t<m.length;t++){let o=m[t];if(!await o(e,a))return!1}return!0}async function Je(e,a,l){t=a;let r={username:a,roomname:e,password:l};(n=await io(i)).emit("joinroom",JSON.stringify(r)),n.on("hcmessage",(async function(e){!function(e){f.push(e);{let e=setInterval((async function(){if(f.length>0){if(!b){b=!0;let e=f.shift();await async function(e){if(s=!0,await Pe(e)){switch(e.type){case"camera":{let a=Communicator.Camera.fromJson(e.camera);"camera"==e.type&&e.synced&&w&&(await o.view.setCamera(a),X("camera",{camera:a.toJson(),synced:!1}))}break;case"setprojectionmode":w&&await o.view.setProjectionModeCollab(e.projectionmode);break;case"selection":if(C){let a=e.selection;o.selectionManager.clear();let t=[];for(let e=0;e<a.length;e++){let i,n,l;if(a[e].faceEntity&&(i=Communicator.Selection.FaceEntity.fromJson(a[e].faceEntity)),a[e].lineEntity&&(n=Communicator.Selection.LineEntity.fromJson(a[e].lineEntity)),a[e].pointEntity&&(l=Communicator.Selection.PointEntity.fromJson(a[e].pointEntity)),o._modelStructure._assemblyTree.lookupAnyTreeNode(O(a[e].nodeId))){let o=new Communicator.Selection.SelectionItem.create(O(a[e].nodeId),null,i,n,l);t.push(o)}}for(let e=0;e<t.length;e++)await o.selectionManager.add(t[e])}break;case"setdrawmode":await o.view.setDrawModeCollab(e.drawmode);break;case"activatemarkupview":o.unsetCallbacks({camera:Y}),await o.markupManager.activateMarkupViewWithPromise(e.id,0),o.setCallbacks({camera:Y});break;case"markup":o.unsetCallbacks({viewCreated:he}),o.unsetCallbacks({redlineCreated:he}),o.markupManager.deleteMarkupView(e.id),await o.markupManager.loadMarkupData(e.info),e.id&&o.markupManager.activateMarkupView(e.id),o.markupManager.refreshMarkup(),o.setCallbacks({viewCreated:he}),o.setCallbacks({redlineCreated:he});break;case"loadsubtree":o.unsetCallbacks({camera:Y}),await hwv.model.loadSubtreeFromScsFileCollab(e.a,e.b,e.c),o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),o.setCallbacks({camera:Y});break;case"visibility":await o.model.setNodesVisibilityCollab(e.nodeids,e.onoff);break;case"createmesh":{let a=function(e){let a=new Communicator.MeshData;a.setFaceWinding(e._faceWinding);for(let t=0;t<e._faceMeshData.length;t++){let o=e._faceMeshData[t];a.addFaces(o.vertexData,o.normalData)}return a}(e.meshdata),t=await o.model.createMesh(a);e.uniqueid&&S(t[1],e.uniqueid)}break;case"createmeshinstance":{let a=O(e.nodeid),t=function(e){var a;e._meshId[1]=(a=e._meshId[1],x[a]?x[a]:a);let t=new Communicator.MeshInstanceData(e._meshId);return e._faceColor&&t.setFaceColor(new Communicator.Color(e._faceColor.r,e._faceColor.g,e._faceColor.b)),t}(e.meshinstancedata),i=await o.model.createMeshInstance(t,a);e.uniqueid&&N(i,e.uniqueid)}break;case"createnode":{let a=O(e.parentnodeid),t=o.model.createNode(a,e.nodename,e.nodeid,e.localMatrix,e.visibility,e.measurementUnits);e.uniqueid&&N(t,e.uniqueid)}break;case"opacity":try{await o.model.setNodesOpacityCollab(e.nodeids,e.opacity)}catch(e){}break;case"metallicroughness":try{await o.model.setMetallicRoughnessCollab(e.nodeids,e.metallic,e.roughness)}catch(e){}break;case"unsetmetallicroughness":try{await o.model.unsetMetallicRoughness(e.nodeids)}catch(e){}break;case"facecolor":try{await o.model.setNodesFaceColorCollab(e.nodeids,Communicator.Color.fromJson(e.color))}catch(e){}break;case"unsetfacecolor":try{await o.model.unsetNodesFaceColorCollab(e.nodeids)}catch(e){}break;case"resetopacity":await o.model.resetNodesOpacityCollab(e.nodeids,e.opacity);break;case"setInstanceModifier":try{await o.model.setInstanceModifierCollab(e.nodeid,e.modifier)}catch(e){}break;case"explodemagnitude":await o.explodeManager.setMagnitudeCollab(e.magnitude);break;case"resetvisibilities":await o.model.resetNodesVisibilityCollab();break;case"reset":await o.model.resetCollab();break;case"clear":o.unsetCallbacks({camera:Y}),await o.model.clearCollab(),o._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),o.setCallbacks({camera:Y});break;case"matrix":{let a=O(e.nodeid);await o.model.setNodeMatrixCollab(a,Communicator.Matrix.fromJson(e.matrix))}break;case"isolate":await o.view.isolateNodesCollab(e.nodeids,0,null!=e.fitNodes?e.fitNodes:void 0,null!=e.initiallyHidden?e.initiallyHidden:void 0);break;case"cadview":await o.model.activateCadViewCollab(e.nodeid,0);break;case"cuttingsection":{let a=o.cuttingManager.getCuttingSection(e.id);e.active?await a.fromJson(e.csinfo):a.deactivateCollab()}break;case"minimizebrowser":await u._modelBrowser._minimizeModelBrowser();break;case"maximizebrowser":await u._modelBrowser._maximizeModelBrowser()}s=!1}else s=!1}(e),b=!1}}else clearInterval(e),e=null}),10)}}(JSON.parse(e))})),n.on("initialState",(function(e){let a=JSON.parse(e);if(a.type="initialState",Pe(a)&&a.camera){let e=Communicator.Camera.fromJson(a.camera);o.view.setCamera(e)}})),n.on("sendInitialState",(async function(e){let a={type:"sendInitialState",camera:o.view.getCamera().toJson()};await Pe(a)&&n.emit("initialState",JSON.stringify({recepient:e,state:a}))})),n.on("lockSession",(function(e){Pe({user:e,type:"lockSession"})&&(d=e,c=!0)})),n.on("unlockSession",(function(e){Pe({type:"unlockSession"})&&(c=!1)})),n.on("disconnect",(()=>{d="",c=!1,D(),Pe({type:"connectionLost"})})),n.on("disconnected",(function(e){e==d&&1==c&&(d="",c=!1),Pe({user:e,type:"disconnected"})})),n.on("chatmessage",(function(e){let a=JSON.parse(e);a.type="chatmessage",Pe(a)})),n.on("userlist",(async function(e){let a=JSON.parse(e);a.type="userlist";for(let e in p)p[e].delete=!0;for(let e=0;e<a.roomusers.length;e++){let t=a.roomusers[e].id;p[t]||(p[t]=a.roomusers[e],p[t].color=g[y++],y>=g.length&&(y=0)),p[t].delete=!1}if(await Pe({type:"predelete",message:a})){for(let e in p)p[e].delete&&delete p[e];Pe(a)}}))}hcCollab=a})();