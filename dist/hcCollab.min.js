var hcCollab;(()=>{"use strict";var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{startCollab:()=>W});var i,a,n=null,o=!1,l=!1,s=!1,r=!1,c=!1,d=!1,u=!1,m=!1,v=!1,w=null,f=null,h=[],g=!1,b=!1,p=!0,y="";function C(e){if(o||!n||b)o=!1;else{let t={camera:e.toJson(),user:a};n.emit("camera",JSON.stringify(t))}}async function S(e,t,i){if(!n||l||b)l=!1;else{let i={nodeids:e,onoff:t};n.emit("visibility",JSON.stringify(i))}return await hwv.model.setNodesVisibilityCollab(e,t,i)}async function M(){return!n||l||b?l=!1:n.emit("resetvisibilities",""),await hwv.model.resetNodesVisibilityCollab()}async function N(e){if(n&&!b){let t={drawmode:e,user:a};n.emit("setdrawmode",JSON.stringify(t))}return await hwv.view.setDrawModeCollab(e)}async function J(e){if(n&&!b){let t={projectionmode:e,user:a};n.emit("setprojectionmode",JSON.stringify(t))}return await hwv.view.setProjectionModeCollab(e)}async function k(){return n&&!b&&n.emit("reset",""),await hwv.model.resetCollab()}async function O(){return n&&!b&&n.emit("clear",""),await hwv.model.clearCollab()}async function P(e,t){if(!n||r||b)r=!1;else{let i={nodeid:e,matrix:t.toJson(),user:a};n.emit("matrix",JSON.stringify(i))}return await hwv.model.setNodeMatrixCollab(e,t)}async function V(e,t,i,a){if(!n||c||b)c=!1;else{let o={nodeids:e,duration:t,fitNodes:i,initiallyHidden:a};n.emit("isolate",JSON.stringify(o))}return await hwv.view.isolateNodesCollab(e,0,i,a)}async function x(e,t){if(!n||d||b)d=!1;else{let i={nodeid:e,duration:t};n.emit("cadview",JSON.stringify(i))}return await hwv.model.activateCadViewCollab(e,t)}async function j(e){if(!n||u||b)u=!1;else{let t={magnitude:e,user:a};n.emit("explodemagnitude",JSON.stringify(t))}return await hwv.explodeManager.setMagnitudeCollab(e)}function D(e){if(n&&!b){let t={id:e.getUniqueId(),info:hwv.markupManager.exportMarkup(),user:a};n.emit("markup",JSON.stringify(t))}}async function E(e){if(!n||m||b)m=!1;else{markupview=hwv.markupManager.getActiveMarkupView();let t={id:e,user:a};n.emit("activatemarkupview",JSON.stringify(t))}hwv.unsetCallbacks({camera:C}),await hwv.markupManager.activateMarkupViewWithPromiseCollab(e,0),hwv.setCallbacks({camera:C})}async function I(e,t){if(n&&!v&&!b){csinfo=t.toJson();let i={id:e,active:!0,csinfo,user:a};n.emit("cuttingsection",JSON.stringify(i))}await t.activateCollab()}async function U(e,t){if(n&&!v&&!b){csinfo=t.toJson();let i={id:e,active:!1,csinfo,user:a};n.emit("cuttingsection",JSON.stringify(i))}await t.deactivateCollab()}async function F(e,t,i,o,l,s,r){if(await t.updatePlaneCollab(i,o,l,s,r),n&&!v&&!b){csinfo=t.toJson();let i={id:e,active:!0,csinfo,user:a};n.emit("cuttingsection",JSON.stringify(i))}}async function B(e,t,i,o,l){if(await t.setPlaneCollab(i,o,l),n&&!v&&!b){csinfo=t.toJson();let i={id:e,active:!0,csinfo,user:a};n.emit("cuttingsection",JSON.stringify(i))}}async function _(e,t,i){if(n&&!b){let o={a:e,b:t,c:i,user:a};n.emit("loadsubtree",JSON.stringify(o))}await hwv.model.loadSubtreeFromScsFileCollab(e,t,i)}var z=null;function A(){$("#collabLockButton").prop("disabled",b)}function T(e){$("#activeUserMessage").html("Active User: "+e),$("#activeUserMessage").css("display","block"),f&&clearTimeout(f),f=setTimeout((function(){$("#activeUserMessage").css("display","none")}),1e3)}async function W(e){if(a=$("#username").val(),localStorage.setItem("username",a),p){setInterval((function(){let e=window.editor.getSelection();e!=z&&(z=e,!n||s||b?s=!1:n.emit("editorselectionchanged",JSON.stringify(e)))}),1e3),hwv.view.setProjectionModeCollab=hwv.view.setProjectionMode,hwv.view.setProjectionMode=J,hwv.view.setDrawModeCollab=hwv.view.setDrawMode,hwv.view.setDrawMode=N,hwv.markupManager.activateMarkupViewWithPromiseCollab=hwv.markupManager.activateMarkupViewWithPromise,hwv.markupManager.activateMarkupViewWithPromise=E,hwv.model.loadSubtreeFromScsFileCollab=hwv.model.loadSubtreeFromScsFile,hwv.model.loadSubtreeFromScsFile=_,hwv.model.setNodesVisibilityCollab=hwv.model.setNodesVisibility,hwv.model.setNodesVisibility=S,hwv.explodeManager.setMagnitudeCollab=hwv.explodeManager.setMagnitude,hwv.explodeManager.setMagnitude=j,hwv.model.resetNodesVisibilityCollab=hwv.model.resetNodesVisibility,hwv.model.resetNodesVisibility=M,hwv.model.resetCollab=hwv.model.reset,hwv.model.reset=k,hwv.model.clearCollab=hwv.model.clear,hwv.model.clear=O,hwv.model.setNodeMatrixCollab=hwv.model.setNodeMatrix,hwv.model.setNodeMatrix=P,hwv.view.isolateNodesCollab=hwv.view.isolateNodes,hwv.view.isolateNodes=V,hwv.model.activateCadViewCollab=hwv.model.activateCadView,hwv.model.activateCadView=x;let e=hwv.cuttingManager.getCuttingSection(0),t=hwv.cuttingManager.getCuttingSection(1),i=hwv.cuttingManager.getCuttingSection(2);e.activateCollab=e.activate,e.activate=function(){I(0,this)},t.activateCollab=t.activate,t.activate=function(){I(1,this)},i.activateCollab=i.activate,i.activate=function(){I(2,this)},e.deactivateCollab=e.deactivate,e.deactivate=function(){U(0,this)},t.deactivateCollab=t.deactivate,t.deactivate=function(){U(1,this)},i.deactivateCollab=i.deactivate,i.deactivate=function(){U(2,this)},e.updatePlaneCollab=e.updatePlane,e.updatePlane=function(e,t,i,a,n){F(0,this,e,t,i,a,n)},t.updatePlaneCollab=t.updatePlane,t.updatePlane=function(e,t,i,a,n){F(1,this,e,t,i,a,n)},i.updatePlaneCollab=i.updatePlane,i.updatePlane=function(e,t,i,a,n){F(2,this,e,t,i,a,n)},e.setPlaneCollab=e.setPlane,e.setPlane=function(e,t,i){B(0,this,e,t,i)},t.setPlaneCollab=t.setPlane,t.setPlane=function(e,t,i){B(1,this,e,t,i)},i.setPlaneCollab=i.setPlane,i.setPlane=function(e,t,i){B(2,this,e,t,i)},$("#ui-modelbrowser-minimizebutton").on("click",(function(){n&&!b&&($(this).hasClass("minimized")?n.emit("minimizebrowser",""):n.emit("maximizebrowser",""))})),p=!1}$("#stopcollabbutton").css({display:"block"}),$("#startcollabbutton").css({display:"none"}),$("#usernamedialog").css({display:"none"});let t=getUrlParameter("snippet");if(t||(t="1"),t){n=await io();let e={username:$("#username").val(),roomname:t};n.emit("joinroom",JSON.stringify(e)),n.on("changedmessage",(function(e){let t=e.split("$$GUIDO$$");editor.setValue(t[0]),"undefined"!=t[1]&&htmleditor.setValue(t[1]),"undefined"!=t[2]&&csseditor.setValue(t[2])})),n.on("run",(function(e){let t=JSON.parse(e);T(t.user),document.getElementById("reload_environment").checked=t.reset,runCode(t.reset)})),n.on("maximizebrowser",(function(e){ui._modelBrowser._maximizeModelBrowser()})),n.on("minimizebrowser",(function(e){ui._modelBrowser._minimizeModelBrowser()})),n.on("lockSession",(function(e){y=e,b=!0,$("#content").css("pointer-events","none"),A()})),n.on("unlockSession",(function(e){b=!1,$("#content").css("pointer-events","all"),A()})),n.on("disconnected",(function(e){e==y&&1==b&&(y="",b=!1,$("#content").css("pointer-events","all"),A())})),n.on("camera",(function(e){let t=JSON.parse(e),i=Communicator.Camera.fromJson(t.camera);T(t.user),o=!0,hwv.view.setCamera(i)})),n.on("chatmessage",(function(e){let t=JSON.parse(e),i="";i+='<div><span style="color:green;">'+t.user+"</span>: "+t.message+"</div>",$("#chatmessages").append(i),$("#chatmessages").scrollTop($("#chatmessages").height()+100)})),n.on("matrix",(function(e){let t=JSON.parse(e);T(t.user),r=!0,hwv.model.setNodeMatrix(t.nodeid,Communicator.Matrix.fromJson(t.matrix))})),n.on("isolate",(async function(e){let t=JSON.parse(e);o=!0,v=!0,await hwv.view.isolateNodesCollab(t.nodeids,0,null!=t.fitNodes?t.fitNodes:void 0,null!=t.initiallyHidden?t.initiallyHidden:void 0)})),n.on("cadview",(function(e){let t=JSON.parse(e);d=!0,hwv.model.activateCadView(t.nodeid,null!=t.duration?t.duration:void 0)})),n.on("cuttingsection",(async function(e){let t=JSON.parse(e);T(t.user);let i=hwv.cuttingManager.getCuttingSection(t.id);t.active?(v=!0,r=!0,await i.fromJson(t.csinfo)):i.deactivateCollab(),v=!1})),n.on("explodemagnitude",(function(e){let t=JSON.parse(e);T(t.user),u=!0,hwv.explodeManager.setMagnitude(t.magnitude)})),n.on("loadsubtree",(function(e){let t=JSON.parse(e);T(t.user),hwv.model.loadSubtreeFromScsFileCollab(t.a,t.b,t.c)})),n.on("activatemarkupview",(async function(e){let t=JSON.parse(e);T(t.user),m=!0,hwv.unsetCallbacks({camera:C}),await hwv.markupManager.activateMarkupViewWithPromise(t.id,0),hwv.setCallbacks({camera:C})})),n.on("markup",(async function(e){let t=JSON.parse(e);T(t.user),hwv.unsetCallbacks({viewCreated:D}),hwv.unsetCallbacks({redlineCreated:D}),hwv.markupManager.deleteMarkupView(t.id),await hwv.markupManager.loadMarkupData(t.info),t.id&&hwv.markupManager.activateMarkupView(t.id),hwv.markupManager.refreshMarkup(),hwv.setCallbacks({viewCreated:D}),hwv.setCallbacks({redlineCreated:D})})),n.on("visibility",(function(e){let t=JSON.parse(e);l=!0,hwv.model.setNodesVisibility(t.nodeids,t.onoff)})),n.on("startcall",(function(e){G(e)})),n.on("startshare",(function(e){g=!0,G(e)})),n.on("resetvisibilities",(function(e){l=!0,v=!0,hwv.model.resetNodesVisibility()})),n.on("reset",(function(e){hwv.model.resetCollab()})),n.on("setdrawmode",(function(e){let t=JSON.parse(e);T(t.user),hwv.view.setDrawModeCollab(t.drawmode)})),n.on("setprojectionmode",(function(e){let t=JSON.parse(e);T(t.user),hwv.view.setProjectionModeCollab(t.projectionmode)})),n.on("clear",(function(e){hwv.model.clearCollab()})),n.on("resendedittext",(function(e){n.emit("changed",editor.getValue()+"$$GUIDO$$"+htmleditor.getValue()+"$$GUIDO$$"+csseditor.getValue())})),n.on("editorselectionchanged",(function(e){s=!0,window.editor.setSelection(JSON.parse(e))})),n.on("selection",(function(e){let t=JSON.parse(e),i=t.selection;T(t.user),hwv.selectionManager.clear();let a=[];for(let e=0;e<i.length;e++){let t,n,o;i[e].faceEntity&&(t=Communicator.Selection.FaceEntity.fromJson(i[e].faceEntity)),i[e].lineEntity&&(n=Communicator.Selection.LineEntity.fromJson(i[e].lineEntity)),i[e].pointEntity&&(o=Communicator.Selection.PointEntity.fromJson(i[e].pointEntity));let l=new Communicator.Selection.SelectionItem.create(i[e].nodeId,null,t,n,o);a.push(l)}for(let e=0;e<a.length;e++)hwv.selectionManager.add(a[e])})),n.on("userlist",(function(e){i.clearData(),h=JSON.parse(e);for(let e=0;e<h.length;e++){var t;t=n.id==h[e].id?{name:h[e].username+" (You)",id:h[e].id}:{name:h[e].username,id:h[e].id},i.addData([t],!1)}})),addCollabUI()}}async function G(e){(w=new Peer).on("open",(async function(){let t=await async function(){let e;if(g){e=await navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0});var t=(await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})).getAudioTracks()[0];e.addTrack(t)}else e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});return e}();window.localStream=t,H(t,"my-camera"),console.log("Calling to "+e),console.log(w),w.call(e,window.localStream).on("stream",(function(e){window.peer_stream=e,H(e,"peer-camera")})),function(){if(w){let t=$("#videodiv").width(),i=$("#videodiv").height();var e=document.getElementById("my-camera");e&&(e.setAttribute("height",i),e.setAttribute("width",t)),t=$("#videodiv2").width(),i=$("#videodiv2").height(),(e=document.getElementById("peer-camera")).setAttribute("height",i),e.setAttribute("width",t)}}()}))}function H(e,t){document.getElementById(t).srcObject=e,window.peer_stream=e}hcCollab=t})();