var hcCollab;(()=>{"use strict";var e={d:(t,a)=>{for(var o in a)e.o(a,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:a[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{connect:()=>Je,disconnect:()=>D,getActive:()=>V,getInternalSuspend:()=>G,getLocalUser:()=>E,getLockedClient:()=>j,getLockedMaster:()=>W,getRoomData:()=>A,getSuspendSend:()=>H,getSyncCamera:()=>F,getSyncSelection:()=>P,getUserInfo:()=>U,getUsers:()=>T,initialize:()=>Ie,lockSession:()=>R,registerMessageReceivedCallback:()=>Q,sendCustomMessage:()=>K,setSuspendSend:()=>B,setSyncCamera:()=>J,setSyncSelection:()=>I,submitChat:()=>z,unlockSession:()=>q,updateRoomData:()=>L});var a,o,i,n=null,l=!1,s=!1,r=!1,c=!1,d="",u=null,m=[],f=[],b=!1,w=!0,C=!0,p=[],g=[[210,210,255],[210,255,210],[255,210,210],[255,0,255],[0,255,255],[255,128,0],[128,255,0],[0,255,128],[0,128,255],[128,0,255],[255,0,128],[255,128,128],[128,255,128],[128,128,255],[255,128,255],[255,255,128],[128,255,255],[255,255,255]],y=0;function h(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var M=[],v=[],k=[],x=[];function S(e,t){k[e]=t,x[t]=e}function N(e,t){M[e]=t,v[t]=e}function _(e){return e<0&&M[e]?M[e]:e}function O(e){return v[e]?v[e]:e}function I(e){C=e}function P(){return C}function J(e){w=e}function F(){return w}function V(){return!!n}function D(){n&&(Pe({type:"disconnect"},!0),n.disconnect(),n=null),r=!1,c=!1}function E(){if(n)return{id:n.id,name:a,color:p[n.id].color}}function W(){return r}function j(){return c}function R(){!n||r||c||n.emit("lockSession",""),r=!0}function q(){n&&r&&n.emit("unlockSession",""),r=!1}function z(e){n.emit("chatmessage",JSON.stringify({user:a,message:e}))}function U(e){return p[e]}function T(){return p}function L(e){n.emit("updateroomdata",JSON.stringify(e))}async function A(){return new Promise(((e,t)=>{n.emit("getroomdata","",(t=>{e(JSON.parse(t))}))}))}function B(e){l=e}function H(){return l}function G(){return s}function K(e){n&&(e.type="custommessage",e.user=a,e.userid=n.id,n.emit("hcmessage",JSON.stringify(e)))}function Q(e){m.push(e)}function X(e,t){n&&(t.type=e,t.user=a,t.userid=n.id,n.emit("hcmessage",JSON.stringify(t)))}function Y(e){s||!n||l||c||X("camera",{camera:o.view.getCamera().toJson(),synced:w})}function Z(e){if(n&&!l&&!s&&!c&&C){let e=[],t=hwv.selectionManager.getResults();for(let a=0;a<t.length;a++)e.push(t[a].toJson()),e[a].nodeId=_(e[a].nodeId);X("selection",{selection:e})}}async function ee(e,t,a){return!n||l||s||c||X("visibility",{nodeids:e,onoff:t}),await o.model.setNodesVisibilityCollab(e,t,a)}async function te(e,t){var a=(new Error).stack;(-1==a.indexOf("hoops_web_viewer")||-1!=a.indexOf("web_viewer_ui")&&a.indexOf("web_viewer_ui")<a.indexOf("hoops_web_viewer"))&&(!n||l||s||c||X("facecolor",{nodeids:e,color:t.toJson()})),await o.model.setNodesFaceColorCollab(e,t)}async function ae(e,t,a){-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!n||l||s||c||X("metallicroughness",{nodeids:e,metallic:t,roughness:a})),await o.model.setMetallicRoughnessCollab(e,t,a)}async function oe(e){return-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!n||l||s||c||X("unsetmetallicroughness",{nodeids:e})),await o.model.unsetMetallicRoughnessCollab(e)}async function ie(e){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&n&&!l&&!s&&!c){let t=h();X("createmesh",{meshdata:e,uniqueid:t});let a=await o.model.createMeshCollab(e);return S(a[1],t),a}return await o.model.createMeshCollab(e)}async function ne(e,t){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&n&&!l&&!s&&!c){let a=h(),i={meshinstancedata:JSON.parse(JSON.stringify(e)),nodeid:_(t),uniqueid:a};i.meshinstancedata._meshId[1]=function(e){return k[e]?k[e]:e}(i.meshinstancedata._meshId[1]),X("createmeshinstance",i);let n=await o.model.createMeshInstanceCollab(e,t);return N(n,a),n}return await o.model.createMeshInstanceCollab(e,t)}function le(e,t,a,i,r,d){if(n&&!l&&!s&&!c){let n=h();X("createnode",{parentnodeid:_(e),nodename:t,nodeid:a,localMatrix:i,visibility:r,measurementUnits:d,uniqueid:n});let l=o.model.createNodeCollab(e,t,a,i,r,d);return N(l,n),l}return o.model.createNodeCollab(e,t,a,i,r,d)}async function se(e){var t=(new Error).stack;return(-1==t.indexOf("hoops_web_viewer")||-1!=t.indexOf("web_viewer_ui")&&t.indexOf("web_viewer_ui")<t.indexOf("hoops_web_viewer"))&&(!n||l||s||c||X("unsetfacecolor",{nodeids:e})),await o.model.unsetNodesFaceColorCollab(e)}async function re(e,t){return!n||l||s||c||X("opacity",{nodeids:e,opacity:t}),await o.model.setNodesOpacityCollab(e,t)}async function ce(e){return!n||l||s||c||X("resetopacity",{nodeids:e}),await o.model.resetNodesOpacityCollab(e)}async function de(e,t,a){return!n||l||s||c||X("setInstanceModifier",{a:e,b:t,c:a}),await o.model.setInstanceModifierCollab(e,t,a)}async function ue(){return!n||l||s||c||X("resetvisibilities",{}),await o.model.resetNodesVisibilityCollab()}async function me(e){return!n||l||s||c||X("setdrawmode",{drawmode:e}),await o.view.setDrawModeCollab(e)}async function fe(e){return!n||l||s||c||!w||X("setprojectionmode",{projectionmode:e}),await o.view.setProjectionModeCollab(e)}async function be(){return!n||l||s||c||X("reset",{}),Pe({type:"reset"},!0),await o.model.resetCollab()}async function we(){!n||l||s||c||X("clear",{}),await Pe({type:"clear"},!0),await o.model.clearCollab(),o._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds()}async function Ce(e,t){let i=o.model.getNodeName(e);return i&&-1!=i.indexOf("handle-")||!n||l||s||c||X("matrix",{nodeid:_(e),matrix:t.toJson(),user:a}),await o.model.setNodeMatrixCollab(e,t)}async function pe(e,t,a,i){return!n||l||s||c||(Pe({type:"isolate"},!0),X("isolate",{nodeids:e,duration:t,fitNodes:a,initiallyHidden:i})),await o.view.isolateNodesCollab(e,0,a,i)}async function ge(e,t){return!n||l||s||c||X("cadview",{nodeid:e,duration:t}),await o.model.activateCadViewCollab(e,0)}async function ye(e){return!n||l||s||c||X("explodemagnitude",{magnitude:e}),await o.explodeManager.setMagnitudeCollab(e)}function he(e){!n||l||s||c||X("markup",{id:e.getUniqueId(),info:o.markupManager.exportMarkup()})}function Me(){!n||l||s||c||X("markup",{id:o.markupManager.getActiveMarkupView().getUniqueId(),info:o.markupManager.exportMarkup()})}function ve(){!n||l||s||c||X("markup",{id:null,info:o.markupManager.exportMarkup()})}async function ke(e){!n||l||s||c||X("activatemarkupview",{id:e}),o.unsetCallbacks({camera:Y}),await o.markupManager.activateMarkupViewWithPromiseCollab(e,0),o.setCallbacks({camera:Y})}async function xe(e,t){!n||l||s||c||X("cuttingsection",{id:e,active:!0,csinfo:t.toJson()}),await t.activateCollab()}async function Se(e,t){!n||l||s||c||X("cuttingsection",{id:e,active:!1,csinfo:t.toJson()}),await t.deactivateCollab()}async function Ne(e,t,a,o,i,r,d){await t.updatePlaneCollab(a,o,i,r,d),!n||l||s||c||X("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function _e(e,t,a,o,i){await t.setPlaneCollab(a,o,i),!n||l||s||c||X("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function Oe(e,t,a){!n||l||s||c||X("loadsubtree",{a:e,b:t,c:a});let i=await o.model.loadSubtreeFromScsFileCollab(e,t,a);return o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),i}function Ie(e,t,a,s){i=a;let r="content";o=e,u=t,e.setCallbacks({camera:Y,selectionArray:Z,viewCreated:he,redlineCreated:Me,measurementCreated:ve}),e.view.setProjectionModeCollab=e.view.setProjectionMode,e.view.setProjectionMode=fe,e.view.setDrawModeCollab=e.view.setDrawMode,e.view.setDrawMode=me,e.markupManager.activateMarkupViewWithPromiseCollab=e.markupManager.activateMarkupViewWithPromise,e.markupManager.activateMarkupViewWithPromise=ke,e.model.loadSubtreeFromScsFileCollab=e.model.loadSubtreeFromScsFile,e.model.loadSubtreeFromScsFile=Oe,e.model.setNodesVisibilityCollab=e.model.setNodesVisibility,e.model.setNodesVisibility=ee,e.model.createMeshCollab=e.model.createMesh,e.model.createMesh=ie,e.model.createMeshInstanceCollab=e.model.createMeshInstance,e.model.createMeshInstance=ne,e.model.createNodeCollab=e.model.createNode,e.model.createNode=le,e.model.setMetallicRoughnessCollab=e.model.setMetallicRoughness,e.model.setMetallicRoughness=ae,e.model.unsetMetallicRoughnessCollab=e.model.unsetMetallicRoughness,e.model.unsetMetallicRoughness=oe,e.model.setNodesFaceColorCollab=e.model.setNodesFaceColor,e.model.setNodesFaceColor=te,e.model.unsetNodesFaceColorCollab=e.model.unsetNodesFaceColor,e.model.unsetNodesFaceColor=se,e.model.setNodesOpacityCollab=e.model.setNodesOpacity,e.model.setNodesOpacity=re,e.model.resetNodesOpacityCollab=e.model.resetNodesOpacity,e.model.resetNodesOpacity=ce,e.model.setInstanceModifierCollab=e.model.setInstanceModifier,e.model.setInstanceModifier=de,e.explodeManager.setMagnitudeCollab=e.explodeManager.setMagnitude,e.explodeManager.setMagnitude=ye,e.model.resetNodesVisibilityCollab=e.model.resetNodesVisibility,e.model.resetNodesVisibility=ue,e.model.resetCollab=e.model.reset,e.model.reset=be,e.model.clearCollab=e.model.clear,e.model.clear=we,e.model.setNodeMatrixCollab=e.model.setNodeMatrix,e.model.setNodeMatrix=Ce,e.view.isolateNodesCollab=e.view.isolateNodes,e.view.isolateNodes=pe,e.model.activateCadViewCollab=e.model.activateCadView,e.model.activateCadView=ge;let d=e.cuttingManager.getCuttingSection(0),m=e.cuttingManager.getCuttingSection(1),f=e.cuttingManager.getCuttingSection(2);if(d&&(d.activateCollab=d.activate,d.activate=function(){xe(0,this)},d.deactivateCollab=d.deactivate,d.deactivate=function(){Se(0,this)},d.updatePlaneCollab=d.updatePlane,d.updatePlane=function(e,t,a,o,i){Ne(0,this,e,t,a,o,i)},d.setPlaneCollab=d.setPlane,d.setPlane=function(e,t,a){_e(0,this,e,t,a)}),m&&(m.activateCollab=m.activate,m.activate=function(){xe(1,this)},m.deactivateCollab=m.deactivate,m.deactivate=function(){Se(1,this)},m.updatePlaneCollab=m.updatePlane,m.updatePlane=function(e,t,a,o,i){Ne(1,this,e,t,a,o,i)},m.setPlaneCollab=m.setPlane,m.setPlane=function(e,t,a){_e(1,this,e,t,a)}),f&&(f.activateCollab=f.activate,f.activate=function(){xe(2,this)},f.deactivateCollab=f.deactivate,f.deactivate=function(){Se(2,this)},f.updatePlaneCollab=f.updatePlane,f.updatePlane=function(e,t,a,o,i){Ne(2,this,e,t,a,o,i)},f.setPlaneCollab=f.setPlane,f.setPlane=function(e,t,a){_e(2,this,e,t,a)}),u){var b=$("#ui-modelbrowser-minimizebutton");b&&b.on("click",(function(){!n||l||c||($(this).hasClass("minimized")?X("minimizebrowser",{}):X("maximizebrowser",{}))}))}}async function Pe(e,t=!1){for(let a=0;a<m.length;a++){let o=m[a];if(!await o(e,t))return!1}return!0}async function Je(e,t,l){a=t;let r={username:t,roomname:e,password:l};(n=await io(i)).emit("joinroom",JSON.stringify(r)),n.on("hcmessage",(async function(e){!function(e){f.push(e);{let e=setInterval((async function(){if(f.length>0){if(!b){b=!0;let e=f.shift();await async function(e){if(s=!0,await Pe(e)){switch(e.type){case"camera":{let t=Communicator.Camera.fromJson(e.camera);"camera"==e.type&&e.synced&&w&&(await o.view.setCamera(t),X("camera",{camera:t.toJson(),synced:!1}))}break;case"setprojectionmode":w&&await o.view.setProjectionModeCollab(e.projectionmode);break;case"selection":if(C){let t=e.selection;o.selectionManager.clear();let a=[];for(let e=0;e<t.length;e++){let i,n,l;if(t[e].faceEntity&&(i=Communicator.Selection.FaceEntity.fromJson(t[e].faceEntity)),t[e].lineEntity&&(n=Communicator.Selection.LineEntity.fromJson(t[e].lineEntity)),t[e].pointEntity&&(l=Communicator.Selection.PointEntity.fromJson(t[e].pointEntity)),o._modelStructure._assemblyTree.lookupAnyTreeNode(O(t[e].nodeId))){let o=new Communicator.Selection.SelectionItem.create(O(t[e].nodeId),null,i,n,l);a.push(o)}}for(let e=0;e<a.length;e++)await o.selectionManager.add(a[e])}break;case"setdrawmode":await o.view.setDrawModeCollab(e.drawmode);break;case"activatemarkupview":o.unsetCallbacks({camera:Y}),await o.markupManager.activateMarkupViewWithPromise(e.id,0),o.setCallbacks({camera:Y});break;case"markup":o.unsetCallbacks({viewCreated:he}),o.unsetCallbacks({redlineCreated:he}),o.markupManager.deleteMarkupView(e.id),await o.markupManager.loadMarkupData(e.info),e.id&&o.markupManager.activateMarkupView(e.id),o.markupManager.refreshMarkup(),o.setCallbacks({viewCreated:he}),o.setCallbacks({redlineCreated:he});break;case"loadsubtree":o.unsetCallbacks({camera:Y}),await hwv.model.loadSubtreeFromScsFileCollab(e.a,e.b,e.c),o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),o.setCallbacks({camera:Y});break;case"visibility":await o.model.setNodesVisibilityCollab(e.nodeids,e.onoff);break;case"createmesh":{let t=function(e){let t=new Communicator.MeshData;t.setFaceWinding(e._faceWinding);for(let a=0;a<e._faceMeshData.length;a++){let o=e._faceMeshData[a];t.addFaces(o.vertexData,o.normalData)}return t}(e.meshdata),a=await o.model.createMesh(t);e.uniqueid&&S(a[1],e.uniqueid)}break;case"createmeshinstance":{let t=O(e.nodeid),a=function(e){var t;e._meshId[1]=(t=e._meshId[1],x[t]?x[t]:t);let a=new Communicator.MeshInstanceData(e._meshId);return e._faceColor&&a.setFaceColor(new Communicator.Color(e._faceColor.r,e._faceColor.g,e._faceColor.b)),a}(e.meshinstancedata),i=await o.model.createMeshInstance(a,t);e.uniqueid&&N(i,e.uniqueid)}break;case"createnode":{let t=O(e.parentnodeid),a=o.model.createNode(t,e.nodename,e.nodeid,e.localMatrix,e.visibility,e.measurementUnits);e.uniqueid&&N(a,e.uniqueid)}break;case"opacity":try{await o.model.setNodesOpacityCollab(e.nodeids,e.opacity)}catch(e){}break;case"metallicroughness":try{await o.model.setMetallicRoughnessCollab(e.nodeids,e.metallic,e.roughness)}catch(e){}break;case"unsetmetallicroughness":try{await o.model.unsetMetallicRoughness(e.nodeids)}catch(e){}break;case"facecolor":try{await o.model.setNodesFaceColorCollab(e.nodeids,Communicator.Color.fromJson(e.color))}catch(e){}break;case"unsetfacecolor":try{await o.model.unsetNodesFaceColorCollab(e.nodeids)}catch(e){}break;case"resetopacity":await o.model.resetNodesOpacityCollab(e.nodeids,e.opacity);break;case"setInstanceModifier":try{await o.model.setInstanceModifierCollab(e.nodeid,e.modifier)}catch(e){}break;case"explodemagnitude":await o.explodeManager.setMagnitudeCollab(e.magnitude);break;case"resetvisibilities":await o.model.resetNodesVisibilityCollab();break;case"reset":await o.model.resetCollab();break;case"clear":o.unsetCallbacks({camera:Y}),await o.model.clearCollab(),o._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,o.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),o.setCallbacks({camera:Y});break;case"matrix":{let t=O(e.nodeid);await o.model.setNodeMatrixCollab(t,Communicator.Matrix.fromJson(e.matrix))}break;case"isolate":await o.view.isolateNodesCollab(e.nodeids,0,null!=e.fitNodes?e.fitNodes:void 0,null!=e.initiallyHidden?e.initiallyHidden:void 0);break;case"cadview":await o.model.activateCadViewCollab(e.nodeid,0);break;case"cuttingsection":{let t=o.cuttingManager.getCuttingSection(e.id);e.active?await t.fromJson(e.csinfo):t.deactivateCollab()}break;case"minimizebrowser":await u._modelBrowser._minimizeModelBrowser();break;case"maximizebrowser":await u._modelBrowser._maximizeModelBrowser()}s=!1}else s=!1}(e),b=!1}}else clearInterval(e),e=null}),10)}}(JSON.parse(e))})),n.on("initialState",(function(e){let t=JSON.parse(e);if(t.type="initialState",Pe(t)&&t.camera){let e=Communicator.Camera.fromJson(t.camera);o.view.setCamera(e)}})),n.on("sendInitialState",(function(e){let t={type:"sendInitialState",camera:o.view.getCamera().toJson()};Pe(t)&&n.emit("initialState",JSON.stringify({recepient:e,state:t}))})),n.on("lockSession",(function(e){Pe({user:e,type:"lockSession"})&&(d=e,c=!0)})),n.on("unlockSession",(function(e){Pe({type:"unlockSession"})&&(c=!1)})),n.on("disconnect",(()=>{d="",c=!1,D(),Pe({type:"connectionLost"})})),n.on("disconnected",(function(e){e==d&&1==c&&(d="",c=!1),Pe({user:e,type:"disconnected"})})),n.on("chatmessage",(function(e){let t=JSON.parse(e);t.type="chatmessage",Pe(t)})),n.on("userlist",(async function(e){let t=JSON.parse(e);t.type="userlist";for(let e in p)p[e].delete=!0;for(let e=0;e<t.roomusers.length;e++){let a=t.roomusers[e].id;p[a]||(p[a]=t.roomusers[e],p[a].color=g[y++],y>=g.length&&(y=0)),p[a].delete=!1}if(await Pe({type:"predelete",message:t})){for(let e in p)p[e].delete&&delete p[e];Pe(t)}}))}hcCollab=t})();