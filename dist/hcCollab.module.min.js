var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{U6:()=>r,lj:()=>l,bA:()=>n,$j:()=>Ke,zP:()=>se,$:()=>ae,CS:()=>oe,pw:()=>re,vy:()=>ne,Gi:()=>he,uI:()=>ie,hy:()=>pe,lc:()=>ee,CD:()=>Q,wI:()=>Y,j2:()=>Ye,Nk:()=>W,$T:()=>le,dj:()=>_e,O5:()=>ge,IA:()=>te,XG:()=>me,Br:()=>Z,Al:()=>K,yx:()=>j,Vt:()=>ce,f4:()=>de,jX:()=>ue});class i{constructor(e,t=new Communicator.Color(255,0,0),i=new Communicator.Color(255,0,0),a=.1,s=!0,o=!1,n){this._manager=e,this._node=null,this._currentCamera=null,this._lineColor=t,this._faceColor=i,this._faceOpacity=a,this._renderFaces=s,this._suppressScale=o,this._fixedLength=n}async update(e,t=this._manager._viewer.view.getCanvasSize()){if(!this._node){let e=new Communicator.MeshInstanceData(this._manager._frustumMesh),t=new Communicator.MeshInstanceData(this._manager._frustumMeshLines);if(this._node=this._manager._viewer.model.createNode(this._manager.node),this._renderFaces){let t=await this._manager._viewer.model.createMeshInstance(e,this._node,!0);await this._manager._viewer.model.setNodesOpacity([t],this._faceOpacity),await this._manager._viewer.model.setNodesFaceColor([t],this._faceColor)}let i=await this._manager._viewer.model.createMeshInstance(t,this._node,!0);await this._manager._viewer.model.setNodesLineColor([i],this._lineColor),await this._manager._viewer.model.setNodesLinePattern([i],[1,0],.05,Communicator.LinePatternLengthUnit.Object),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotSelect,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.ExcludeBounding,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotCut,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotExplode,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[this._node],!0),this._suppressScale&&this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[this._node],!0)}let i,a,s,o,n,r=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).normalize(),l=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).length(),d=new Communicator.Matrix,c=e.getPosition(),u=new Communicator.Matrix;if(this._suppressScale)null==this._fixedLength&&(i=.2),a=i/2,s=i/2,l=i;else if(a=e.getWidth(),s=e.getHeight(),this._fixedLength){let e=l/this._fixedLength;a/=e,s/=e,l=this._fixedLength}let h=t.x/t.y;h>=1?(o=a*h,n=s):(o=a,n=s/h),u.setTranslationComponent(c.x,c.y,c.z),d.setScaleComponent(o,n,l);let m=this.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(0,0,1),r),p=m.transform(new Communicator.Point3(0,1,0)),_=this.ComputeVectorToVectorRotationMatrix(p,e.getUp()),g=Communicator.Matrix.multiply(d,m),w=Communicator.Matrix.multiply(g,_),x=Communicator.Matrix.multiply(w,u);await this._manager._viewer.model.setNodeMatrix(this._node,x),this._currentCamera=e.copy(),this._currentCanvasSize=t}async flush(){this._manager._viewer.model.deleteNode(this._node),this._node=null}getCamera(){return this._currentCamera}ComputeVectorToVectorRotationMatrix(e,t){const i=1e-7;e.normalize(),t.normalize();let a=Communicator.Point3.cross(e,t),s=Communicator.Point3.dot(e,t),o=a.length();if(o>-1e-7&&o<i){if(!(s<0))return new Communicator.Matrix;if(e.x<-1e-7||e.x>i)a.x=e.y,a.y=-e.x,a.z=0;else if(e.y<-1e-7||e.y>i)a.x=-e.y,a.y=e.x,a.z=0;else{if(!(e.z<-1e-7||e.z>i))return new Communicator.Matrix;a.x=-e.z,a.z=e.x,a.y=0}}var n=Math.atan2(o,s);return n*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(a,n)}}class a{constructor(e){this._viewer=e,this._widgets=[],this._node=null}async initialize(){this._node=this._viewer.model.createNode(),await this._createFrustumMesh()}deactivate(){this._node=null}isActive(){return null!=this._node}async _createFrustumMesh(e){let t=[0,0,0,-.5,-.5,1,.5,-.5,1,0,0,0,.5,-.5,1,.5,.5,1,0,0,0,-.5,.5,1,.5,.5,1,0,0,0,-.5,.5,1,-.5,-.5,1],i=[];for(let e=0;e<4;e++){let a=Communicator.Plane.createFromPoints(new Communicator.Point3(t[9*e],t[9*e+1],t[9*e+2]),new Communicator.Point3(t[9*e+3],t[9*e+4],t[9*e+5]),new Communicator.Point3(t[9*e+6],t[9*e+7],t[9*e+8]));for(let e=0;e<3;e++)i.push(-a.normal.x),i.push(-a.normal.y),i.push(-a.normal.z)}var a=new Communicator.MeshData;a.setFaceWinding(Communicator.FaceWinding.Unknown),a.addFaces(t,i),this._frustumMesh=await this._viewer.model.createMesh(a);let s=[[0,0,0,-.5,-.5,1,.5,-.5,1],[0,0,0,.5,-.5,1,.5,.5,1],[0,0,0,-.5,.5,1,.5,.5,1],[0,0,0,-.5,.5,1,-.5,-.5,1],[0,0,0,.5,.5,1]];var o=new Communicator.MeshData;for(let e=0;e<s.length;e++)o.addPolyline(s[e]);this._frustumMeshLines=await this._viewer.model.createMesh(o)}add(e){this._widgets.push(e),e.update(this._viewer.view.getCamera())}}class s{constructor(e){this._viewer=e,this._meshHash=[],this._spriteNode=this._viewer.model.createNode(this._viewer.model.getAbsoluteRootNode(),"sprites"),this._imageHash=[],this._sprites=[],this._alwaysInFront=!0,this._lastCamPosition=new Communicator.Point3(0,0,0),this._lastCheckDate=new Date,this._updateVisibilities(),this._nativeSpriteCounter=1111111111,this._nativeSpriteContainer="",this._wasDragged=!1,this._spriteClickedEvent=null;let t=this;this._viewer.setCallbacks({camera:function(e){t._updateDOMSprites(e)}})}setSpriteClickedEvent(e){this._spriteClickedEvent=e}_updateDOMSprite(e,t){let i,a,s=this._viewer.view.projectPoint(e.center,t);i=null==e.offsetdata.x?-e.offsetdata.width/2:e.offsetdata.x+e.offsetdata.width/2*(1-e.scale),a=null==e.offsetdata.y?-e.offsetdata.height/2:e.offsetdata.y+e.offsetdata.height/2*(1-e.scale),$("#"+e.nodeid).css({left:s.x+i+"px",top:s.y+a+"px",position:"absolute"})}_updateDOMSprites(e){for(let t in this._sprites)if(this._sprites[t].isNative){let i=this._sprites[t];this._updateDOMSprite(i,e)}}setNativeSpriteContainer(e){this._nativeSpriteContainer=e;let t=this;$("#"+this._nativeSpriteContainer).mousemove((function(e){if(1==e.which&&(t._wasDragged=!0,t._movedSprite&&t._movedSprite.allowDrag)){let i=new Communicator.Point2(t._startDown.x+(e.offsetX-t._startDown.x),t._startDown.y+(e.offsetY-t._startDown.y)),a=t._viewer.view.getCamera(),s=a.getPosition(),o=a.getTarget(),n=Communicator.Point3.subtract(o,s).normalize(),r=Communicator.Plane.createFromPointAndNormal(t._movedSprite.center,n),l=new Communicator.Point3,d=t._viewer.view.raycastFromPoint(new Communicator.Point2(i.x,i.y)),c=null;c=r.intersectsRay(d,l),c&&(t._movedSprite.center.x=l.x,t._movedSprite.center.y=l.y,t._movedSprite.center.z=l.z),t._updateDOMSprite(t._movedSprite,t._viewer.view.getCamera())}})),$(window).mouseup((function(e){if(1==e.which&&($("#"+t._nativeSpriteContainer).css("pointer-events","none"),t._movedSprite)){!t._wasDragged&&t._spriteClickedEvent&&t._spriteClickedEvent(t._movedSprite),$("#"+t._movedSprite.nodeid).css("box-shadow",""),t._movedSprite=null;for(let e in t._sprites)t._sprites[e].isNative&&$("#"+e).css("pointer-events","all")}}))}_getImage(e){return new Promise(((t,i)=>{var a=new Image;a.crossOrigin="anonymous",a.addEventListener("load",(function(){t({img:a,dims:new Communicator.Point2(this.naturalWidth,this.naturalHeight)})})),a.src=e}))}_getDataUrl(e){const t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),t.toDataURL("image/png")}async _updateDynamicImage(e){let t=$("#"+e).find("canvas")[0];return t||(t=await html2canvas(document.querySelector("#"+e),{onclone:function(t){t.querySelector("#"+e).style.display="block"}})),{durl:t.toDataURL("image/png"),dims:{x:t.width,y:t.height}}}_convertDataURIToBinary(e){var t=e.indexOf(";base64,")+8,i=window.atob(e.substring(t));return Uint8Array.from(Array.prototype.map.call(i,(function(e){return e.charCodeAt(0)})))}async addImage(e,t,i,a){var s;s=null==t?e:t;var o=await this._getImage(s),n=this._convertDataURIToBinary(this._getDataUrl(o.img)),r={format:Communicator.ImageFormat.Png,data:n};let l="none";l=null!=i||null!=a?i+"@"+a:"none",null==i&&(i=0),null==a&&(a=0);var d=this._meshHash[l];null==d&&(d=await this._createSpriteMesh(-i/o.dims.x,-a/o.dims.y),this._meshHash[l]=d);var c=await this._viewer.model.createImage(r);this._imageHash[e]={id:c,mesh:d,dims:{width:o.dims.x,height:o.dims.y},offsetx:i,offsety:a}}async updateDynamicSprites(e){let t=this._imageHash[e],i=t.id,a=await this._updateDynamicImage(e),s=this._convertDataURIToBinary(a.durl);var o={format:Communicator.ImageFormat.Png,data:s};let n=await this._viewer.model.createImage(o),r=[];for(let t in this._sprites)if(this._sprites[t].type==e){let e=this._viewer.model.getNodeChildren(parseInt(t));0==this._sprites[t].flip?(r.push(e[1]),this._sprites[t].flip=1,setTimeout((()=>{this._viewer.model.setNodesVisibility([e[0]],!1),this._viewer.model.setNodesVisibility([e[1]],!0)}),100)):(r.push(e[0]),this._sprites[t].flip=0,setTimeout((()=>{this._viewer.model.setNodesVisibility([e[1]],!1),this._viewer.model.setNodesVisibility([e[0]],!0)}),100))}await this._viewer.model.setNodesTexture(r,{imageId:n}),await this._viewer.model.deleteImages([i]),t.id=n}async _addDOMImage(e,t){if(this._imageHash[e])t.width=this._imageHash[e].dims.width,t.height=this._imageHash[e].dims.height;else{let i=await this._getImage(e);t.width=i.dims.x,t.height=i.dims.y,this._imageHash[e]={id:null,mesh:null,dims:t}}let i="image-"+this._nativeSpriteCounter++,a='<div id="'+i+'" style="position:absolute"><img src="'+e+'"></div>';return $("#"+this._nativeSpriteContainer).append(a),$("#"+i).css("display","block"),$("#"+i).css("z-index","20000"),$("#"+i).css("pointer-events","all"),i}_addDOMDiv(e,t,i,a){let s=e+"-clone-"+this._nativeSpriteCounter++,o='<div id="'+s+'"></div>';$("#"+this._nativeSpriteContainer).append(o);let n=$("#"+s);if(n.css("display","block"),n.css("z-index","20000"),n.css("pointer-events","all"),n.css("width",i+"px"),n.css("height",a+"px"),t)return $("#"+e).appendTo(n),s;let r=$("#"+e).clone();r.removeAttr("id");let l=$("#"+e).find("canvas")[0];return l&&r.find("canvas")[0].getContext("2d").drawImage(l,0,0),n.append(r),s}async _addDynamicImage(e,t,i){let a=await this._updateDynamicImage(e),s=this._convertDataURIToBinary(a.durl);var o={format:Communicator.ImageFormat.Png,data:s},n="none";null==t&&null==i||(null==t&&(t=0),null==i&&(i=0),n=t+"@"+i);var r=this._meshHash[n];null==r&&(r=await this._createSpriteMesh(t,i),this._meshHash[n]=r);var l=await this._viewer.model.createImage(o);this._imageHash[e]={id:l,mesh:r,dims:{width:a.dims.x,height:a.dims.y}}}async _createSpriteMesh(e,t){var i=new Communicator.MeshData;i.setFaceWinding(Communicator.FaceWinding.Clockwise);var a=0,s=0;return null!=e&&(a=e),null!=t&&(s=t),i.addFaces([-1+a,-1+s,0,-1+a,1+s,0,1+a,1+s,0,-1+a,-1+s,0,1+a,1+s,0,1+a,-1+s,0],null,null,[0,0,0,1,1,1,0,0,1,1,1,0]),await this._viewer.model.createMesh(i)}async _setupInstance(e,t,i){let a=new Communicator.MeshInstanceData(e),s=await this._viewer.model.createMeshInstance(a,t);return this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.AlwaysDraw,[s],!0),i||this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.ScreenOriented,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotCut,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotXRay,[s],!0),i||(this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[s],!0),this._viewer.model.setDepthRange([s],0,.1)),s}async _createSpriteInstance(e,t,i,a){let s;if(t){s=parseInt(t);let e=this._viewer.model.getNodeChildren(s);for(let t=0;t<e.length;t++)hwv.model.deleteNode(e[t])}else s=this._viewer.model.createNode(this._spriteNode);if(await this._setupInstance(e,s,i),a){let t=await this._setupInstance(e,s,i);this._viewer.model.setNodesVisibility([t],!1)}return s}async createDOMSprite(e,t,i=1,a=!1,s=!1,n=null,r=null,l,d){let c,u={};s?c=await this._addDOMImage(e,u):(u={},u.width=$("#"+e).width(),u.height=$("#"+e).height(),c=this._addDOMDiv(e,a,u.width,u.height));let h=this;return $("#"+c).mousedown((function(e){if(1==e.which){h._wasDragged=!1,$("#"+h._nativeSpriteContainer).css("pointer-events","auto"),h._movedSprite=h._sprites[c],h._startDown=new Communicator.Point2(e.offsetX,e.offsetY,0);let t=$("#"+c).position();h._initialPos=new Communicator.Point2(t.left,t.top),$("#"+h._movedSprite.nodeid).css("box-shadow","0 0 5px #ffff00, 0 0 10px #ffff00, 0 0 15px #ffff00, 0 0 20px #ffff00");for(let e in h._sprites)h._sprites[e].isNative&&$("#"+e).css("pointer-events","none")}})),null!=n&&$("#"+c).css("display","none"),this._imageHash[e]&&this._imageHash[e].offsetx?u.x=this._imageHash[e].offsetx:u.x=l,this._imageHash[e]&&this._imageHash[e].offsety?u.y=this._imageHash[e].offsety:u.x=d,i&&$("#"+c).css("transform","scale("+i+")"),this._sprites[c]=new o(this,c,t,i,e,n,r,a,!0,u),this._updateDOMSprites(this._viewer.view.getCamera()),this._sprites[c]}async createSprite(e,t,i=1,a=!1,s=null,n=null,r=!1,l=null,d,c){let u;if(a?null==this._imageHash[e]&&await this._addDynamicImage(e,d,c):null==this._imageHash[e]&&await this.addImage(e,void 0,d,c),u=await this._createSpriteInstance(this._imageHash[e].mesh,void 0,r,a),null!=s&&this._viewer.model.setNodesVisibility([u],!1),l)this._viewer.model.setNodeMatrix(u,l);else{var h=new Communicator.Matrix,m=new Communicator.Matrix;let a=i,s=i;var p=this._imageHash[e].dims.width/this._imageHash[e].dims.height;p>1&&(s=i,a=i*p),p<1&&(a=i*p,s=i),m.setScaleComponent(a,s,1),h.setTranslationComponent(t.x,t.y,t.z);var _=Communicator.Matrix.multiply(m,h);this._viewer.model.setNodeMatrix(u,_)}if(a){let t=this._viewer.model.getNodeChildren(u);await this._viewer.model.setNodesTexture([t[0]],{imageId:this._imageHash[e].id})}else await this._viewer.model.setNodesTexture([u],{imageId:this._imageHash[e].id});return this._sprites[u]=new o(this,u,t,i,e,s,n,a,!1),this._sprites[u].set3D(l),this._sprites[u]}flushAll(){for(let e in this._sprites)this._sprites[e].flush();this._sprites=[]}flush(e){this._sprites[e].flush(),delete this._sprites[e]}hideAll(){for(var e in this._sprites)this._sprites[e].hide()}showAll(){for(var e in this._sprites)this._sprites[e].show()}handleResize(){for(let e in this._sprites)this._sprites[e].redraw()}findFromNodeId(e){var t=this._sprites[e];if(null==t){var i=hwv.model.getNodeParent(e);t=this._sprites[i]}return t}getAlwaysInFront(){return this._alwaysInFront}setAlwaysInFront(e){this._alwaysInFront=e;for(let t in this._sprites)e||null!=this._sprites[t].range?this._viewer.model.setDepthRange([parseInt(t)],0,.1):this._viewer.model.unsetDepthRange([parseInt(t)])}_updateVisibilities(){var e=this;setInterval((function(){new Date;var t=e._viewer.view.getCamera().getPosition();e._lastCamPosition=t.copy(),e._lastCheckDate=new Date,e._lastCheckDate=void 0;for(let s in e._sprites){let o=e._sprites[s];if(null!=o.range&&!o.hidden){var i=Communicator.Point3.subtract(t,o.center).length(),a=parseInt(s);if(o.isNative)i<o.range?$("#"+s).css("display","block"):$("#"+s).css("display","none");else{let t=e._viewer.model.getNodeChildren(a);i<o.range?e._viewer.model.getNodeVisibility(t[e._sprites[s].flip])||e._viewer.model.setNodesVisibility([t[e._sprites[s].flip]],!0):e._viewer.model.getNodeVisibility(t[e._sprites[s].flip])&&e._viewer.model.setNodesVisibility([t[e._sprites[s].flip]],!1)}}}}),200)}}class o{constructor(e,t,i,a,s,o,n,r,l,d){this._manager=e,this.nodeid=t,this.range=o,this.center=i,this.scale=a,this.type=s,this.payload=n,this.dynamic=r,this.isNative=l,this.offsetdata=d,this.hidden=!1,this.flip=0,this.matrix=null,this.allowDrag=!1}set3D(e){this.matrix=e}getIs3D(){return null!=this.matrix}setAllowDrag(e){this.allowDrag=e}hide(){this._manager._viewer.model.setNodesVisibility([this.nodeid],!1)}flush(){this.isNative?$("#"+this.nodeid).remove():this.dynamic||this._manager._viewer.model.deleteNode(this.nodeid)}show(){this._manager._viewer.model.setNodesVisibility([this.nodeid],!0)}async setPosition(e){this.center=e.copy(),this.isNative&&await this._manager._updateDOMSprite(this,this._manager._viewer.view.getCamera())}async redraw(){this.isNative&&await this._manager._updateDOMSprite(this,this._manager._viewer.view.getCamera())}async setType(e,t){if(this.type!=e){if(this.type=e,this.isNative){let i={};i.width=this._manager._imageHash[e].dims.width,i.height=this._manager._imageHash[e].dims.height,this.offsetdata=i,null==t&&(t=this.scale);let a=$("#"+this.nodeid).children()[0],s=this;return $(a).bind("load",(function(){$("#"+s.nodeid).css("z-index","20000"),$("#"+s.nodeid).css("pointer-events","all"),$("#"+s.nodeid).css("transform","scale("+t+")"),s._manager._updateDOMSprite(s,s._manager._viewer.view.getCamera()),$("#"+s.nodeid).css("display","block")})),$("#"+this.nodeid).css("display","none"),void $(a).attr("src",e)}if(await this._manager._createSpriteInstance(this._manager._imageHash[e].mesh,this.nodeid,this.getIs3D(),this.dynamic),this._manager._sprites.matrix)this._manager._viewer.model.setNodeMatrix(this.nodeid,matrix);else if(t){let n=this._manager._sprites[this.nodeid].center;var i=new Communicator.Matrix,a=new Communicator.Matrix;let r=t,l=t;var s=this._manager._imageHash[e].dims.width/this._manager._imageHash[e].dims.height;s>1&&(l*=1/s),s<1&&(r*=s),a.setScaleComponent(r,l,1),i.setTranslationComponent(n.x,n.y,n.z);var o=Communicator.Matrix.multiply(a,i);this._manager._viewer.model.setNodeMatrix(this.nodeid,o)}await this._manager._viewer.model.setNodesTexture([this.nodeid],{imageId:this._manager._imageHash[e].id})}}}class n{constructor(e,t=!0){this._viewer=e,this._markups=[],this._useMarkupManager=t,this._markupUpdatedCallback=null;let i=this;this._useMarkupManager||(new ResizeObserver((function(){setTimeout((function(){i.refreshMarkup()}),250)})).observe(this._viewer.getViewElement()),this._viewer.setCallbacks({camera:function(){setTimeout((function(){i.refreshMarkup()}),0)}}))}setMarkupUpdatedCallback(e){this._markupUpdatedCallback=e}getMarkupUpdatedCallback(){return this._markupUpdatedCallback}handleResize(){if(!this._useMarkupManager){let e=this;setTimeout((function(){e.refreshMarkup()}),0)}}setUseMarkupManager(e){this._useMarkupManager=e}getUseMarkupManager(){return this._useMarkupManager}add(e){if(this._markups.push(e),this._useMarkupManager){let t=this._viewer.markupManager.registerMarkup(e);e.setMarkupId(t)}}delete(e){for(let t=0;t<this._markups.length;t++)if(this._markups[t].getUniqueId()==e){this.getMarkupUpdatedCallback()&&this.getMarkupUpdatedCallback()(this._markups[t],!0),this._viewer.markupManager.unregisterMarkup(this._markups[t].getMarkupId()),this._markups[t].destroy(),this._markups.splice(t,1);break}}getByID(e){for(let t=0;t<this._markups.length;t++)if(this._markups[t].getUniqueId()==e)return this._markups[t]}getSelected(){for(let e=0;e<this._markups.length;e++)if(this._markups[e].getSelected())return this._markups[e]}exportMarkup(){let e=[];for(let t=0;t<this._markups.length;t++)e.push(this._markups[t].toJson());return e}refreshMarkup(){if(this._useMarkupManager)this._viewer.markupManager.refreshMarkup();else for(let e=0;e<this._markups.length;e++)this._markups[e].draw()}pickMarkupItem(e){if(this._useMarkupManager)return this._viewer.markupManager.pickMarkupItem(e);for(let t=0;t<this._markups.length;t++)if(this._markups[t].hit(e))return this._markups[t];return null}loadData(e){for(let t=0;t<e.length;t++){let i=r.fromJson(this,e[t]);i.setAllowEditing(!1),this.add(i)}this.refreshMarkup()}}class r extends Communicator.Markup.MarkupItem{static fromJson(e,t){let i=new r(e,Communicator.Point3.fromJson(t.firstPoint),Communicator.Point3.fromJson(t.secondPoint),Communicator.Point3.fromJson(t.secondPointRel),t.font,t.fontSize,Communicator.Color.fromJson(t.backgroundColor),Communicator.Color.fromJson(t.circleColor),t.circleRadius,t.maxWidth,t.pinned,t.extraDivText?t.extraDivText:null,t.uniqueid,t.userdata);return i.setText(decodeURIComponent(t.text)),i.deselect(),i}static svgPointString(e){let t="";for(let i=0;i<e.length;i++)i&&(t+=" "),t+=e[i].x+","+e[i].y;return t}constructor(e,t,i=null,a=null,s="monospace",o="12px",n=new Communicator.Color(238,243,249),r=new Communicator.Color(128,128,255),l=4,d=300,c=!1,u=null,h=null,m=null){super(),this._textBoxMarkupTypeManager=e,this._viewer=e._viewer,this._font=s,this._fontSize=o,this._uniqueid=h||this._generateGUID(),this._backgroundColor=n,this._circleColor=r,this._circleRadius=l,this._firstPoint=t.copy(),this._allowEditing=!0,this._extraDivText=u,this._userdata=m,this._selected=!1,this._textHit=!0,this._maxWidth=d,this._pinned=c,this._lineGeometryShape=new Communicator.Markup.Shape.Polyline,this._circleGeometryShape=new Communicator.Markup.Shape.Circle,null!=i?this._secondPoint=i.copy():this.setSecondPoint(t.copy()),null!=a&&(this._secondPointRel=a.copy()),this._initialize()}getUserData(){return this._userdata}getSelected(){return this._selected}setAllowEditing(e){this._allowEditing=e}getAllowEditing(){return this._allowEditing}destroy(){$(this._textBoxDiv).remove(),this._textBoxMarkupTypeManager.getUseMarkupManager()||$(this._svgElement).remove()}setText(e){$(this._textBoxText).val(e),this._adjustTextBox(),this._textBoxMarkupTypeManager.refreshMarkup()}setMarkupId(e){this._markupId=e}getMarkupId(){return this._markupId}getUniqueId(){return this._uniqueid}toJson(){return{uniqueid:this._uniqueid,font:this._font,fontSize:this._fontSize,backgroundColor:this._backgroundColor.toJson(),circleColor:this._circleColor.toJson(),circleRadius:this._circleRadius,firstPoint:this._firstPoint.toJson(),secondPoint:this._secondPoint.toJson(),secondPointRel:this._secondPointRel.toJson(),maxWidth:this._maxWidth,pinned:this._pinned,allowEditing:this._allowEditing,text:this._textBoxText?encodeURIComponent($(this._textBoxText).val()):"",userdata:this._userdata}}getExtraDiv(){return this._extraTextDiv}setPinned(e){e!=this._pinned&&(this._pinned&&this.setSecondPoint(this._firstPoint),this._textBoxMarkupTypeManager.refreshMarkup(),this._pinned=e,this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this))}getPinned(){return this._pinned}setBackgroundColor(e){this._backgroundColor=e,$(this._textBoxDiv).css("background-color","rgb("+e.r+","+e.g+","+e.b+")")}setCircleColor(e){this._circleColor=e,this._textBoxMarkupTypeManager.refreshMarkup()}draw(){$(this._svgElement).empty();const e=this._viewer.markupManager.getRenderer(),t=this._viewer.view;this._lineGeometryShape.clearPoints();let i=Communicator.Point2.fromPoint3(t.projectPoint(this._firstPoint));this._lineGeometryShape.pushPoint(i),this._circleGeometryShape.setCenter(i);let a,s=this._getDivDimensions();this._pinned?a=new Communicator.Point2(this._secondPointRel.x*s.width,this._secondPointRel.y*s.height):(a=Communicator.Point2.fromPoint3(t.projectPoint(this._secondPoint)),this._secondPointRel=new Communicator.Point2(a.x/s.width,a.y/s.height));let o=parseInt($(this._textBoxDiv).css("width")),n=parseInt($(this._textBoxDiv).css("height")),r=new Communicator.Point2(0,0);i.x<=a.x+o/2?r.x=a.x:r.x=a.x+o,i.y<=a.y+n/2?r.y=a.y:r.y=a.y+n,this._lineGeometryShape.pushPoint(r),this._textBoxMarkupTypeManager.getUseMarkupManager()?(e.drawPolyline(this._lineGeometryShape),e.drawCircle(this._circleGeometryShape)):(this._addPolylineElement(this._lineGeometryShape),this._addCircleElement(this._circleGeometryShape)),$(this._textBoxDiv).css("top",a.y+"px"),$(this._textBoxDiv).css("left",a.x+"px")}hit(e){let t=parseInt($(this._textBoxDiv).css("left")),i=parseInt($(this._textBoxDiv).css("top")),a=parseInt(t)+parseInt($(this._textBoxDiv).css("width")),s=parseInt(i)+parseInt($(this._textBoxDiv).css("height"));if(e.x>=t&&e.x<=a&&e.y>=i&&e.y<=s)return this._textHit=!0,!0;if(this._extraTextDiv){let a=$(this._extraTextDiv).position();t+=a.left,i+=a.top;let s=t+parseInt($(this._extraTextDiv).css("width")),o=i+parseInt($(this._extraTextDiv).css("height"));if(e.x>=t&&e.x<=s&&e.y>=i&&e.y<=o)return this.deselect(),this._textHit=!0,!0}let o=Communicator.Point2.fromPoint3(this._viewer.view.projectPoint(this._firstPoint));return t=o.x-7,i=o.y-7,a=o.x+7,s=o.y+7,e.x>=t&&e.x<=a&&e.y>=i&&e.y<=s?(this._textHit=!1,!0):(this.deselect(),!1)}setSecondPoint(e){this._secondPoint=e.copy();let t=this._getDivDimensions(),i=this._viewer.view.projectPoint(this._secondPoint);this._secondPointRel=new Communicator.Point2(i.x/t.width,i.y/t.height),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)}setFirstPoint(e){this._firstPoint=e.copy(),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)}getSecondPoint(){return this._secondPoint.copy()}select(){this._allowEditing&&($(this._textBoxText).attr("disabled",!1),$(this._textBoxText).focus(),$(this._textBoxDiv).css("pointer-events","auto")),$(this._textBoxDiv).css("outline-width","2px"),this._selected=!0}deselect(){$(this._textBoxText).attr("disabled",!0),$(this._textBoxDiv).css("pointer-events","none"),$(this._textBoxDiv).css("outline-width","1px"),this._selected=!1}unprojectTextAnchor(){let e=this._getDivDimensions();this._secondPoint=this._viewer.view.unprojectPoint(new Communicator.Point2(this._secondPointRel.x*e.width,this._secondPointRel.y*e.height),.5),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)}_addPolylineElement(e){let t=r.svgPointString(e.getPoints()),i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",t),i.setAttributeNS(null,"fill","none"),i.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),i.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(i)}_addCircleElement(e){let t=e.getCenter(),i=e.getRadius(),a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttributeNS(null,"cx",t.x.toString()),a.setAttributeNS(null,"cy",t.y.toString()),a.setAttributeNS(null,"r",i.toString()),a.setAttributeNS(null,"fill","rgb("+this._circleColor.r+","+this._circleColor.g+","+this._circleColor.b+")"),a.setAttributeNS(null,"fill-opacity","1"),a.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),a.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(a)}_initialize(){this._lineGeometryShape.setStrokeWidth(1),this._circleGeometryShape.setFillColor(this._circleColor),this._circleGeometryShape.setRadius(this._circleRadius),this._setupTextDiv()}_setupTextDiv(){let e="";e+='<div id="'+this._uniqueid+'" style="z-index:1;max-width:'+this._maxWidth+"px;display:flex;outline-style:solid;outline-width:2px;position: absolute;",e+="top:0px; left: 0px;width:100px;outline-color: rgb(76, 135, 190);background-color: rgb("+this._backgroundColor.r+","+this._backgroundColor.g+","+this._backgroundColor.b+');">',e+='<textarea autofocus style="max-width:'+this._maxWidth+"px;margin: 1px 0px 3px 3px; resize: none;font-family:"+this._font+";font-size:"+this._fontSize+";height:"+(parseInt(this._fontSize)+3)+'px;position: relative;outline: none;border: none;word-break: break-word;padding: 0 0 0 0;background-color: transparent;width: 100px;flex-grow: 1;overflow: hidden;"></textarea>',e+="</div>",$("#measurecanvas").length||($("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="measurecanvas" width="420px" height="150px;"></canvas></div>'),document.getElementById("measurecanvas").getContext("2d").font=this._fontSize+" "+this._font),$(this._viewer.getViewElement().parentElement).append(e),this._textBoxDiv=$("#"+this._uniqueid),this._textBoxText=$(this._textBoxDiv).children()[0],this._extraDivText&&($(this._textBoxDiv).append(this._extraDivText),this._extraTextDiv=$(this._textBoxDiv).children()[1]),this._textBoxMarkupTypeManager.getUseMarkupManager()||(this._svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._viewer.getViewElement().parentElement.appendChild(this._svgElement),$(this._svgElement).css("position","absolute"),$(this._svgElement).css("pointer-events","none"),$(this._svgElement).css("width","100%"),$(this._svgElement).css("height","100%")),$(this._textBoxText).on("input",(e=>{this._adjustTextBox(),this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()&&this._textBoxMarkupTypeManager.getMarkupUpdatedCallback()(this)})),this.select()}_adjustTextBox(){let e=this._calculateMaxTextWidth();$(this._textBoxDiv).css("width",e.width+"px"),$(this._textBoxText).css("height","0px"),$(this._textBoxText).css("height",$(this._textBoxText)[0].scrollHeight+"px"),this._textBoxMarkupTypeManager.refreshMarkup()}_calculateMaxTextWidth(){let e=document.getElementById("measurecanvas").getContext("2d"),t=$(this._textBoxText).val().split("\n"),i=0;for(let a=0;a<t.length;a++){let s=e.measureText(t[a]);s.width>i&&(i=s.width)}return i<90&&(i=90),{width:i+10}}_getDivDimensions(){return{width:$(this._viewer.getViewElement()).outerWidth(),height:$(this._viewer.getViewElement()).outerHeight()}}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}class l{constructor(e,t=null){this._viewer=e,t?this._textBoxMarkupTypeManager=t:(this._textBoxMarkupTypeManager=new n(this._viewer),this._viewer.markupManager.registerMarkupTypeManager("TextBox",this._textBoxMarkupTypeManager)),this._allowCreation=2,this._createMarkupItemCallback=null,this._mouseActivationCallback=null}setAllowCreation(e){this._allowCreation=e}getTextBoxTypeManager(){return this._textBoxMarkupTypeManager}setCreateMarkupItemCallback(e){this._createMarkupItemCallback=e}setMouseActivationCallback(e){this._mouseActivationCallback=e}onMouseDown(e){if(this._handled=!1,!this._mouseActivationCallback&&e.getButton()==Communicator.Button.Left||this._mouseActivationCallback&&this._mouseActivationCallback(e)){const t=this._textBoxMarkupTypeManager.pickMarkupItem(e.getPosition());t&&t instanceof r?(t.getPinned()&&t.unprojectTextAnchor(),this._offset=Communicator.Point2.subtract(e.getPosition(),this._viewer.view.projectPoint(t.getSecondPoint())),this._dClickTime=new Date,this._activeMarkupItem=t,this._handled=!0):this._allowCreation&&(this._addMarkupItem(e.getPosition()),1==this._allowCreation&&(this._allowCreation=0))}e.setHandled(this._handled)}onMouseMove(e){this._dClickTime=null,e.setHandled(this._handled),null!==this._activeMarkupItem&&this._handled&&this._updateActiveMarkupItem(e.getPosition())}onMouseUp(e){null!==this._dClickTime&&this._activeMarkupItem.select(),this._dClickTime=null,e.setHandled(this._handled),this._activeMarkupItem=null}async _addMarkupItem(e){const t=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),a=await this._viewer.view.pickFromPoint(e,i);if(null===a||a.overlayIndex())return;const s=a.getNodeId(),o=a.getPosition(),n=a.getFaceEntity();null!==s&&null!==o&&null!==n&&null!==t.getNodeParent(s)&&(this._createMarkupItemCallback?this._activeMarkupItem=this._createMarkupItemCallback(this._textBoxMarkupTypeManager,o):this._activeMarkupItem=new r(this._textBoxMarkupTypeManager,o),this._textBoxMarkupTypeManager.add(this._activeMarkupItem),this._offset=new Communicator.Point2(0,0),this._updateActiveMarkupItem(e),this._handled=!0)}async _updateActiveMarkupItem(e){if(null===this._activeMarkupItem)return;if(!this._activeMarkupItem._textHit){const t=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),a=await this._viewer.view.pickFromPoint(e,i);if(null===a||a.overlayIndex())return;const s=a.getNodeId(),o=a.getPosition(),n=a.getFaceEntity();let r=!0;if(null!==s&&null!==o&&null!==n||(r=!1),null===t.getNodeParent(s)&&(r=!1),r)this._activeMarkupItem.setFirstPoint(o);else{let t=this._viewer.view.getCamera(),i=t.getPosition(),a=t.getTarget(),s=Communicator.Point3.subtract(a,i).normalize(),o=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),s),n=new Communicator.Point3,r=this._viewer.view.raycastFromPoint(new Communicator.Point2(e.x,e.y)),l=null;l=o.intersectsRay(r,n),l&&this._activeMarkupItem.setFirstPoint(new Communicator.Point3(n.x,n.y,n.z))}return void this._textBoxMarkupTypeManager.refreshMarkup()}let t=this._viewer.view.getCamera(),i=t.getPosition(),a=t.getTarget(),s=Communicator.Point3.subtract(a,i).normalize(),o=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),s),n=new Communicator.Point3,r=this._viewer.view.raycastFromPoint(new Communicator.Point2(e.x-this._offset.x,e.y-this._offset.y)),l=null;l=o.intersectsRay(r,n),l&&(this._activeMarkupItem.setSecondPoint(new Communicator.Point3(n.x,n.y,n.z)),this._textBoxMarkupTypeManager.refreshMarkup())}}var d,c,u,h,m=null,p=!1,_=!1,g=!1,w=!1,x="",f=null,v=null,C=[],y=!1,M=!0,k=!0,b=!1,P=null,I=null,S=null,N=[],D=[[210,210,255],[210,255,210],[255,210,210],[255,0,255],[0,255,255],[255,128,0],[128,255,0],[0,255,128],[0,128,255],[128,0,255],[255,0,128],[255,128,128],[128,255,128],[128,128,255],[255,128,255],[255,255,128],[128,255,255],[255,255,255]],T=0;function B(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var O,E,z=[],F=[],A=[],R=[];function U(e){let t=$(e.getExtraDiv()).children()[2];e.getPinned()?($($(t).children()[0]).css("background-color","black"),$(t).prop("title","Unpin")):($($(t).children()[0]).css("background-color","white"),$(t).prop("title","Pin"))}function J(e){let t="";t+='<div style="overflow:hidden;pointer-events:none;max-width:300px;position:absolute;left:0px;top:-18px;min-width:50px;width:inherit;height:15px;',t+='outline-width:inherit;outline-style:solid;background-color:white;background: linear-gradient(90deg, #ada9d9, transparent);font-size:12px;font-weight:bold"><div style="overflow:hidden;width:calc(100% - 23px)">'+e+"</div>",t+='<div title = "Delete" style="pointer-events:all;position:absolute;right:0px;top:0px;width:10px;font-size:10px;outline-style:solid;outline-width:1px;padding-left:1px;height:inherit;cursor:pointer">&#x2715</div>;',t+='<div title = "Unpin" style="pointer-events:all;position:absolute;right:13px;top:0px;width:10px;font-size:10px;outline-style:solid;outline-width:1px;padding-left:1px;height:inherit;cursor:pointer"><span style="pointer-events:none;height:7px;width:7px;top:4px;left:2px;position:absolute;outline-color:black;outline-style:solid;outline-width:1px;border-radius:50%;display:inline-block;background-color:black"></span></div>;',t+="</div>";let i=$(t);$("body").append(i);let a=$(i).children()[1];$(a).on("click",(e=>{I.delete(e.target.parentElement.parentElement.id),I.getByID(e.target.parentElement.parentElement.id)}));let s=$(i).children()[2];return $(s).on("click",(e=>{let t=I.getByID(e.target.parentElement.parentElement.id);t.setPinned(!t.getPinned()),U(t)})),i}function V(e,t){if(m&&!_){if(t)return void we("textboxmarkupdeleted",{uniqueid:e.getUniqueId()});we("textboxmarkupupdated",{textboxdata:e.toJson()})}}function H(e,t){let i=J(d+" (You)"),a=new Communicator.Color(N[m.id].color[0],N[m.id].color[1],N[m.id].color[2]);return new r(e,t,void 0,void 0,void 0,void 0,a,void 0,void 0,void 0,!0,i,void 0,{username:d,userid:m.id})}function W(){(I=new n(c,!1)).setMarkupUpdatedCallback(V),(S=new l(hwv,I)).setAllowCreation(0),S.setCreateMarkupItemCallback(H);const e=c.operatorManager.registerCustomOperator(S);return c.operatorManager.push(e),e}function j(e){S.setAllowCreation(e)}function q(e,t){A[e]=t,R[t]=e}function L(e,t){z[e]=t,F[t]=e}function G(e){return e<0&&z[e]?z[e]:e}function X(e){return F[e]?F[e]:e}function Y(){P&&P.handleResize()}function K(e){k=e}function Q(){return k}function Z(e){M=e,e?Qe():c.view.setTransparencyMode(0)}function ee(){return M}function te(e){b=e,e||Qe()}function ie(){return b}function ae(){return!!m}function se(){m&&(Qe(!0),m.disconnect(),m=null),g=!1,w=!1}function oe(){if(m)return{id:m.id,name:d}}function ne(){return g}function re(){return w}function le(){!m||g||w||m.emit("lockSession",""),g=!0}function de(){m&&g&&m.emit("unlockSession",""),g=!1}function ce(e){m.emit("chatmessage",JSON.stringify({user:d,message:e}))}function ue(e){m.emit("updateroomdata",JSON.stringify(e))}async function he(){return new Promise(((e,t)=>{m.emit("getroomdata","",(t=>{e(JSON.parse(t))}))}))}function me(e){p=e}function pe(){return p}function _e(e){m&&(e.type="custommessage",e.user=d,m.emit("hcmessage",JSON.stringify(e)))}function ge(e){v=e}function we(e,t){m&&(t.type=e,t.user=d,t.userid=m.id,m.emit("hcmessage",JSON.stringify(t)))}function xe(e){if(!_&&m&&!p&&!w){let e={camera:c.view.getCamera().toJson()};we(M?"camera":"camera2",e)}}function fe(e){if(m&&!p&&!_&&!w&&k){let e=[],t=hwv.selectionManager.getResults();for(let i=0;i<t.length;i++)e.push(t[i].toJson()),e[i].nodeId=G(e[i].nodeId);we("selection",{selection:e})}}async function ve(e,t,i){return!m||p||_||w||we("visibility",{nodeids:e,onoff:t}),await c.model.setNodesVisibilityCollab(e,t,i)}async function Ce(e,t){var i=(new Error).stack;(-1==i.indexOf("hoops_web_viewer")||-1!=i.indexOf("web_viewer_ui")&&i.indexOf("web_viewer_ui")<i.indexOf("hoops_web_viewer"))&&(!m||p||_||w||we("facecolor",{nodeids:e,color:t.toJson()})),await c.model.setNodesFaceColorCollab(e,t)}async function ye(e,t,i){-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!m||p||_||w||we("metallicroughness",{nodeids:e,metallic:t,roughness:i})),await c.model.setMetallicRoughnessCollab(e,t,i)}async function Me(e){return-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!m||p||_||w||we("unsetmetallicroughness",{nodeids:e})),await c.model.unsetMetallicRoughnessCollab(e)}async function ke(e){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&m&&!p&&!_&&!w){let t=B();we("createmesh",{meshdata:e,uniqueid:t});let i=await c.model.createMeshCollab(e);return q(i[1],t),i}return await c.model.createMeshCollab(e)}async function be(e,t){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&m&&!p&&!_&&!w){let i=B(),a={meshinstancedata:JSON.parse(JSON.stringify(e)),nodeid:G(t),uniqueid:i};a.meshinstancedata._meshId[1]=function(e){return A[e]?A[e]:e}(a.meshinstancedata._meshId[1]),we("createmeshinstance",a);let s=await c.model.createMeshInstanceCollab(e,t);return L(s,i),s}return await c.model.createMeshInstanceCollab(e,t)}function Pe(e,t,i,a,s,o){if(m&&!p&&!_&&!w){let n=B();we("createnode",{parentnodeid:G(e),nodename:t,nodeid:i,localMatrix:a,visibility:s,measurementUnits:o,uniqueid:n});let r=c.model.createNodeCollab(e,t,i,a,s,o);return L(r,n),r}return c.model.createNodeCollab(e,t,i,a,s,o)}async function Ie(e){var t=(new Error).stack;return(-1==t.indexOf("hoops_web_viewer")||-1!=t.indexOf("web_viewer_ui")&&t.indexOf("web_viewer_ui")<t.indexOf("hoops_web_viewer"))&&(!m||p||_||w||we("unsetfacecolor",{nodeids:e})),await c.model.unsetNodesFaceColorCollab(e)}async function Se(e,t){return!m||p||_||w||we("opacity",{nodeids:e,opacity:t}),await c.model.setNodesOpacityCollab(e,t)}async function Ne(e){return!m||p||_||w||we("resetopacity",{nodeids:e}),await c.model.resetNodesOpacityCollab(e)}async function De(e,t,i){return!m||p||_||w||we("setInstanceModifier",{a:e,b:t,c:i}),await c.model.setInstanceModifierCollab(e,t,i)}async function Te(){return!m||p||_||w||we("resetvisibilities",{}),await c.model.resetNodesVisibilityCollab()}async function $e(e){return!m||p||_||w||we("setdrawmode",{drawmode:e}),await c.view.setDrawModeCollab(e)}async function Be(e){return!m||p||_||w||!M||we("setprojectionmode",{projectionmode:e}),await c.view.setProjectionModeCollab(e)}async function Oe(){return!m||p||_||w||(await Qe(),we("reset",{})),await c.model.resetCollab()}async function Ee(){!m||p||_||w||we("clear",{}),await Qe(!0),await c.model.clearCollab(),c._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds()}async function ze(e,t){let i=c.model.getNodeName(e);return i&&-1!=i.indexOf("handle-")||!m||p||_||w||we("matrix",{nodeid:G(e),matrix:t.toJson(),user:d}),await c.model.setNodeMatrixCollab(e,t)}async function Fe(e,t,i,a){return!m||p||_||w||(await Qe(),we("isolate",{nodeids:e,duration:t,fitNodes:i,initiallyHidden:a})),await c.view.isolateNodesCollab(e,0,i,a)}async function Ae(e,t){return!m||p||_||w||we("cadview",{nodeid:e,duration:t}),await c.model.activateCadViewCollab(e,0)}async function Re(e){return!m||p||_||w||we("explodemagnitude",{magnitude:e}),await c.explodeManager.setMagnitudeCollab(e)}function Ue(e){!m||p||_||w||we("markup",{id:e.getUniqueId(),info:c.markupManager.exportMarkup()})}function Je(){!m||p||_||w||we("markup",{id:c.markupManager.getActiveMarkupView().getUniqueId(),info:c.markupManager.exportMarkup()})}function Ve(){!m||p||_||w||we("markup",{id:null,info:c.markupManager.exportMarkup()})}async function He(e){!m||p||_||w||we("activatemarkupview",{id:e}),c.unsetCallbacks({camera:xe}),await c.markupManager.activateMarkupViewWithPromiseCollab(e,0),c.setCallbacks({camera:xe})}async function We(e,t){!m||p||_||w||we("cuttingsection",{id:e,active:!0,csinfo:t.toJson()}),await t.activateCollab()}async function je(e,t){!m||p||_||w||we("cuttingsection",{id:e,active:!1,csinfo:t.toJson()}),await t.deactivateCollab()}async function qe(e,t,i,a,s,o,n){await t.updatePlaneCollab(i,a,s,o,n),!m||p||_||w||we("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function Le(e,t,i,a,s){await t.setPlaneCollab(i,a,s),!m||p||_||w||we("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function Ge(e,t,i){!m||p||_||w||we("loadsubtree",{a:e,b:t,c:i});let a=await c.model.loadSubtreeFromScsFileCollab(e,t,i);return c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),a}function Xe(e){for(let t in N)if(N[t].label==e){c.view.setCamera(N[t].cameraWidget.getCamera(),1e3);break}}function Ye(e,t,i,o){u=i,h=new a(e),P=new s(e);let n="content";o&&(n=o),$("#"+n).prepend('<div id="hcCollabSpriteOverlay" style="width: 100%; height: 100%; background: none;z-index:10000;position: absolute;pointer-events:none"></div>'),P.setNativeSpriteContainer("hcCollabSpriteOverlay"),P.setSpriteClickedEvent(Xe),function(){$("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="dummycanvas" width="420px" height="150px;"></canvas></div>');(O=document.getElementById("dummycanvas").getContext("2d")).font="50px Arial";let e=O.measureText("Hello World Test"),t=e.width+40,i=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent+20;$("body").append('<div style="display:none"><div id="camlabel" style="height:'+i+"px;width:"+t+'px;text-align:center;border-radius:20px;display:block;pointer-events:none;font-family:arial;font-size:50px;position:absolute;background-color:rgba(0,0,0,0.5);color:white;display:block">Hello World Test</div></div>'),E=$("#camlabel")}(),c=e,f=t,e.setCallbacks({camera:xe,selectionArray:fe,viewCreated:Ue,redlineCreated:Je,measurementCreated:Ve}),e.view.setProjectionModeCollab=e.view.setProjectionMode,e.view.setProjectionMode=Be,e.view.setDrawModeCollab=e.view.setDrawMode,e.view.setDrawMode=$e,e.markupManager.activateMarkupViewWithPromiseCollab=e.markupManager.activateMarkupViewWithPromise,e.markupManager.activateMarkupViewWithPromise=He,e.model.loadSubtreeFromScsFileCollab=e.model.loadSubtreeFromScsFile,e.model.loadSubtreeFromScsFile=Ge,e.model.setNodesVisibilityCollab=e.model.setNodesVisibility,e.model.setNodesVisibility=ve,e.model.createMeshCollab=e.model.createMesh,e.model.createMesh=ke,e.model.createMeshInstanceCollab=e.model.createMeshInstance,e.model.createMeshInstance=be,e.model.createNodeCollab=e.model.createNode,e.model.createNode=Pe,e.model.setMetallicRoughnessCollab=e.model.setMetallicRoughness,e.model.setMetallicRoughness=ye,e.model.unsetMetallicRoughnessCollab=e.model.unsetMetallicRoughness,e.model.unsetMetallicRoughness=Me,e.model.setNodesFaceColorCollab=e.model.setNodesFaceColor,e.model.setNodesFaceColor=Ce,e.model.unsetNodesFaceColorCollab=e.model.unsetNodesFaceColor,e.model.unsetNodesFaceColor=Ie,e.model.setNodesOpacityCollab=e.model.setNodesOpacity,e.model.setNodesOpacity=Se,e.model.resetNodesOpacityCollab=e.model.resetNodesOpacity,e.model.resetNodesOpacity=Ne,e.model.setInstanceModifierCollab=e.model.setInstanceModifier,e.model.setInstanceModifier=De,e.explodeManager.setMagnitudeCollab=e.explodeManager.setMagnitude,e.explodeManager.setMagnitude=Re,e.model.resetNodesVisibilityCollab=e.model.resetNodesVisibility,e.model.resetNodesVisibility=Te,e.model.resetCollab=e.model.reset,e.model.reset=Oe,e.model.clearCollab=e.model.clear,e.model.clear=Ee,e.model.setNodeMatrixCollab=e.model.setNodeMatrix,e.model.setNodeMatrix=ze,e.view.isolateNodesCollab=e.view.isolateNodes,e.view.isolateNodes=Fe,e.model.activateCadViewCollab=e.model.activateCadView,e.model.activateCadView=Ae;let r=e.cuttingManager.getCuttingSection(0),l=e.cuttingManager.getCuttingSection(1),d=e.cuttingManager.getCuttingSection(2);if(r&&(r.activateCollab=r.activate,r.activate=function(){We(0,this)},r.deactivateCollab=r.deactivate,r.deactivate=function(){je(0,this)},r.updatePlaneCollab=r.updatePlane,r.updatePlane=function(e,t,i,a,s){qe(0,this,e,t,i,a,s)},r.setPlaneCollab=r.setPlane,r.setPlane=function(e,t,i){Le(0,this,e,t,i)}),l&&(l.activateCollab=l.activate,l.activate=function(){We(1,this)},l.deactivateCollab=l.deactivate,l.deactivate=function(){je(1,this)},l.updatePlaneCollab=l.updatePlane,l.updatePlane=function(e,t,i,a,s){qe(1,this,e,t,i,a,s)},l.setPlaneCollab=l.setPlane,l.setPlane=function(e,t,i){Le(1,this,e,t,i)}),d&&(d.activateCollab=d.activate,d.activate=function(){We(2,this)},d.deactivateCollab=d.deactivate,d.deactivate=function(){je(2,this)},d.updatePlaneCollab=d.updatePlane,d.updatePlane=function(e,t,i,a,s){qe(2,this,e,t,i,a,s)},d.setPlaneCollab=d.setPlane,d.setPlane=function(e,t,i){Le(2,this,e,t,i)}),f){var _=$("#ui-modelbrowser-minimizebutton");_&&_.on("click",(function(){!m||p||w||($(this).hasClass("minimized")?we("minimizebrowser",{}):we("maximizebrowser",{}))}))}}async function Ke(e,t,a){d=t;let s={username:t,roomname:e,password:a};(m=await io(u)).emit("joinroom",JSON.stringify(s)),m.on("hcmessage",(async function(e){let t=JSON.parse(e);v&&!v(t)||"custommessage"===t.type||function(e){C.push(e);{let e=setInterval((async function(){if(C.length>0){if(!y){y=!0;let e=C.shift();await async function(e){switch(_=!0,e.type){case"textboxmarkupupdated":{let t=e.textboxdata,i=I.getByID(t.uniqueid);if(i)i.setFirstPoint(Communicator.Point3.fromJson(t.firstPoint)),i.setSecondPoint(Communicator.Point3.fromJson(t.secondPoint)),i._secondPointRel=Communicator.Point2.fromJson(t.secondPointRel),i.setText(decodeURIComponent(t.text)),i.setPinned(t.pinned);else{t.extraDivText=J(e.user);let a=new Communicator.Color(N[e.userid].color[0],N[e.userid].color[1],N[e.userid].color[2]);t.backgroundColor=a,i=r.fromJson(I,t),I.add(i)}U(i)}break;case"textboxmarkupdeleted":I.delete(e.uniqueid);break;case"camera":case"camera2":{let t=Communicator.Camera.fromJson(e.camera);if(b&&!M&&N[e.userid]){let a=N[e.userid];if(a.cameraWidget||(h.isActive()||await h.initialize(),a.cameraWidget=new i(h,new Communicator.Color(a.color[0],a.color[1],a.color[2]),new Communicator.Color(a.color[0],a.color[1],a.color[2]),.4,!0,!1,1e3)),a.label)await a.label.setPosition(t.getPosition());else{let i=function(e,t){let i=O.measureText(e),a=i.width+40;return i.actualBoundingBoxAscent,i.actualBoundingBoxDescent,E.css("width",a+"px"),E.css("background-color","rgb("+t[0]+","+t[1]+","+t[2]+")"),E.html(e),e=e.replace(/ /g,"_"),E.attr("id","dynamic0"+e),"dynamic0"+e}(e.user,a.color);a.label=await P.createDOMSprite(i,t.getPosition(),.4,!1,!1)}await a.cameraWidget.update(t)}"camera"==e.type&&M&&(await c.view.setCamera(t),we("camera2",{camera:t.toJson()}))}break;case"setprojectionmode":M&&await c.view.setProjectionModeCollab(e.projectionmode);break;case"selection":if(k){let t=e.selection;c.selectionManager.clear();let i=[];for(let e=0;e<t.length;e++){let a,s,o;if(t[e].faceEntity&&(a=Communicator.Selection.FaceEntity.fromJson(t[e].faceEntity)),t[e].lineEntity&&(s=Communicator.Selection.LineEntity.fromJson(t[e].lineEntity)),t[e].pointEntity&&(o=Communicator.Selection.PointEntity.fromJson(t[e].pointEntity)),c._modelStructure._assemblyTree.lookupAnyTreeNode(X(t[e].nodeId))){let n=new Communicator.Selection.SelectionItem.create(X(t[e].nodeId),null,a,s,o);i.push(n)}}for(let e=0;e<i.length;e++)await c.selectionManager.add(i[e])}break;case"setdrawmode":await c.view.setDrawModeCollab(e.drawmode);break;case"activatemarkupview":c.unsetCallbacks({camera:xe}),await c.markupManager.activateMarkupViewWithPromise(e.id,0),c.setCallbacks({camera:xe});break;case"markup":c.unsetCallbacks({viewCreated:Ue}),c.unsetCallbacks({redlineCreated:Ue}),c.markupManager.deleteMarkupView(e.id),await c.markupManager.loadMarkupData(e.info),e.id&&c.markupManager.activateMarkupView(e.id),c.markupManager.refreshMarkup(),c.setCallbacks({viewCreated:Ue}),c.setCallbacks({redlineCreated:Ue});break;case"loadsubtree":c.unsetCallbacks({camera:xe}),await hwv.model.loadSubtreeFromScsFileCollab(e.a,e.b,e.c),c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),c.setCallbacks({camera:xe});break;case"visibility":await c.model.setNodesVisibilityCollab(e.nodeids,e.onoff);break;case"createmesh":{let t=function(e){let t=new Communicator.MeshData;t.setFaceWinding(e._faceWinding);for(let i=0;i<e._faceMeshData.length;i++){let a=e._faceMeshData[i];t.addFaces(a.vertexData,a.normalData)}return t}(e.meshdata),i=await c.model.createMesh(t);e.uniqueid&&q(i[1],e.uniqueid)}break;case"createmeshinstance":{let t=X(e.nodeid),i=function(e){var t;e._meshId[1]=(t=e._meshId[1],R[t]?R[t]:t);let i=new Communicator.MeshInstanceData(e._meshId);return e._faceColor&&i.setFaceColor(new Communicator.Color(e._faceColor.r,e._faceColor.g,e._faceColor.b)),i}(e.meshinstancedata),a=await c.model.createMeshInstance(i,t);e.uniqueid&&L(a,e.uniqueid)}break;case"createnode":{let t=X(e.parentnodeid),i=c.model.createNode(t,e.nodename,e.nodeid,e.localMatrix,e.visibility,e.measurementUnits);e.uniqueid&&L(i,e.uniqueid)}break;case"opacity":try{await c.model.setNodesOpacityCollab(e.nodeids,e.opacity)}catch(e){}break;case"metallicroughness":try{await c.model.setMetallicRoughnessCollab(e.nodeids,e.metallic,e.roughness)}catch(e){}break;case"unsetmetallicroughness":try{await c.model.unsetMetallicRoughness(e.nodeids)}catch(e){}break;case"facecolor":try{await c.model.setNodesFaceColorCollab(e.nodeids,Communicator.Color.fromJson(e.color))}catch(e){}break;case"unsetfacecolor":try{await c.model.unsetNodesFaceColorCollab(e.nodeids)}catch(e){}break;case"resetopacity":await c.model.resetNodesOpacityCollab(e.nodeids,e.opacity);break;case"setInstanceModifier":try{await c.model.setInstanceModifierCollab(e.nodeid,e.modifier)}catch(e){}break;case"explodemagnitude":await c.explodeManager.setMagnitudeCollab(e.magnitude);break;case"resetvisibilities":await c.model.resetNodesVisibilityCollab();break;case"reset":await Qe(),await c.model.resetCollab();break;case"clear":await Qe(!0),c.unsetCallbacks({camera:xe}),await c.model.clearCollab(),c._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,c.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),c.setCallbacks({camera:xe});break;case"matrix":{let t=X(e.nodeid);await c.model.setNodeMatrixCollab(t,Communicator.Matrix.fromJson(e.matrix))}break;case"isolate":await Qe(),await c.view.isolateNodesCollab(e.nodeids,0,null!=e.fitNodes?e.fitNodes:void 0,null!=e.initiallyHidden?e.initiallyHidden:void 0);break;case"cadview":await c.model.activateCadViewCollab(e.nodeid,0);break;case"cuttingsection":{let t=c.cuttingManager.getCuttingSection(e.id);e.active?await t.fromJson(e.csinfo):t.deactivateCollab()}break;case"minimizebrowser":await f._modelBrowser._minimizeModelBrowser();break;case"maximizebrowser":await f._modelBrowser._maximizeModelBrowser()}_=!1}(e),y=!1}}else clearInterval(e),e=null}),10)}}(t)})),m.on("initialState",(function(e){let t=JSON.parse(e);if(t.type="initialState",!v||v(t)){if(t.camera){let e=Communicator.Camera.fromJson(t.camera);c.view.setCamera(e)}if(t.textBoxes){for(let e=0;e<t.textBoxes.length;e++){let i,a=t.textBoxes[e];if(a.extraDivText=J(a.userdata.username),N[a.userdata.userid]){let e=N[a.userdata.userid];i=new Communicator.Color(e.color[0],e.color[1],e.color[2])}else i=new Communicator.Color(255,255,255);a.backgroundColor=i;let s=r.fromJson(I,a);I.add(s),U(s)}setTimeout((function(){I.refreshMarkup()}),100)}}})),m.on("sendInitialState",(function(e){let t={type:"sendInitialState",camera:c.view.getCamera().toJson()};I&&(t.textBoxes=I.exportMarkup()),(!v||v(t))&&m.emit("initialState",JSON.stringify({recepient:e,state:t}))})),m.on("lockSession",(function(e){v&&!v({user:e,type:"lockSession"})||(x=e,w=!0)})),m.on("unlockSession",(function(e){v&&!v({type:"unlockSession"})||(w=!1)})),m.on("disconnect",(()=>{x="",w=!1,se(),v&&v({type:"connectionLost"})})),m.on("disconnected",(function(e){e==x&&1==w&&(x="",w=!1),v&&v({user:e,type:"disconnected"})})),m.on("chatmessage",(function(e){let t=JSON.parse(e);t.type="chatmessage",v&&v(t)})),m.on("userlist",(async function(e){let t=JSON.parse(e);t.type="userlist";for(let e in N)N[e].delete=!0;for(let e=0;e<t.roomusers.length;e++){let i=t.roomusers[e].id;N[i]||(N[i]=t.roomusers[e],N[i].color=D[T++],T>=D.length&&(T=0)),N[i].delete=!1}for(let e in N)N[e].delete&&(_=!0,N[e].cameraWidget&&(N[e].cameraWidget.flush(),P.flush(N[e].label.nodeid)),delete N[e],_=!1);v&&v(t)}))}async function Qe(e){_=!0,await P.flushAll();for(let e in N){let t=N[e];t.cameraWidget&&(await t.cameraWidget.flush(),t.cameraWidget=null,t.label=null)}e&&h.deactivate(),_=!1}var Ze=t.U6,et=t.lj,tt=t.bA,it=t.$j,at=t.zP,st=t.$,ot=t.CS,nt=t.pw,rt=t.vy,lt=t.Gi,dt=t.uI,ct=t.hy,ut=t.lc,ht=t.CD,mt=t.wI,pt=t.j2,_t=t.Nk,gt=t.$T,wt=t.dj,xt=t.O5,ft=t.IA,vt=t.XG,Ct=t.Br,yt=t.Al,Mt=t.yx,kt=t.Vt,bt=t.f4,Pt=t.jX;export{Ze as TextBoxMarkupItem,et as TextBoxMarkupOperator,tt as TextBoxMarkupTypeManager,it as connect,at as disconnect,st as getActive,ot as getLocalUser,nt as getLockedClient,rt as getLockedMaster,lt as getRoomData,dt as getShowCameraWidgets,ct as getSuspendSend,ut as getSyncCamera,ht as getSyncSelection,mt as handleResize,pt as initialize,_t as initializeTextBoxMarkup,gt as lockSession,wt as sendCustomMessage,xt as setMessageReceivedCallback,ft as setShowCameraWidgets,vt as setSuspendSend,Ct as setSyncCamera,yt as setSyncSelection,Mt as setTextBoxMarkupAllowCreation,kt as submitChat,bt as unlockSession,Pt as updateRoomData};