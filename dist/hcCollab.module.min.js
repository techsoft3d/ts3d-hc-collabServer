var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{$j:()=>Je,zP:()=>q,$:()=>U,CS:()=>X,pw:()=>Y,vy:()=>G,Gi:()=>te,uI:()=>B,hy:()=>ae,lc:()=>j,CD:()=>A,wI:()=>T,j2:()=>Te,$T:()=>K,dj:()=>se,O5:()=>oe,IA:()=>L,XG:()=>ie,Br:()=>E,Al:()=>J,Vt:()=>Z,f4:()=>Q,jX:()=>ee});class i{constructor(e,t=new Communicator.Color(255,0,0),i=new Communicator.Color(255,0,0),a=.1,s=!0,o=!1,n){this._manager=e,this._node=null,this._currentCamera=null,this._lineColor=t,this._faceColor=i,this._faceOpacity=a,this._renderFaces=s,this._suppressScale=o,this._fixedLength=n}async update(e,t=this._manager._viewer.view.getCanvasSize()){if(!this._node){let e=new Communicator.MeshInstanceData(this._manager._frustumMesh),t=new Communicator.MeshInstanceData(this._manager._frustumMeshLines);if(this._node=this._manager._viewer.model.createNode(this._manager.node),this._renderFaces){let t=await this._manager._viewer.model.createMeshInstance(e,this._node,!0);await this._manager._viewer.model.setNodesOpacity([t],this._faceOpacity),await this._manager._viewer.model.setNodesFaceColor([t],this._faceColor)}let i=await this._manager._viewer.model.createMeshInstance(t,this._node,!0);await this._manager._viewer.model.setNodesLineColor([i],this._lineColor),await this._manager._viewer.model.setNodesLinePattern([i],[1,0],.05,Communicator.LinePatternLengthUnit.Object),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotSelect,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.ExcludeBounding,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotCut,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotExplode,[this._node],!0),this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[this._node],!0),this._suppressScale&&this._manager._viewer.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[this._node],!0)}let i,a,s,o,n,r=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).normalize(),l=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).length(),d=new Communicator.Matrix,c=e.getPosition(),m=new Communicator.Matrix;if(this._suppressScale)null==this._fixedLength&&(i=.2),a=i/2,s=i/2,l=i;else if(a=e.getWidth(),s=e.getHeight(),this._fixedLength){let e=l/this._fixedLength;a/=e,s/=e,l=this._fixedLength}let u=t.x/t.y;u>=1?(o=a*u,n=s):(o=a,n=s/u),m.setTranslationComponent(c.x,c.y,c.z),d.setScaleComponent(o,n,l);let h=this.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(0,0,1),r),w=h.transform(new Communicator.Point3(0,1,0)),p=this.ComputeVectorToVectorRotationMatrix(w,e.getUp()),f=Communicator.Matrix.multiply(d,h),g=Communicator.Matrix.multiply(f,p),_=Communicator.Matrix.multiply(g,m);await this._manager._viewer.model.setNodeMatrix(this._node,_),this._currentCamera=e.copy(),this._currentCanvasSize=t}async flush(){this._manager._viewer.model.deleteNode(this._node),this._node=null}getCamera(){return this._currentCamera}ComputeVectorToVectorRotationMatrix(e,t){const i=1e-7;e.normalize(),t.normalize();let a=Communicator.Point3.cross(e,t),s=Communicator.Point3.dot(e,t),o=a.length();if(o>-1e-7&&o<i){if(!(s<0))return new Communicator.Matrix;if(e.x<-1e-7||e.x>i)a.x=e.y,a.y=-e.x,a.z=0;else if(e.y<-1e-7||e.y>i)a.x=-e.y,a.y=e.x,a.z=0;else{if(!(e.z<-1e-7||e.z>i))return new Communicator.Matrix;a.x=-e.z,a.z=e.x,a.y=0}}var n=Math.atan2(o,s);return n*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(a,n)}}class a{constructor(e){this._viewer=e,this._widgets=[],this._node=null}async initialize(){this._node=this._viewer.model.createNode(),await this._createFrustumMesh()}deactivate(){this._node=null}isActive(){return null!=this._node}async _createFrustumMesh(e){let t=[0,0,0,-.5,-.5,1,.5,-.5,1,0,0,0,.5,-.5,1,.5,.5,1,0,0,0,-.5,.5,1,.5,.5,1,0,0,0,-.5,.5,1,-.5,-.5,1],i=[];for(let e=0;e<4;e++){let a=Communicator.Plane.createFromPoints(new Communicator.Point3(t[9*e],t[9*e+1],t[9*e+2]),new Communicator.Point3(t[9*e+3],t[9*e+4],t[9*e+5]),new Communicator.Point3(t[9*e+6],t[9*e+7],t[9*e+8]));for(let e=0;e<3;e++)i.push(-a.normal.x),i.push(-a.normal.y),i.push(-a.normal.z)}var a=new Communicator.MeshData;a.setFaceWinding(Communicator.FaceWinding.Unknown),a.addFaces(t,i),this._frustumMesh=await this._viewer.model.createMesh(a);let s=[[0,0,0,-.5,-.5,1,.5,-.5,1],[0,0,0,.5,-.5,1,.5,.5,1],[0,0,0,-.5,.5,1,.5,.5,1],[0,0,0,-.5,.5,1,-.5,-.5,1],[0,0,0,.5,.5,1]];var o=new Communicator.MeshData;for(let e=0;e<s.length;e++)o.addPolyline(s[e]);this._frustumMeshLines=await this._viewer.model.createMesh(o)}add(e){this._widgets.push(e),e.update(this._viewer.view.getCamera())}}class s{constructor(e){this._viewer=e,this._meshHash=[],this._spriteNode=this._viewer.model.createNode(this._viewer.model.getAbsoluteRootNode(),"sprites"),this._imageHash=[],this._sprites=[],this._alwaysInFront=!0,this._lastCamPosition=new Communicator.Point3(0,0,0),this._lastCheckDate=new Date,this._updateVisibilities(),this._nativeSpriteCounter=1111111111,this._nativeSpriteContainer="",this._wasDragged=!1,this._spriteClickedEvent=null;let t=this;this._viewer.setCallbacks({camera:function(e){t._updateDOMSprites(e)}})}setSpriteClickedEvent(e){this._spriteClickedEvent=e}_updateDOMSprite(e,t){let i,a,s=this._viewer.view.projectPoint(e.center,t);i=null==e.offsetdata.x?-e.offsetdata.width/2:e.offsetdata.x+e.offsetdata.width/2*(1-e.scale),a=null==e.offsetdata.y?-e.offsetdata.height/2:e.offsetdata.y+e.offsetdata.height/2*(1-e.scale),$("#"+e.nodeid).css({left:s.x+i+"px",top:s.y+a+"px",position:"absolute"})}_updateDOMSprites(e){for(let t in this._sprites)if(this._sprites[t].isNative){let i=this._sprites[t];this._updateDOMSprite(i,e)}}setNativeSpriteContainer(e){this._nativeSpriteContainer=e;let t=this;$("#"+this._nativeSpriteContainer).mousemove((function(e){if(1==e.which&&(t._wasDragged=!0,t._movedSprite&&t._movedSprite.allowDrag)){let i=new Communicator.Point2(t._startDown.x+(e.offsetX-t._startDown.x),t._startDown.y+(e.offsetY-t._startDown.y)),a=t._viewer.view.getCamera(),s=a.getPosition(),o=a.getTarget(),n=Communicator.Point3.subtract(o,s).normalize(),r=Communicator.Plane.createFromPointAndNormal(t._movedSprite.center,n),l=new Communicator.Point3,d=t._viewer.view.raycastFromPoint(new Communicator.Point2(i.x,i.y)),c=null;c=r.intersectsRay(d,l),c&&(t._movedSprite.center.x=l.x,t._movedSprite.center.y=l.y,t._movedSprite.center.z=l.z),t._updateDOMSprite(t._movedSprite,t._viewer.view.getCamera())}})),$(window).mouseup((function(e){if(1==e.which&&($("#"+t._nativeSpriteContainer).css("pointer-events","none"),t._movedSprite)){!t._wasDragged&&t._spriteClickedEvent&&t._spriteClickedEvent(t._movedSprite),$("#"+t._movedSprite.nodeid).css("box-shadow",""),t._movedSprite=null;for(let e in t._sprites)t._sprites[e].isNative&&$("#"+e).css("pointer-events","all")}}))}_getImage(e){return new Promise(((t,i)=>{var a=new Image;a.crossOrigin="anonymous",a.addEventListener("load",(function(){t({img:a,dims:new Communicator.Point2(this.naturalWidth,this.naturalHeight)})})),a.src=e}))}_getDataUrl(e){const t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),t.toDataURL("image/png")}async _updateDynamicImage(e){let t=$("#"+e).find("canvas")[0];return t||(t=await html2canvas(document.querySelector("#"+e),{onclone:function(t){t.querySelector("#"+e).style.display="block"}})),{durl:t.toDataURL("image/png"),dims:{x:t.width,y:t.height}}}_convertDataURIToBinary(e){var t=e.indexOf(";base64,")+8,i=window.atob(e.substring(t));return Uint8Array.from(Array.prototype.map.call(i,(function(e){return e.charCodeAt(0)})))}async addImage(e,t,i,a){var s;s=null==t?e:t;var o=await this._getImage(s),n=this._convertDataURIToBinary(this._getDataUrl(o.img)),r={format:Communicator.ImageFormat.Png,data:n};let l="none";l=null!=i||null!=a?i+"@"+a:"none",null==i&&(i=0),null==a&&(a=0);var d=this._meshHash[l];null==d&&(d=await this._createSpriteMesh(-i/o.dims.x,-a/o.dims.y),this._meshHash[l]=d);var c=await this._viewer.model.createImage(r);this._imageHash[e]={id:c,mesh:d,dims:{width:o.dims.x,height:o.dims.y},offsetx:i,offsety:a}}async updateDynamicSprites(e){let t=this._imageHash[e],i=t.id,a=await this._updateDynamicImage(e),s=this._convertDataURIToBinary(a.durl);var o={format:Communicator.ImageFormat.Png,data:s};let n=await this._viewer.model.createImage(o),r=[];for(let t in this._sprites)if(this._sprites[t].type==e){let e=this._viewer.model.getNodeChildren(parseInt(t));0==this._sprites[t].flip?(r.push(e[1]),this._sprites[t].flip=1,setTimeout((()=>{this._viewer.model.setNodesVisibility([e[0]],!1),this._viewer.model.setNodesVisibility([e[1]],!0)}),100)):(r.push(e[0]),this._sprites[t].flip=0,setTimeout((()=>{this._viewer.model.setNodesVisibility([e[1]],!1),this._viewer.model.setNodesVisibility([e[0]],!0)}),100))}await this._viewer.model.setNodesTexture(r,{imageId:n}),await this._viewer.model.deleteImages([i]),t.id=n}async _addDOMImage(e,t){if(this._imageHash[e])t.width=this._imageHash[e].dims.width,t.height=this._imageHash[e].dims.height;else{let i=await this._getImage(e);t.width=i.dims.x,t.height=i.dims.y,this._imageHash[e]={id:null,mesh:null,dims:t}}let i="image-"+this._nativeSpriteCounter++,a='<div id="'+i+'" style="position:absolute"><img src="'+e+'"></div>';return $("#"+this._nativeSpriteContainer).append(a),$("#"+i).css("display","block"),$("#"+i).css("z-index","20000"),$("#"+i).css("pointer-events","all"),i}_addDOMDiv(e,t,i,a){let s=e+"-clone-"+this._nativeSpriteCounter++,o='<div id="'+s+'"></div>';$("#"+this._nativeSpriteContainer).append(o);let n=$("#"+s);if(n.css("display","block"),n.css("z-index","20000"),n.css("pointer-events","all"),n.css("width",i+"px"),n.css("height",a+"px"),t)return $("#"+e).appendTo(n),s;let r=$("#"+e).clone();r.removeAttr("id");let l=$("#"+e).find("canvas")[0];return l&&r.find("canvas")[0].getContext("2d").drawImage(l,0,0),n.append(r),s}async _addDynamicImage(e,t,i){let a=await this._updateDynamicImage(e),s=this._convertDataURIToBinary(a.durl);var o={format:Communicator.ImageFormat.Png,data:s},n="none";null==t&&null==i||(null==t&&(t=0),null==i&&(i=0),n=t+"@"+i);var r=this._meshHash[n];null==r&&(r=await this._createSpriteMesh(t,i),this._meshHash[n]=r);var l=await this._viewer.model.createImage(o);this._imageHash[e]={id:l,mesh:r,dims:{width:a.dims.x,height:a.dims.y}}}async _createSpriteMesh(e,t){var i=new Communicator.MeshData;i.setFaceWinding(Communicator.FaceWinding.Clockwise);var a=0,s=0;return null!=e&&(a=e),null!=t&&(s=t),i.addFaces([-1+a,-1+s,0,-1+a,1+s,0,1+a,1+s,0,-1+a,-1+s,0,1+a,1+s,0,1+a,-1+s,0],null,null,[0,0,0,1,1,1,0,0,1,1,1,0]),await this._viewer.model.createMesh(i)}async _setupInstance(e,t,i){let a=new Communicator.MeshInstanceData(e),s=await this._viewer.model.createMeshInstance(a,t);return this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.AlwaysDraw,[s],!0),i||this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.ScreenOriented,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotCut,[s],!0),this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.DoNotXRay,[s],!0),i||(this._viewer.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[s],!0),this._viewer.model.setDepthRange([s],0,.1)),s}async _createSpriteInstance(e,t,i,a){let s;if(t){s=parseInt(t);let e=this._viewer.model.getNodeChildren(s);for(let t=0;t<e.length;t++)hwv.model.deleteNode(e[t])}else s=this._viewer.model.createNode(this._spriteNode);if(await this._setupInstance(e,s,i),a){let t=await this._setupInstance(e,s,i);this._viewer.model.setNodesVisibility([t],!1)}return s}async createDOMSprite(e,t,i=1,a=!1,s=!1,n=null,r=null,l,d){let c,m={};s?c=await this._addDOMImage(e,m):(m={},m.width=$("#"+e).width(),m.height=$("#"+e).height(),c=this._addDOMDiv(e,a,m.width,m.height));let u=this;return $("#"+c).mousedown((function(e){if(1==e.which){u._wasDragged=!1,$("#"+u._nativeSpriteContainer).css("pointer-events","auto"),u._movedSprite=u._sprites[c],u._startDown=new Communicator.Point2(e.offsetX,e.offsetY,0);let t=$("#"+c).position();u._initialPos=new Communicator.Point2(t.left,t.top),$("#"+u._movedSprite.nodeid).css("box-shadow","0 0 5px #ffff00, 0 0 10px #ffff00, 0 0 15px #ffff00, 0 0 20px #ffff00");for(let e in u._sprites)u._sprites[e].isNative&&$("#"+e).css("pointer-events","none")}})),null!=n&&$("#"+c).css("display","none"),this._imageHash[e]&&this._imageHash[e].offsetx?m.x=this._imageHash[e].offsetx:m.x=l,this._imageHash[e]&&this._imageHash[e].offsety?m.y=this._imageHash[e].offsety:m.x=d,i&&$("#"+c).css("transform","scale("+i+")"),this._sprites[c]=new o(this,c,t,i,e,n,r,a,!0,m),this._updateDOMSprites(this._viewer.view.getCamera()),this._sprites[c]}async createSprite(e,t,i=1,a=!1,s=null,n=null,r=!1,l=null,d,c){let m;if(a?null==this._imageHash[e]&&await this._addDynamicImage(e,d,c):null==this._imageHash[e]&&await this.addImage(e,void 0,d,c),m=await this._createSpriteInstance(this._imageHash[e].mesh,void 0,r,a),null!=s&&this._viewer.model.setNodesVisibility([m],!1),l)this._viewer.model.setNodeMatrix(m,l);else{var u=new Communicator.Matrix,h=new Communicator.Matrix;let a=i,s=i;var w=this._imageHash[e].dims.width/this._imageHash[e].dims.height;w>1&&(s=i,a=i*w),w<1&&(a=i*w,s=i),h.setScaleComponent(a,s,1),u.setTranslationComponent(t.x,t.y,t.z);var p=Communicator.Matrix.multiply(h,u);this._viewer.model.setNodeMatrix(m,p)}if(a){let t=this._viewer.model.getNodeChildren(m);await this._viewer.model.setNodesTexture([t[0]],{imageId:this._imageHash[e].id})}else await this._viewer.model.setNodesTexture([m],{imageId:this._imageHash[e].id});return this._sprites[m]=new o(this,m,t,i,e,s,n,a,!1),this._sprites[m].set3D(l),this._sprites[m]}flushAll(){for(let e in this._sprites)this._sprites[e].flush();this._sprites=[]}flush(e){this._sprites[e].flush(),delete this._sprites[e]}hideAll(){for(var e in this._sprites)this._sprites[e].hide()}showAll(){for(var e in this._sprites)this._sprites[e].show()}handleResize(){for(let e in this._sprites)this._sprites[e].redraw()}findFromNodeId(e){var t=this._sprites[e];if(null==t){var i=hwv.model.getNodeParent(e);t=this._sprites[i]}return t}getAlwaysInFront(){return this._alwaysInFront}setAlwaysInFront(e){this._alwaysInFront=e;for(let t in this._sprites)e||null!=this._sprites[t].range?this._viewer.model.setDepthRange([parseInt(t)],0,.1):this._viewer.model.unsetDepthRange([parseInt(t)])}_updateVisibilities(){var e=this;setInterval((function(){new Date;var t=e._viewer.view.getCamera().getPosition();e._lastCamPosition=t.copy(),e._lastCheckDate=new Date,e._lastCheckDate=void 0;for(let s in e._sprites){let o=e._sprites[s];if(null!=o.range&&!o.hidden){var i=Communicator.Point3.subtract(t,o.center).length(),a=parseInt(s);if(o.isNative)i<o.range?$("#"+s).css("display","block"):$("#"+s).css("display","none");else{let t=e._viewer.model.getNodeChildren(a);i<o.range?e._viewer.model.getNodeVisibility(t[e._sprites[s].flip])||e._viewer.model.setNodesVisibility([t[e._sprites[s].flip]],!0):e._viewer.model.getNodeVisibility(t[e._sprites[s].flip])&&e._viewer.model.setNodesVisibility([t[e._sprites[s].flip]],!1)}}}}),200)}}class o{constructor(e,t,i,a,s,o,n,r,l,d){this._manager=e,this.nodeid=t,this.range=o,this.center=i,this.scale=a,this.type=s,this.payload=n,this.dynamic=r,this.isNative=l,this.offsetdata=d,this.hidden=!1,this.flip=0,this.matrix=null,this.allowDrag=!1}set3D(e){this.matrix=e}getIs3D(){return null!=this.matrix}setAllowDrag(e){this.allowDrag=e}hide(){this._manager._viewer.model.setNodesVisibility([this.nodeid],!1)}flush(){this.isNative?$("#"+this.nodeid).remove():this.dynamic||this._manager._viewer.model.deleteNode(this.nodeid)}show(){this._manager._viewer.model.setNodesVisibility([this.nodeid],!0)}async setPosition(e){this.center=e.copy(),this.isNative&&await this._manager._updateDOMSprite(this,this._manager._viewer.view.getCamera())}async redraw(){this.isNative&&await this._manager._updateDOMSprite(this,this._manager._viewer.view.getCamera())}async setType(e,t){if(this.type!=e){if(this.type=e,this.isNative){let i={};i.width=this._manager._imageHash[e].dims.width,i.height=this._manager._imageHash[e].dims.height,this.offsetdata=i,null==t&&(t=this.scale);let a=$("#"+this.nodeid).children()[0],s=this;return $(a).bind("load",(function(){$("#"+s.nodeid).css("z-index","20000"),$("#"+s.nodeid).css("pointer-events","all"),$("#"+s.nodeid).css("transform","scale("+t+")"),s._manager._updateDOMSprite(s,s._manager._viewer.view.getCamera()),$("#"+s.nodeid).css("display","block")})),$("#"+this.nodeid).css("display","none"),void $(a).attr("src",e)}if(await this._manager._createSpriteInstance(this._manager._imageHash[e].mesh,this.nodeid,this.getIs3D(),this.dynamic),this._manager._sprites.matrix)this._manager._viewer.model.setNodeMatrix(this.nodeid,matrix);else if(t){let n=this._manager._sprites[this.nodeid].center;var i=new Communicator.Matrix,a=new Communicator.Matrix;let r=t,l=t;var s=this._manager._imageHash[e].dims.width/this._manager._imageHash[e].dims.height;s>1&&(l*=1/s),s<1&&(r*=s),a.setScaleComponent(r,l,1),i.setTranslationComponent(n.x,n.y,n.z);var o=Communicator.Matrix.multiply(a,i);this._manager._viewer.model.setNodeMatrix(this.nodeid,o)}await this._manager._viewer.model.setNodesTexture([this.nodeid],{imageId:this._manager._imageHash[e].id})}}}var n,r,l,d,c=null,m=!1,u=!1,h=!1,w=!1,p="",f=null,g=null,_=[],v=!1,C=!0,y=!0,b=!1,M=null,x=[],S=[[255,0,0],[0,255,0],[0,0,255],[255,0,255],[0,255,255],[255,128,0],[128,255,0],[0,255,128],[0,128,255],[128,0,255],[255,0,128],[255,128,128],[128,255,128],[128,128,255],[255,128,255],[255,255,128],[128,255,255],[255,255,255]],N=0;function I(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var k,D,P=[],O=[],F=[],V=[];function z(e,t){F[e]=t,V[t]=e}function H(e,t){P[e]=t,O[t]=e}function W(e){return e<0&&P[e]?P[e]:e}function R(e){return O[e]?O[e]:e}function T(){M&&M.handleResize()}function J(e){y=e}function A(){return y}function E(e){C=e,e?Ae():r.view.setTransparencyMode(0)}function j(){return C}function L(e){b=e,e||Ae()}function B(){return b}function U(){return!!c}function q(){c&&(Ae(!0),c.disconnect(),c=null),h=!1,w=!1}function X(){if(c)return{id:c.id,name:n}}function G(){return h}function Y(){return w}function K(){!c||h||w||c.emit("lockSession",""),h=!0}function Q(){c&&h&&c.emit("unlockSession",""),h=!1}function Z(e){c.emit("chatmessage",JSON.stringify({user:n,message:e}))}function ee(e){c.emit("updateroomdata",JSON.stringify(e))}async function te(){return new Promise(((e,t)=>{c.emit("getroomdata","",(t=>{e(JSON.parse(t))}))}))}function ie(e){m=e}function ae(){return m}function se(e){c&&(e.type="custommessage",e.user=n,c.emit("hcmessage",JSON.stringify(e)))}function oe(e){g=e}function ne(e,t){c&&(t.type=e,t.user=n,t.userid=c.id,c.emit("hcmessage",JSON.stringify(t)))}function re(e){if(!u&&c&&!m&&!w){let e={camera:r.view.getCamera().toJson()};ne(C?"camera":"camera2",e)}}function le(e){if(c&&!m&&!u&&!w&&y){let e=[],t=hwv.selectionManager.getResults();for(let i=0;i<t.length;i++)e.push(t[i].toJson()),e[i].nodeId=W(e[i].nodeId);ne("selection",{selection:e})}}async function de(e,t,i){return!c||m||u||w||ne("visibility",{nodeids:e,onoff:t}),await r.model.setNodesVisibilityCollab(e,t,i)}async function ce(e,t){-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!c||m||u||w||ne("facecolor",{nodeids:e,color:t.toJson()})),await r.model.setNodesFaceColorCollab(e,t)}async function me(e,t,i){-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!c||m||u||w||ne("metallicroughness",{nodeids:e,metallic:t,roughness:i})),await r.model.setMetallicRoughnessCollab(e,t,i)}async function ue(e){return-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!c||m||u||w||ne("unsetmetallicroughness",{nodeids:e})),await r.model.unsetMetallicRoughnessCollab(e)}async function he(e){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&c&&!m&&!u&&!w){let t=I();ne("createmesh",{meshdata:e,uniqueid:t});let i=await r.model.createMeshCollab(e);return z(i[1],t),i}return await r.model.createMeshCollab(e)}async function we(e,t){if(-1==(new Error).stack.indexOf("hoops_web_viewer")&&c&&!m&&!u&&!w){let i=I(),a={meshinstancedata:JSON.parse(JSON.stringify(e)),nodeid:W(t),uniqueid:i};a.meshinstancedata._meshId[1]=function(e){return F[e]?F[e]:e}(a.meshinstancedata._meshId[1]),ne("createmeshinstance",a);let s=await r.model.createMeshInstanceCollab(e,t);return H(s,i),s}return await r.model.createMeshInstanceCollab(e,t)}function pe(e,t,i,a,s,o){if(c&&!m&&!u&&!w){let n=I();ne("createnode",{parentnodeid:W(e),nodename:t,nodeid:i,localMatrix:a,visibility:s,measurementUnits:o,uniqueid:n});let l=r.model.createNodeCollab(e,t,i,a,s,o);return H(l,n),l}return r.model.createNodeCollab(e,t,i,a,s,o)}async function fe(e){return-1==(new Error).stack.indexOf("hoops_web_viewer")&&(!c||m||u||w||ne("unsetfacecolor",{nodeids:e})),await r.model.unsetNodesFaceColorCollab(e)}async function ge(e,t){return!c||m||u||w||ne("opacity",{nodeids:e,opacity:t}),await r.model.setNodesOpacityCollab(e,t)}async function _e(e){return!c||m||u||w||ne("resetopacity",{nodeids:e}),await r.model.resetNodesOpacityCollab(e)}async function ve(e,t,i){return!c||m||u||w||ne("setInstanceModifier",{a:e,b:t,c:i}),await r.model.setInstanceModifierCollab(e,t,i)}async function Ce(){return!c||m||u||w||ne("resetvisibilities",{}),await r.model.resetNodesVisibilityCollab()}async function ye(e){return!c||m||u||w||ne("setdrawmode",{drawmode:e}),await r.view.setDrawModeCollab(e)}async function be(e){return!c||m||u||w||!C||ne("setprojectionmode",{projectionmode:e}),await r.view.setProjectionModeCollab(e)}async function Me(){return!c||m||u||w||(await Ae(),ne("reset",{})),await r.model.resetCollab()}async function xe(){!c||m||u||w||ne("clear",{}),await Ae(!0),await r.model.clearCollab(),r._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,r.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds()}async function Se(e,t){let i=r.model.getNodeName(e);return i&&-1!=i.indexOf("handle-")||!c||m||u||w||ne("matrix",{nodeid:W(e),matrix:t.toJson(),user:n}),await r.model.setNodeMatrixCollab(e,t)}async function Ne(e,t,i,a){return!c||m||u||w||(await Ae(),ne("isolate",{nodeids:e,duration:t,fitNodes:i,initiallyHidden:a})),await r.view.isolateNodesCollab(e,0,i,a)}async function Ie(e,t){return!c||m||u||w||ne("cadview",{nodeid:e,duration:t}),await r.model.activateCadViewCollab(e,0)}async function ke(e){return!c||m||u||w||ne("explodemagnitude",{magnitude:e}),await r.explodeManager.setMagnitudeCollab(e)}function De(e){!c||m||u||w||ne("markup",{id:e.getUniqueId(),info:r.markupManager.exportMarkup()})}function Pe(){!c||m||u||w||ne("markup",{id:r.markupManager.getActiveMarkupView().getUniqueId(),info:r.markupManager.exportMarkup()})}function Oe(){!c||m||u||w||ne("markup",{id:null,info:r.markupManager.exportMarkup()})}async function Fe(e){!c||m||u||w||ne("activatemarkupview",{id:e}),r.unsetCallbacks({camera:re}),await r.markupManager.activateMarkupViewWithPromiseCollab(e,0),r.setCallbacks({camera:re})}async function $e(e,t){!c||m||u||w||ne("cuttingsection",{id:e,active:!0,csinfo:t.toJson()}),await t.activateCollab()}async function Ve(e,t){!c||m||u||w||ne("cuttingsection",{id:e,active:!1,csinfo:t.toJson()}),await t.deactivateCollab()}async function ze(e,t,i,a,s,o,n){await t.updatePlaneCollab(i,a,s,o,n),!c||m||u||w||ne("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function He(e,t,i,a,s){await t.setPlaneCollab(i,a,s),!c||m||u||w||ne("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function We(e,t,i){!c||m||u||w||ne("loadsubtree",{a:e,b:t,c:i}),await r.model.loadSubtreeFromScsFileCollab(e,t,i),r.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds()}function Re(e){for(let t in x)if(x[t].label==e){r.view.setCamera(x[t].cameraWidget.getCamera());break}}function Te(e,t,i,o){l=i,d=new a(e),M=new s(e);let n="content";o&&(n=o),$("#"+n).prepend('<div id="hcCollabSpriteOverlay" style="width: 100%; height: 100%; background: none;z-index:10000;position: absolute;pointer-events:none"></div>'),M.setNativeSpriteContainer("hcCollabSpriteOverlay"),M.setSpriteClickedEvent(Re),function(){$("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="dummycanvas" width="420px" height="150px;"></canvas></div>');(k=document.getElementById("dummycanvas").getContext("2d")).font="50px Arial";let e=k.measureText("Hello World Test"),t=e.width+40,i=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent+20;$("body").append('<div style="display:none"><div id="camlabel" style="height:'+i+"px;width:"+t+'px;text-align:center;border-radius:20px;display:block;pointer-events:none;font-family:arial;font-size:50px;position:absolute;background-color:rgba(0,0,0,0.5);color:white;display:block">Hello World Test</div></div>'),D=$("#camlabel")}(),r=e,f=t,e.setCallbacks({camera:re,selectionArray:le,viewCreated:De,redlineCreated:Pe,measurementCreated:Oe}),e.view.setProjectionModeCollab=e.view.setProjectionMode,e.view.setProjectionMode=be,e.view.setDrawModeCollab=e.view.setDrawMode,e.view.setDrawMode=ye,e.markupManager.activateMarkupViewWithPromiseCollab=e.markupManager.activateMarkupViewWithPromise,e.markupManager.activateMarkupViewWithPromise=Fe,e.model.loadSubtreeFromScsFileCollab=e.model.loadSubtreeFromScsFile,e.model.loadSubtreeFromScsFile=We,e.model.setNodesVisibilityCollab=e.model.setNodesVisibility,e.model.setNodesVisibility=de,e.model.createMeshCollab=e.model.createMesh,e.model.createMesh=he,e.model.createMeshInstanceCollab=e.model.createMeshInstance,e.model.createMeshInstance=we,e.model.createNodeCollab=e.model.createNode,e.model.createNode=pe,e.model.setMetallicRoughnessCollab=e.model.setMetallicRoughness,e.model.setMetallicRoughness=me,e.model.unsetMetallicRoughnessCollab=e.model.unsetMetallicRoughness,e.model.unsetMetallicRoughness=ue,e.model.setNodesFaceColorCollab=e.model.setNodesFaceColor,e.model.setNodesFaceColor=ce,e.model.unsetNodesFaceColorCollab=e.model.unsetNodesFaceColor,e.model.unsetNodesFaceColor=fe,e.model.setNodesOpacityCollab=e.model.setNodesOpacity,e.model.setNodesOpacity=ge,e.model.resetNodesOpacityCollab=e.model.resetNodesOpacity,e.model.resetNodesOpacity=_e,e.model.setInstanceModifierCollab=e.model.setInstanceModifier,e.model.setInstanceModifier=ve,e.explodeManager.setMagnitudeCollab=e.explodeManager.setMagnitude,e.explodeManager.setMagnitude=ke,e.model.resetNodesVisibilityCollab=e.model.resetNodesVisibility,e.model.resetNodesVisibility=Ce,e.model.resetCollab=e.model.reset,e.model.reset=Me,e.model.clearCollab=e.model.clear,e.model.clear=xe,e.model.setNodeMatrixCollab=e.model.setNodeMatrix,e.model.setNodeMatrix=Se,e.view.isolateNodesCollab=e.view.isolateNodes,e.view.isolateNodes=Ne,e.model.activateCadViewCollab=e.model.activateCadView,e.model.activateCadView=Ie;let u=e.cuttingManager.getCuttingSection(0),h=e.cuttingManager.getCuttingSection(1),p=e.cuttingManager.getCuttingSection(2);if(u&&(u.activateCollab=u.activate,u.activate=function(){$e(0,this)},u.deactivateCollab=u.deactivate,u.deactivate=function(){Ve(0,this)},u.updatePlaneCollab=u.updatePlane,u.updatePlane=function(e,t,i,a,s){ze(0,this,e,t,i,a,s)},u.setPlaneCollab=u.setPlane,u.setPlane=function(e,t,i){He(0,this,e,t,i)}),h&&(h.activateCollab=h.activate,h.activate=function(){$e(1,this)},h.deactivateCollab=h.deactivate,h.deactivate=function(){Ve(1,this)},h.updatePlaneCollab=h.updatePlane,h.updatePlane=function(e,t,i,a,s){ze(1,this,e,t,i,a,s)},h.setPlaneCollab=h.setPlane,h.setPlane=function(e,t,i){He(1,this,e,t,i)}),p&&(p.activateCollab=p.activate,p.activate=function(){$e(2,this)},p.deactivateCollab=p.deactivate,p.deactivate=function(){Ve(2,this)},p.updatePlaneCollab=p.updatePlane,p.updatePlane=function(e,t,i,a,s){ze(2,this,e,t,i,a,s)},p.setPlaneCollab=p.setPlane,p.setPlane=function(e,t,i){He(2,this,e,t,i)}),f){var g=$("#ui-modelbrowser-minimizebutton");g&&g.on("click",(function(){!c||m||w||($(this).hasClass("minimized")?ne("minimizebrowser",{}):ne("maximizebrowser",{}))}))}}async function Je(e,t,a){n=t;let s={username:t,roomname:e,password:a};(c=await io(l)).emit("joinroom",JSON.stringify(s)),c.on("hcmessage",(async function(e){let t=JSON.parse(e);g&&!g(t)||"custommessage"===t.type||function(e){_.push(e);{let e=setInterval((async function(){if(_.length>0){if(!v){v=!0;let e=_.shift();await async function(e){switch(u=!0,e.type){case"camera":case"camera2":{let t=Communicator.Camera.fromJson(e.camera);if(b&&!C&&x[e.userid]){let a=x[e.userid];if(a.cameraWidget||(d.isActive()||await d.initialize(),a.cameraWidget=new i(d,new Communicator.Color(a.color[0],a.color[1],a.color[2]),new Communicator.Color(a.color[0],a.color[1],a.color[2]))),a.label)await a.label.setPosition(t.getPosition());else{let i=function(e,t){let i=k.measureText(e),a=i.width+40;return i.actualBoundingBoxAscent,i.actualBoundingBoxDescent,D.css("width",a+"px"),D.css("background-color","rgb("+t[0]+","+t[1]+","+t[2]+")"),D.html(e),e=e.replace(/ /g,"_"),D.attr("id","dynamic0"+e),"dynamic0"+e}(e.user,a.color);a.label=await M.createDOMSprite(i,t.getPosition(),.4,!1,!1)}await a.cameraWidget.update(t)}"camera"==e.type&&C&&(await r.view.setCamera(t),ne("camera2",{camera:t.toJson()}))}break;case"setprojectionmode":C&&await r.view.setProjectionModeCollab(e.projectionmode);break;case"selection":if(y){let t=e.selection;r.selectionManager.clear();let i=[];for(let e=0;e<t.length;e++){let a,s,o;if(t[e].faceEntity&&(a=Communicator.Selection.FaceEntity.fromJson(t[e].faceEntity)),t[e].lineEntity&&(s=Communicator.Selection.LineEntity.fromJson(t[e].lineEntity)),t[e].pointEntity&&(o=Communicator.Selection.PointEntity.fromJson(t[e].pointEntity)),r._modelStructure._assemblyTree.lookupAnyTreeNode(R(t[e].nodeId))){let n=new Communicator.Selection.SelectionItem.create(R(t[e].nodeId),null,a,s,o);i.push(n)}}for(let e=0;e<i.length;e++)await r.selectionManager.add(i[e])}break;case"setdrawmode":await r.view.setDrawModeCollab(e.drawmode);break;case"activatemarkupview":r.unsetCallbacks({camera:re}),await r.markupManager.activateMarkupViewWithPromise(e.id,0),r.setCallbacks({camera:re});break;case"markup":r.unsetCallbacks({viewCreated:De}),r.unsetCallbacks({redlineCreated:De}),r.markupManager.deleteMarkupView(e.id),await r.markupManager.loadMarkupData(e.info),e.id&&r.markupManager.activateMarkupView(e.id),r.markupManager.refreshMarkup(),r.setCallbacks({viewCreated:De}),r.setCallbacks({redlineCreated:De});break;case"loadsubtree":r.unsetCallbacks({camera:re}),await hwv.model.loadSubtreeFromScsFileCollab(e.a,e.b,e.c),r.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),r.setCallbacks({camera:re});break;case"visibility":await r.model.setNodesVisibilityCollab(e.nodeids,e.onoff);break;case"createmesh":{let t=function(e){let t=new Communicator.MeshData;t.setFaceWinding(e._faceWinding);for(let i=0;i<e._faceMeshData.length;i++){let a=e._faceMeshData[i];t.addFaces(a.vertexData,a.normalData)}return t}(e.meshdata),i=await r.model.createMesh(t);e.uniqueid&&z(i[1],e.uniqueid)}break;case"createmeshinstance":{let t=R(e.nodeid),i=function(e){var t;e._meshId[1]=(t=e._meshId[1],V[t]?V[t]:t);let i=new Communicator.MeshInstanceData(e._meshId);return e._faceColor&&i.setFaceColor(new Communicator.Color(e._faceColor.r,e._faceColor.g,e._faceColor.b)),i}(e.meshinstancedata),a=await r.model.createMeshInstance(i,t);e.uniqueid&&H(a,e.uniqueid)}break;case"createnode":{let t=R(e.parentnodeid),i=r.model.createNode(t,e.nodename,e.nodeid,e.localMatrix,e.visibility,e.measurementUnits);e.uniqueid&&H(i,e.uniqueid)}break;case"opacity":try{await r.model.setNodesOpacityCollab(e.nodeids,e.opacity)}catch(e){}break;case"metallicroughness":try{await r.model.setMetallicRoughnessCollab(e.nodeids,e.metallic,e.roughness)}catch(e){}break;case"unsetmetallicroughness":try{await r.model.unsetMetallicRoughness(e.nodeids)}catch(e){}break;case"facecolor":try{await r.model.setNodesFaceColorCollab(e.nodeids,Communicator.Color.fromJson(e.color))}catch(e){}break;case"unsetfacecolor":try{await r.model.unsetNodesFaceColorCollab(e.nodeids)}catch(e){}break;case"resetopacity":await r.model.resetNodesOpacityCollab(e.nodeids,e.opacity);break;case"setInstanceModifier":try{await r.model.setInstanceModifierCollab(e.nodeid,e.modifier)}catch(e){}break;case"explodemagnitude":await r.explodeManager.setMagnitudeCollab(e.magnitude);break;case"resetvisibilities":await r.model.resetNodesVisibilityCollab();break;case"reset":await Ae(),await r.model.resetCollab();break;case"clear":await Ae(!0),r.unsetCallbacks({camera:re}),await r.model.clearCollab(),r._modelStructure._assemblyTree._dynamicNodeIdSeed=-63,r.operatorManager.getOperator(Communicator.OperatorId.Walk).resetDefaultWalkSpeeds(),r.setCallbacks({camera:re});break;case"matrix":{let t=R(e.nodeid);await r.model.setNodeMatrixCollab(t,Communicator.Matrix.fromJson(e.matrix))}break;case"isolate":await Ae(),await r.view.isolateNodesCollab(e.nodeids,0,null!=e.fitNodes?e.fitNodes:void 0,null!=e.initiallyHidden?e.initiallyHidden:void 0);break;case"cadview":await r.model.activateCadViewCollab(e.nodeid,0);break;case"cuttingsection":{let t=r.cuttingManager.getCuttingSection(e.id);e.active?await t.fromJson(e.csinfo):t.deactivateCollab()}break;case"minimizebrowser":await f._modelBrowser._minimizeModelBrowser();break;case"maximizebrowser":await f._modelBrowser._maximizeModelBrowser()}u=!1}(e),v=!1}}else clearInterval(e),e=null}),10)}}(t)})),c.on("initialState",(function(e){let t=JSON.parse(e);if(t.type="initialState",(!g||g(t))&&t.camera){let e=Communicator.Camera.fromJson(t.camera);r.view.setCamera(e)}})),c.on("sendInitialState",(function(e){let t={type:"sendInitialState",camera:r.view.getCamera().toJson()};g&&!g(t)||c.emit("initialState",JSON.stringify({recepient:e,state:t}))})),c.on("lockSession",(function(e){g&&!g({user:e,type:"lockSession"})||(p=e,w=!0)})),c.on("unlockSession",(function(e){g&&!g({type:"unlockSession"})||(w=!1)})),c.on("disconnect",(()=>{p="",w=!1,q(),g&&g({type:"connectionLost"})})),c.on("disconnected",(function(e){e==p&&1==w&&(p="",w=!1),g&&g({user:e,type:"disconnected"})})),c.on("chatmessage",(function(e){let t=JSON.parse(e);t.type="chatmessage",g&&g(t)})),c.on("userlist",(async function(e){let t=JSON.parse(e);t.type="userlist";for(let e in x)x[e].delete=!0;for(let e=0;e<t.roomusers.length;e++){let i=t.roomusers[e].id;x[i]||(x[i]=t.roomusers[e],x[i].color=S[N++],N>=S.length&&(N=0)),x[i].delete=!1}for(let e in x)x[e].delete&&(u=!0,x[e].cameraWidget&&(x[e].cameraWidget.flush(),M.flush(x[e].label.nodeid)),delete x[e],u=!1);g&&g(t)}))}async function Ae(e){u=!0,await M.flushAll();for(let e in x){let t=x[e];t.cameraWidget&&(await t.cameraWidget.flush(),t.cameraWidget=null,t.label=null)}e&&d.deactivate(),u=!1}var Ee=t.$j,je=t.zP,Le=t.$,Be=t.CS,Ue=t.pw,qe=t.vy,Xe=t.Gi,Ge=t.uI,Ye=t.hy,Ke=t.lc,Qe=t.CD,Ze=t.wI,et=t.j2,tt=t.$T,it=t.dj,at=t.O5,st=t.IA,ot=t.XG,nt=t.Br,rt=t.Al,lt=t.Vt,dt=t.f4,ct=t.jX;export{Ee as connect,je as disconnect,Le as getActive,Be as getLocalUser,Ue as getLockedClient,qe as getLockedMaster,Xe as getRoomData,Ge as getShowCameraWidgets,Ye as getSuspendSend,Ke as getSyncCamera,Qe as getSyncSelection,Ze as handleResize,et as initialize,tt as lockSession,it as sendCustomMessage,at as setMessageReceivedCallback,st as setShowCameraWidgets,ot as setSuspendSend,nt as setSyncCamera,rt as setSyncSelection,lt as submitChat,dt as unlockSession,ct as updateRoomData};