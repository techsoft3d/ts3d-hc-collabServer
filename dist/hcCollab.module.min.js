var e={d:(t,a)=>{for(var i in a)e.o(a,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{$j:()=>ue,zP:()=>P,$:()=>S,CS:()=>x,pw:()=>V,vy:()=>_,uI:()=>N,hy:()=>z,lc:()=>M,j2:()=>me,$T:()=>F,dj:()=>W,O5:()=>j,IA:()=>k,XG:()=>I,Br:()=>v,Vt:()=>O,f4:()=>J});class a{constructor(e){this._manager=e,this._node=null}async update(e){if(!this._node){let e=new Communicator.MeshInstanceData(this._manager._frustumMesh),t=new Communicator.MeshInstanceData(this._manager._frustumMeshLines);this._node=this._manager._viewer.model.createNode(this._manager.node);let a=await this._manager._viewer.model.createMeshInstance(e,this._node);this._manager._viewer.model.setNodesOpacity([a],.05);let i=await this._manager._viewer.model.createMeshInstance(t,this._node);this._manager._viewer.model.setNodesLineColor([i],new Communicator.Color(0,0,255))}let t=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).normalize(),a=Communicator.Point3.subtract(e.getTarget(),e.getPosition()).length(),i=new Communicator.Matrix,o=e.getPosition(),n=new Communicator.Matrix;n.setTranslationComponent(o.x,o.y,o.z),i.setScaleComponent(e.getWidth(),e.getWidth(),a);let s=this.ComputeVectorToVectorRotationMatrix(new Communicator.Point3(0,0,1),t),r=s.transform(new Communicator.Point3(0,1,0)),l=this.ComputeVectorToVectorRotationMatrix(r,e.getUp()),c=Communicator.Matrix.multiply(s,l),d=Communicator.Matrix.multiply(c,i),m=Communicator.Matrix.multiply(d,n);this._manager._viewer.model.setNodeMatrix(this._node,m)}flush(){this._manager._viewer.model.deleteNode(this._node),this._node=null}ComputeVectorToVectorRotationMatrix(e,t){const a=1e-7;e.normalize(),t.normalize();let i=Communicator.Point3.cross(e,t),o=Communicator.Point3.dot(e,t),n=i.length();if(n>-1e-7&&n<a){if(!(o<0))return new Communicator.Matrix;if(e.x<-1e-7||e.x>a)i.x=e.y,i.y=-e.x,i.z=0;else if(e.y<-1e-7||e.y>a)i.x=-e.y,i.y=e.x,i.z=0;else{if(!(e.z<-1e-7||e.z>a))return new Communicator.Matrix;i.x=-e.z,i.z=e.x,i.y=0}}var s=Math.atan2(n,o);return s*=180/Math.PI,Communicator.Matrix.createFromOffAxisRotation(i,s)}}class i{constructor(e){this._viewer=e,this._node=e.model.createNode(),this._widgets=[],this._createFrustumMesh()}async _createFrustumMesh(e){let t=[0,0,0,-.5,-.5,1,.5,-.5,1,0,0,0,.5,-.5,1,.5,.5,1,0,0,0,-.5,.5,1,.5,.5,1,0,0,0,-.5,.5,1,-.5,-.5,1],a=[];for(let e=0;e<4;e++){let i=Communicator.Plane.createFromPoints(new Communicator.Point3(t[9*e],t[9*e+1],t[9*e+2]),new Communicator.Point3(t[9*e+3],t[9*e+4],t[9*e+5]),new Communicator.Point3(t[9*e+6],t[9*e+7],t[9*e+8]));for(let e=0;e<3;e++)a.push(-i.normal.x),a.push(-i.normal.y),a.push(-i.normal.z)}var i=new Communicator.MeshData;i.setFaceWinding(Communicator.FaceWinding.Unknown),i.addFaces(t,a),this._frustumMesh=await this._viewer.model.createMesh(i);let o=[[0,0,0,-.5,-.5,1,.5,-.5,1],[0,0,0,.5,-.5,1,.5,.5,1],[0,0,0,-.5,.5,1,.5,.5,1],[0,0,0,-.5,.5,1,-.5,-.5,1],[0,0,0,.5,.5,1]];var n=new Communicator.MeshData;for(let e=0;e<o.length;e++)n.addPolyline(o[e]);this._frustumMeshLines=await this._viewer.model.createMesh(n)}add(e){this._widgets.push(e),e.update(this._viewer.view.getCamera())}}var o,n,s,r,l=null,c=!1,d=!1,m=!1,u=!1,C="",f=null,w=null,b=[],g=!1,p=!0,y=!1,h=[];function v(e){p=e,e&&Ce()}function M(e){return p}function k(e){y=e,e||Ce()}function N(){return y}function S(){return!!l}function P(){l&&(l.disconnect(),l=null),m=!1,u=!1}function x(){if(l)return{id:l.id,name:o}}function _(){return m}function V(){return u}function F(){!l||m||u||l.emit("lockSession",""),m=!0}function J(){l&&m&&l.emit("unlockSession",""),m=!1}function O(e){l.emit("chatmessage",JSON.stringify({user:o,message:e}))}function I(e){c=e}function z(){return c}function W(e){l&&(e.type="custommessage",e.user=o,l.emit("hcmessage",JSON.stringify(e)))}function j(e){w=e}function D(e,t){l&&(t.type=e,t.user=o,t.userid=l.id,l.emit("hcmessage",JSON.stringify(t)))}function E(e){d||!l||c||u||D("camera",{camera:e.toJson()})}function L(e){if(l&&!c&&!d&&!u){let e=[],t=hwv.selectionManager.getResults();for(let a=0;a<t.length;a++)e.push(t[a].toJson());D("selection",{selection:e})}}async function T(e,t,a){return!l||c||d||u||D("visibility",{nodeids:e,onoff:t}),await n.model.setNodesVisibilityCollab(e,t,a)}async function A(e,t){!l||c||d||u||D("facecolor",{nodeids:e,color:t.toJson()}),await n.model.setNodesFaceColorCollab(e,t)}async function B(e){return!l||c||d||u||D("unsetfacecolor",{nodeids:e}),await n.model.unsetNodesFaceColorCollab(e)}async function R(e,t){return!l||c||d||u||D("opacity",{nodeids:e,opacity:t}),await n.model.setNodesOpacityCollab(e,t)}async function U(e){return!l||c||d||u||D("resetopacity",{nodeids:e}),await n.model.resetNodesOpacityCollab(e)}async function H(e,t,a){return!l||c||d||u||D("setInstanceModifier",{a:e,b:t,c:a}),await n.model.setInstanceModifierCollab(e,t,a)}async function q(){return!l||c||d||u||D("resetvisibilities",{}),await n.model.resetNodesVisibilityCollab()}async function G(e){return!l||c||d||u||D("setdrawmode",{drawmode:e}),await n.view.setDrawModeCollab(e)}async function X(e){return!l||c||d||u||D("setprojectionmode",{projectionmode:e}),await n.view.setProjectionModeCollab(e)}async function K(){return!l||c||d||u||D("reset",{}),await n.model.resetCollab()}async function Q(){return!l||c||d||u||D("clear",{}),await n.model.clearCollab()}async function Y(e,t){return!l||c||d||u||(t.toJson(),D("matrix",{nodeid:e,matrix:t.toJson()})),await n.model.setNodeMatrixCollab(e,t)}async function Z(e,t,a,i){return!l||c||d||u||D("isolate",{nodeids:e,duration:t,fitNodes:a,initiallyHidden:i}),await n.view.isolateNodesCollab(e,0,a,i)}async function ee(e,t){return!l||c||d||u||D("cadview",{nodeid:e,duration:t}),await n.model.activateCadViewCollab(e,0)}async function te(e){return!l||c||d||u||D("explodemagnitude",{magnitude:e}),await n.explodeManager.setMagnitudeCollab(e)}function ae(e){!l||c||d||u||D("markup",{id:e.getUniqueId(),info:n.markupManager.exportMarkup()})}function ie(){!l||c||d||u||D("markup",{id:n.markupManager.getActiveMarkupView().getUniqueId(),info:n.markupManager.exportMarkup()})}function oe(){!l||c||d||u||D("markup",{id:null,info:n.markupManager.exportMarkup()})}async function ne(e){!l||c||d||u||D("activatemarkupview",{id:e}),n.unsetCallbacks({camera:E}),await n.markupManager.activateMarkupViewWithPromiseCollab(e,0),n.setCallbacks({camera:E})}async function se(e,t){!l||c||d||u||D("cuttingsection",{id:e,active:!0,csinfo:t.toJson()}),await t.activateCollab()}async function re(e,t){!l||c||d||u||D("cuttingsection",{id:e,active:!1,csinfo:t.toJson()}),await t.deactivateCollab()}async function le(e,t,a,i,o,n,s){await t.updatePlaneCollab(a,i,o,n,s),!l||c||d||u||D("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function ce(e,t,a,i,o){await t.setPlaneCollab(a,i,o),!l||c||d||u||D("cuttingsection",{id:e,active:!0,csinfo:t.toJson()})}async function de(e,t,a){!l||c||d||u||D("loadsubtree",{a:e,b:t,c:a}),await n.model.loadSubtreeFromScsFileCollab(e,t,a)}function me(e,t,a){s=a,r=new i(e),n=e,f=t,e.setCallbacks({camera:E,selectionArray:L,viewCreated:ae,redlineCreated:ie,measurementCreated:oe}),e.view.setProjectionModeCollab=e.view.setProjectionMode,e.view.setProjectionMode=X,e.view.setDrawModeCollab=e.view.setDrawMode,e.view.setDrawMode=G,e.markupManager.activateMarkupViewWithPromiseCollab=e.markupManager.activateMarkupViewWithPromise,e.markupManager.activateMarkupViewWithPromise=ne,e.model.loadSubtreeFromScsFileCollab=e.model.loadSubtreeFromScsFile,e.model.loadSubtreeFromScsFile=de,e.model.setNodesVisibilityCollab=e.model.setNodesVisibility,e.model.setNodesVisibility=T,e.model.setNodesFaceColorCollab=e.model.setNodesFaceColor,e.model.setNodesFaceColor=A,e.model.unsetNodesFaceColorCollab=e.model.unsetNodesFaceColor,e.model.unsetNodesFaceColor=B,e.model.setNodesOpacityCollab=e.model.setNodesOpacity,e.model.setNodesOpacity=R,e.model.resetNodesOpacityCollab=e.model.resetNodesOpacity,e.model.resetNodesOpacity=U,e.model.setInstanceModifierCollab=e.model.setInstanceModifier,e.model.setInstanceModifier=H,e.explodeManager.setMagnitudeCollab=e.explodeManager.setMagnitude,e.explodeManager.setMagnitude=te,e.model.resetNodesVisibilityCollab=e.model.resetNodesVisibility,e.model.resetNodesVisibility=q,e.model.resetCollab=e.model.reset,e.model.reset=K,e.model.clearCollab=e.model.clear,e.model.clear=Q,e.model.setNodeMatrixCollab=e.model.setNodeMatrix,e.model.setNodeMatrix=Y,e.view.isolateNodesCollab=e.view.isolateNodes,e.view.isolateNodes=Z,e.model.activateCadViewCollab=e.model.activateCadView,e.model.activateCadView=ee;let o=e.cuttingManager.getCuttingSection(0),d=e.cuttingManager.getCuttingSection(1),m=e.cuttingManager.getCuttingSection(2);if(o&&(o.activateCollab=o.activate,o.activate=function(){se(0,this)},o.deactivateCollab=o.deactivate,o.deactivate=function(){re(0,this)},o.updatePlaneCollab=o.updatePlane,o.updatePlane=function(e,t,a,i,o){le(0,this,e,t,a,i,o)},o.setPlaneCollab=o.setPlane,o.setPlane=function(e,t,a){ce(0,this,e,t,a)}),d&&(d.activateCollab=d.activate,d.activate=function(){se(1,this)},d.deactivateCollab=d.deactivate,d.deactivate=function(){re(1,this)},d.updatePlaneCollab=d.updatePlane,d.updatePlane=function(e,t,a,i,o){le(1,this,e,t,a,i,o)},d.setPlaneCollab=d.setPlane,d.setPlane=function(e,t,a){ce(1,this,e,t,a)}),m&&(m.activateCollab=m.activate,m.activate=function(){se(2,this)},m.deactivateCollab=m.deactivate,m.deactivate=function(){re(2,this)},m.updatePlaneCollab=m.updatePlane,m.updatePlane=function(e,t,a,i,o){le(2,this,e,t,a,i,o)},m.setPlaneCollab=m.setPlane,m.setPlane=function(e,t,a){ce(2,this,e,t,a)}),f){var C=$("#ui-modelbrowser-minimizebutton");C&&C.on("click",(function(){!l||c||u||($(this).hasClass("minimized")?D("minimizebrowser",{}):D("maximizebrowser",{}))}))}}async function ue(e,t,i){o=t;let c={username:t,roomname:e,password:i};(l=await io(s)).emit("joinroom",JSON.stringify(c)),l.on("hcmessage",(async function(e){let t=JSON.parse(e);w&&!w(t)||"custommessage"===t.type||function(e){b.push(e);{let e=setInterval((async function(){if(b.length>0){if(!g){g=!0;let e=b.shift();await async function(e){switch(d=!0,e.type){case"camera":{let t=Communicator.Camera.fromJson(e.camera);if(y&&!p&&h[e.userid]){let i=h[e.userid];i.cameraWidget||(i.cameraWidget=new a(r)),await i.cameraWidget.update(t)}p&&await n.view.setCamera(t)}break;case"setprojectionmode":await n.view.setProjectionModeCollab(e.projectionmode);break;case"selection":{let t=e.selection;n.selectionManager.clear();let a=[];for(let e=0;e<t.length;e++){let i,o,n;t[e].faceEntity&&(i=Communicator.Selection.FaceEntity.fromJson(t[e].faceEntity)),t[e].lineEntity&&(o=Communicator.Selection.LineEntity.fromJson(t[e].lineEntity)),t[e].pointEntity&&(n=Communicator.Selection.PointEntity.fromJson(t[e].pointEntity));let s=new Communicator.Selection.SelectionItem.create(t[e].nodeId,null,i,o,n);a.push(s)}for(let e=0;e<a.length;e++)await n.selectionManager.add(a[e])}break;case"setdrawmode":await n.view.setDrawModeCollab(e.drawmode);break;case"activatemarkupview":n.unsetCallbacks({camera:E}),await n.markupManager.activateMarkupViewWithPromise(e.id,0),n.setCallbacks({camera:E});break;case"markup":n.unsetCallbacks({viewCreated:ae}),n.unsetCallbacks({redlineCreated:ae}),n.markupManager.deleteMarkupView(e.id),await n.markupManager.loadMarkupData(e.info),e.id&&n.markupManager.activateMarkupView(e.id),n.markupManager.refreshMarkup(),n.setCallbacks({viewCreated:ae}),n.setCallbacks({redlineCreated:ae});break;case"loadsubtree":n.unsetCallbacks({camera:E}),await hwv.model.loadSubtreeFromScsFileCollab(e.a,e.b,e.c),n.setCallbacks({camera:E});break;case"visibility":await n.model.setNodesVisibilityCollab(e.nodeids,e.onoff);break;case"opacity":await n.model.setNodesOpacityCollab(e.nodeids,e.opacity);break;case"facecolor":try{await n.model.setNodesFaceColorCollab(e.nodeids,Communicator.Color.fromJson(e.color))}catch(e){}break;case"unsetfacecolor":try{await n.model.unsetNodesFaceColorCollab(e.nodeids)}catch(e){}break;case"resetopacity":await n.model.resetNodesOpacityCollab(e.nodeids,e.opacity);break;case"setInstanceModifier":await n.model.setInstanceModifierCollab(e.a,e.b,e.c);break;case"explodemagnitude":await n.explodeManager.setMagnitudeCollab(e.magnitude);break;case"resetvisibilities":await n.model.resetNodesVisibilityCollab();break;case"reset":n.model.resetCollab();break;case"clear":n.unsetCallbacks({camera:E}),await n.model.clearCollab(),n.setCallbacks({camera:E});break;case"matrix":await n.model.setNodeMatrixCollab(e.nodeid,Communicator.Matrix.fromJson(e.matrix));break;case"isolate":await n.view.isolateNodesCollab(e.nodeids,0,null!=e.fitNodes?e.fitNodes:void 0,null!=e.initiallyHidden?e.initiallyHidden:void 0);break;case"cadview":await n.model.activateCadViewCollab(e.nodeid,0);break;case"cuttingsection":{let t=n.cuttingManager.getCuttingSection(e.id);e.active?await t.fromJson(e.csinfo):t.deactivateCollab()}break;case"minimizebrowser":await f._modelBrowser._minimizeModelBrowser();break;case"maximizebrowser":await f._modelBrowser._maximizeModelBrowser()}d=!1}(e),g=!1}}else clearInterval(e),e=null}),10)}}(t)})),l.on("initialState",(function(e){let t=JSON.parse(e);if(t.type="initialState",(!w||w(t))&&t.camera){let e=Communicator.Camera.fromJson(t.camera);n.view.setCamera(e)}})),l.on("sendInitialState",(function(e){let t={type:"sendInitialState",camera:n.view.getCamera().toJson()};w&&!w(t)||l.emit("initialState",JSON.stringify({recepient:e,state:t}))})),l.on("lockSession",(function(e){w&&!w({user:e,type:"lockSession"})||(C=e,u=!0)})),l.on("unlockSession",(function(e){w&&!w({type:"unlockSession"})||(u=!1)})),l.on("disconnect",(()=>{C="",u=!1,P(),w&&w({type:"connectionLost"})})),l.on("disconnected",(function(e){e==C&&1==u&&(C="",u=!1),w&&w({user:e,type:"disconnected"})})),l.on("chatmessage",(function(e){let t=JSON.parse(e);t.type="chatmessage",w&&w(t)})),l.on("userlist",(async function(e){let t=JSON.parse(e);t.type="userlist";for(let e in h)h[e].delete=!0;for(let e=0;e<t.roomusers.length;e++){let a=t.roomusers[e].id;h[a]||(h[a]=t.roomusers[e]),h[a].delete=!1}for(let e in h)h[e].delete&&(d=!0,h[e].cameraWidget&&h[e].cameraWidget.flush(),delete h[e],d=!1);w&&w(t)}))}function Ce(){d=!0;for(let e in h){let t=h[e];t.cameraWidget&&(t.cameraWidget.flush(),t.cameraWidget=null)}d=!1}var fe=t.$j,we=t.zP,be=t.$,ge=t.CS,pe=t.pw,ye=t.vy,he=t.uI,ve=t.hy,Me=t.lc,ke=t.j2,Ne=t.$T,Se=t.dj,Pe=t.O5,xe=t.IA,_e=t.XG,Ve=t.Br,Fe=t.Vt,Je=t.f4;export{fe as connect,we as disconnect,be as getActive,ge as getLocalUser,pe as getLockedClient,ye as getLockedMaster,he as getShowCameraWidgets,ve as getSuspendSend,Me as getSyncCamera,ke as initialize,Ne as lockSession,Se as sendCustomMessage,Pe as setMessageReceivedCallback,xe as setShowCameraWidgets,_e as setSuspendSend,Ve as setSyncCamera,Fe as submitChat,Je as unlockSession};